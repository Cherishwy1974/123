<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>02_2.2_æ— ç©·å°ä¸æ— ç©·å¤§</title>

    <!-- æœ¬åœ°æ€æºå®‹ä½“å­—ä½“æ–‡ä»¶ -->
    <link rel="stylesheet" href="./noto-serif-sc.css">

    <!-- ä¿®å¤ï¼šå°†D3.jsåº“çš„å¼•ç”¨æ”¾åœ¨æœ€å‰é¢ï¼Œç¡®ä¿ä¼˜å…ˆåŠ è½½ -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            /* ä½¿ç”¨æœ¬åœ°æ€æºå®‹ä½“ï¼Œæä¾›ä¼˜é›…çš„ä¸­æ–‡æ˜¾ç¤ºæ•ˆæœ */
            font-family: 'Noto Serif SC', 'Source Han Serif SC', 'Source Han Serif CN',
                         'Songti SC', 'SimSun', 'å®‹ä½“', serif;
            background: #1a1a2e;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        .blackboard {
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            position: relative;
            border: 10px solid #795548;
            margin: 0;
        }

        /* è™šæ‹Ÿäººæ˜¾ç¤ºåŒºåŸŸ - ç¨å¾®ä¸‹ç§»ï¼Œé¿å…é®æŒ¡å†…å®¹ */
        .avatar-container {
            position: fixed;
            top: 60%; left: 50%;
            transform: translate(-50%, -50%);
            width: 750px; height: 850px;
            overflow: hidden; z-index: 50;
            pointer-events: none; background: transparent;
            border: none; box-shadow: none;
        }
        .wrapper {
            width: 100%; height: 100%;
            background: transparent; pointer-events: auto;
        }

        /* æ•™å­¦å†…å®¹åŒºåŸŸ - é¿è®©è™šæ‹Ÿäººï¼Œå·¦å³åˆ†å¸ƒ */
        .content-area {
            position: absolute;
            top: 20px; left: 50px; right: 50px; bottom: 120px;
            z-index: 10; overflow: hidden;
        }
        .page {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0; visibility: hidden;
            transition: all 0.7s ease-in-out;
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 3fr; /* è°ƒæ•´æ¯”ä¾‹ï¼Œç»™å›¾æ›´å¤§ç©ºé—´ */
            gap: 20px;
            align-items: center;
        }
        .page.active {
            opacity: 1; visibility: visible;
        }
        .chalk-text {
            color: #ffffff;
            font-family: 'Noto Serif SC', 'Source Han Serif SC', 'Source Han Serif CN',
                         'Songti SC', 'SimSun', 'å®‹ä½“', serif;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .page-title {
            font-size: 24px; font-weight: bold;
            color: #e1bee7; margin-bottom: 1.5rem;
        }
        .text-medium {
            font-size: 16px; margin-bottom: 0.8rem;
            line-height: 1.7; color: #f3e5f5; font-weight: 500;
        }
        .emphasis {
            color: #FF6B6B; font-size: 18px;
        }
        .text-medium p {
            margin-bottom: 1rem;
        }
        .text-medium strong {
            color: #81c784;
            font-weight: 600;
        }
        .graph-container {
            background: transparent;
            border: none;
            padding: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        /* å­—å¹•åŒºåŸŸ - å…¨å®½æ˜¾ç¤ºï¼Œè™šæ‹Ÿäººä¸å½±å“å¸ƒå±€ */
        .subtitle-area {
            position: absolute;
            bottom: 20px; left: 50px; right: 50px;
            height: 50px; background: rgba(0,0,0,0.8);
            border-radius: 8px; display: flex;
            align-items: center; justify-content: center;
            z-index: 60; color: white;
            font-size: 0.9rem; text-align: center;
            padding: 0 20px; line-height: 1.4;
        }

        /* å·¦ä¾§æ§åˆ¶æ  */
        .control-bar {
            position: fixed; left: -220px; top: 50%;
            transform: translateY(-50%); width: 250px;
            background: rgba(30,30,30,0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 10px; z-index: 200;
            border-radius: 0 15px 15px 0;
            padding: 20px 15px; transition: left 0.3s ease;
        }
        .control-bar:hover { left: 0; }
        .control-bar::before {
            content: 'â–¶ï¸'; position: absolute;
            top: 50%; right: -25px;
            transform: translateY(-50%);
            background: rgba(30,30,30,0.95);
            padding: 10px 5px; border-radius: 0 10px 10px 0;
            font-size: 0.8rem; writing-mode: vertical-lr;
        }
        .btn {
            padding: 12px 20px; background: linear-gradient(135deg, #4a4a4a, #666);
            color: white; border: none; border-radius: 8px;
            cursor: pointer; font-size: 13px; font-weight: bold;
            transition: all 0.3s ease; width: 100%; text-align: center;
        }
        .btn:hover { background: linear-gradient(135deg, #555, #777); transform: translateY(-2px); }
        .btn.primary { background: linear-gradient(135deg, #FF69B4, #FF1493); }

        /* D3 SVG Styles */
        .viz-panel .axis path,
        .viz-panel .axis line {
            stroke: #ffffff;
            stroke-width: 1.5;
        }
        .viz-panel .axis text {
            fill: #ffffff;
            font-size: 18px; /* å¢å¤§åæ ‡è½´å­—ä½“ */
        }
        .viz-panel .label {
            fill: #ffffff;
            font-size: 22px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
            font-weight: 500;
        }

        /* ç»Ÿä¸€å°†å›¾ä¸­å…ƒç´ æ”¹ä¸ºç™½è‰²ï¼ˆä»…ä½œç”¨äºå›¾å½¢åŒºåŸŸï¼‰ */
        .graph-container svg .axis path,
        .graph-container svg .axis line {
            stroke: #ffffff !important;
        }
        .graph-container svg .axis text,
        .graph-container svg .label,
        .graph-container svg text {
            fill: #ffffff !important;
        }
        .graph-container svg path,
        .graph-container svg line {
            stroke: #ffffff !important;
        }
        .graph-container svg circle {
            stroke: #ffffff !important;
            stroke-width: 1.5px;
        }
        .graph-container svg rect {
            stroke: #ffffff !important;
            fill: none !important;
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ - é»˜è®¤éšè— */
        .status-indicator {
            position: absolute;
            top: 10px; right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            color: white; border-radius: 5px;
            font-size: 12px; z-index: 100;
            transition: opacity 0.3s ease;
            display: none; /* é»˜è®¤éšè—çº¢è‰²æç¤º */
        }
        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); }
        .status-indicator.recording {
            background: rgba(244, 67, 54, 0.8);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); }

        /* å½•åˆ¶æ¨¡å¼ä¸‹éšè—çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .recording-mode .status-indicator {
            opacity: 0; pointer-events: none;
        }
        /* å½•åˆ¶æ¨¡å¼ä¸‹éšè—æ§åˆ¶æ  */
        .recording-mode .control-bar {
            left: -300px; transition: left 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="blackboard">
        <div id="statusIndicator" class="status-indicator">ç­‰å¾…è¿æ¥</div>

        <!-- è™šæ‹Ÿäººæ˜¾ç¤ºåŒºåŸŸ - æŒ‰ç…§å®˜æ–¹SDKè¦æ±‚ -->
        <div class="avatar-container">
            <div class="wrapper" id="avatarWrapper"></div>
        </div>

        <div class="content-area" id="contentArea">
            <!-- Pages will be dynamically generated here -->
        </div>

        <div class="subtitle-area" id="subtitleArea">
            æ¬¢è¿å­¦ä¹ "æ— ç©·å°ä¸æ— ç©·å¤§"ï¼ç‚¹å‡»"å¼€å§‹è®²è¯¾"å¯åŠ¨è™šæ‹Ÿäººè®²å¸ˆã€‚
        </div>

        <div class="control-bar">
            <div style="color: white; margin-bottom: 1rem; text-align: center; font-size: 12px;">
                ç¬¬ <span id="currentPage">1</span> é¡µ / å…± <span id="totalPages">10</span> é¡µ
                <br>
                <span style="color: #81c784; font-size: 11px;">â±ï¸ æœ¬é¡µæ—¶é•¿: <span id="currentPageDuration">18</span>ç§’</span>
            </div>
            <button class="btn" onclick="previousPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
            <button class="btn primary" onclick="startTeaching()" id="startBtn">ğŸ€ å¼€å§‹è®²è¯¾</button>
            <button class="btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â¡ï¸</button>
            <button class="btn" onclick="restart()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="btn" onclick="startAutoPlay()" id="autoPlayBtn" style="background: linear-gradient(135deg, #2196f3, #1976d2);">ğŸ¬ è‡ªåŠ¨æ’­æ”¾</button>
            <div style="color: #ffab40; margin-top: 0.5rem; text-align: center; font-size: 10px; line-height: 1.2;">
                ğŸ’¡ å½•åˆ¶æç¤ºï¼š<br>
                ç‚¹å‡»è‡ªåŠ¨æ’­æ”¾åç«‹å³å¼€å§‹å½•å±<br>
                ç³»ç»Ÿä¼šè‡ªåŠ¨å®Œæˆå…¨éƒ¨æ¼”ç¤º
            </div>
            <div style="color: #ccc; margin-top: 1rem; text-align: center; font-size: 11px;">
                ğŸ’¡ å¿«æ·é”®ï¼šEnteræ’­æ”¾
            </div>
        </div>
    </div>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <script src="./polyfill.min.js"></script>
    <script id="MathJax-script" src="./mathjax-tex-mml-chtml.js"></script>

    <!-- JavaScriptä»£ç  -->
    <script type="module">
        try {
            const { default: AvatarPlatform, SDKEvents, PlayerEvents, RecorderEvents, UserMedia } = await import('./avatar-sdk-web_3.1.2.1002/index.js');
            window.AvatarPlatform = AvatarPlatform;
            window.SDKEvents = SDKEvents;
            window.PlayerEvents = PlayerEvents;
            window.RecorderEvents = RecorderEvents;
            window.UserMedia = UserMedia;
            console.log('âœ… è®¯é£æœ¬åœ°SDKå·²åŠ è½½');

            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥SDKå·²å‡†å¤‡å°±ç»ª
            window.dispatchEvent(new CustomEvent('sdkReady'));
        } catch (error) {
            console.error('âŒ æœ¬åœ°SDKåŠ è½½å¤±è´¥:', error);
        }
    </script>

    <script>
        let avatarPlatform = null;
        let isConnected = false;
        let isTeaching = false;
        let currentPage = 1;
        const totalPages = 11;
        let animationFrameId; // To control animation loops

        // åˆå¹¶åçš„æ•™å­¦å†…å®¹ï¼šæ— ç©·å°ï¼ˆç¬¬1-5é¡µï¼‰+ æ— ç©·å¤§ï¼ˆç¬¬6-10é¡µï¼‰
        const boardContent = [
            // === ç¬¬ä¸€éƒ¨åˆ†ï¼šæ— ç©·å°ï¼ˆåŸç¬¬2-6é¡µï¼‰ ===
            { title: "æ— ç©·å°ï¼šè¿‡ç¨‹ä¸ç»“æœ", text: "<p>è®¾å®šä¸€ä¸ªç›¸åŒçš„<strong>ã€è¿‡ç¨‹ã€</strong>ï¼š$x \\to 0$</p><p>å‡½æ•° $f(x)=x+5$ çš„<strong>ã€ç»“æœã€</strong>æ˜¯ $\\to 5$</p><p>å‡½æ•° $g(x)=x^2$ çš„<strong>ã€ç»“æœã€</strong>æ˜¯ $\\to 0$</p><p><strong>è¿‡ç¨‹ç›¸åŒï¼Œä¸åŒçš„å‡½æ•°ï¼Œç»“æœä¸åŒã€‚</strong></p>" },
            { title: "æ— ç©·å°çš„\"èµ„æ ¼è®¤è¯\"", text: "<p>åªæœ‰åƒ $g(x)=x^2$ è¿™æ ·ï¼Œå…¶æœ€ç»ˆ<strong>ã€ç»“æœã€ä¸º 0</strong> çš„å‡½æ•°ï¼Œæ‰æœ‰èµ„æ ¼åœ¨å½“å‰è¿™ä¸ª<strong>ã€è¿‡ç¨‹ã€</strong>ä¸­ï¼Œè¢«ç§°ä¸º<strong>ã€æ— ç©·å°ã€</strong>ã€‚</p>" },
            { title: "è¿‡ç¨‹ä¸åŒï¼Œç»“æœä¹Ÿä¸åŒ", text: "<p>å¯¹äºåŒä¸€ä¸ªå‡½æ•° $y = 1/x$ï¼š</p><p>å½“<strong>ã€è¿‡ç¨‹ã€</strong>æ˜¯ $x \\to \\infty$ æ—¶ï¼Œ<strong>ã€ç»“æœã€</strong>æ˜¯ 0 (æ˜¯æ— ç©·å°)ã€‚</p><p>å½“<strong>ã€è¿‡ç¨‹ã€</strong>æ˜¯ $x \\to 0$ æ—¶ï¼Œ<strong>ã€ç»“æœã€</strong>æ˜¯ $\\infty$ (ä¸æ˜¯æ— ç©·å°)ã€‚</p>" },
            { title: "ä¸€ä¸ªå…³é”®çš„å¯ç¤º", text: "<p>åŒä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ä¸åŒçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥äº§ç”Ÿæˆªç„¶ä¸åŒçš„ç»“æœï¼Œä»è€Œæ‹¥æœ‰ä¸åŒçš„èº«ä»½ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ç¬¼ç»Ÿåœ°é—®ï¼š\"ä¸€ä¸ªå‡½æ•°æ˜¯ä¸æ˜¯æ— ç©·å°ï¼Ÿ\"</p><p><strong>è¿™ä¸ªé—®é¢˜æœ¬èº«é—®å¾—ä¸å®Œæ•´ã€‚</strong></p>" },
            { title: "æ— ç©·å°çš„ç»“è®º", text: "<p>ç†è§£æ— ç©·å°ï¼Œå°±è¦ç‰¢ç‰¢æŠ“ä½<strong>ã€è¿‡ç¨‹ã€</strong>å’Œ<strong>ã€ç»“æœã€</strong>ã€‚</p><p>å¿…é¡»å…ˆæœ‰ä¸€ä¸ªæ˜ç¡®çš„<strong>ã€è¿‡ç¨‹ã€</strong>ï¼Œå‡½æ•°æ‰ä¼šæœ‰å¯¹åº”çš„<strong>ã€ç»“æœã€</strong>ã€‚</p><p>å½“ä¸”ä»…å½“è¿™ä¸ª<strong>ã€ç»“æœã€æ˜¯ 0</strong> æ—¶ï¼Œæˆ‘ä»¬æ‰ç§°è¯¥å‡½æ•°åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯<strong>ã€æ— ç©·å°ã€</strong>ã€‚</p>" },

            // === ç¬¬äºŒéƒ¨åˆ†ï¼šæ— ç©·å¤§ï¼ˆåŸç¬¬2-6é¡µï¼‰ ===
            { title: "æ— ç©·å¤§ï¼šä¸æ— ç©·å°ç›¸å¯¹", text: "<p>ä¸æ— ç©·å°ç›¸å¯¹ï¼Œæ— ç©·å¤§æè¿°çš„æ˜¯å‡½æ•°å€¼<strong>æ— é™å¢å¤§</strong>çš„è¶‹åŠ¿ã€‚</p><p>åŒæ ·ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°ï¼Œè€Œæ˜¯ä¸€ç§ç”±<strong>è¿‡ç¨‹</strong>å†³å®šçš„è¡Œä¸ºã€‚</p>" },
            { title: "æ— ç©·å¤§ä¸æ— ç©·å°çš„å…³ç³»", text: "<p>åœ¨<strong>åŒä¸€ä¸ªè¿‡ç¨‹</strong>ä¸­ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•° $f(x)$ æ˜¯æ— ç©·å°ï¼ˆä¸”ä¸ä¸º0ï¼‰ï¼Œé‚£ä¹ˆå®ƒçš„å€’æ•° $\\frac{1}{f(x)}$ å°±æ˜¯æ— ç©·å¤§ã€‚</p><p>åä¹‹äº¦ç„¶ã€‚</p><p><strong>å®ƒä»¬äº’ä¸ºå€’æ•°ï¼Œæ˜¯åŒä¸€æšç¡¬å¸çš„ä¸¤é¢ã€‚</strong></p>" },
            { title: "æ¡ˆä¾‹ç ”ç©¶ (ä¸€): $f(x) = x$", text: "<p>æˆ‘ä»¬æ¥æ£€éªŒè¿™ä¸ªæœ€ç®€å•çš„å‡½æ•°ï¼š</p><p>å½“è¿‡ç¨‹æ˜¯ $x \\to 0$ æ—¶ï¼Œå®ƒçš„ç»“æœæ˜¯ 0ï¼Œæ˜¯<strong>æ— ç©·å°</strong>ã€‚</p><p>å½“è¿‡ç¨‹æ˜¯ $x \\to \\infty$ æ—¶ï¼Œå®ƒçš„ç»“æœæ˜¯ $\\infty$ï¼Œæ˜¯<strong>æ— ç©·å¤§</strong>ã€‚</p>" },
            { title: "æ¡ˆä¾‹ç ”ç©¶ (äºŒ): $f(x) = 1/x$", text: "<p>ç°åœ¨æ¥çœ‹å®ƒçš„å€’æ•°ï¼š</p><p>å½“è¿‡ç¨‹æ˜¯ $x \\to 0$ æ—¶ï¼Œå®ƒçš„ç»“æœæ˜¯ $\\infty$ï¼Œæ˜¯<strong>æ— ç©·å¤§</strong>ã€‚</p><p>å½“è¿‡ç¨‹æ˜¯ $x \\to \\infty$ æ—¶ï¼Œå®ƒçš„ç»“æœæ˜¯ 0ï¼Œæ˜¯<strong>æ— ç©·å°</strong>ã€‚</p><p><strong>å®Œç¾å°è¯äº†å€’æ•°å…³ç³»ï¼</strong></p>" },
            { title: "æœ€ç»ˆç»“è®º", text: "<p>æ— ç©·å°ä¸æ— ç©·å¤§æ˜¯ç›¸å¯¹çš„æ¦‚å¿µï¼Œç”±<strong>è¿‡ç¨‹</strong>å†³å®šã€‚</p><p>åœ¨åŒä¸€ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬é€šè¿‡<strong>å€’æ•°å…³ç³»</strong>ç´§å¯†è”ç³»ã€‚</p><p>ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±æŒæ¡äº†å‡½æ•°æé™è¡Œä¸ºçš„æ ¸å¿ƒã€‚</p>" }
        ];

        // åˆå¹¶åçš„å­—å¹•è„šæœ¬
        const subtitleScript = {
            // æ— ç©·å°éƒ¨åˆ†ï¼ˆç¬¬1-5é¡µï¼‰
            1: "æˆ‘ä»¬è®¾å®šä¸€ä¸ªå®Œå…¨ç›¸åŒçš„ã€è¿‡ç¨‹ã€ï¼šè®© x æ— é™åœ°é è¿‘ 0ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿä¸¤ä¸ªå‡½æ•°æˆªç„¶ä¸åŒçš„ã€ç»“æœã€ï¼šå‡½æ•° f(x) = x+5 çš„ç»“æœæ˜¯æ— é™åœ°é è¿‘ 5ï¼›è€Œå‡½æ•° g(x) = xÂ² çš„ç»“æœæ˜¯æ— é™åœ°é è¿‘ 0ã€‚è¿™ä¸ªå¯¹æ¯”å‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªåŸºæœ¬äº‹å®ï¼šè¿‡ç¨‹è™½ç„¶ç›¸åŒï¼Œä½†ä¸åŒçš„å‡½æ•°ï¼Œä¼šäº§ç”Ÿä¸åŒçš„ç»“æœã€‚",
            2: "åŸºäºè¿™ä¸ªäº‹å®ï¼Œæ•°å­¦å®¶ä»¬åšäº†ä¸€ä¸ªå®šä¹‰ï¼šåªæœ‰åƒ g(x) = xÂ² è¿™æ ·ï¼Œå…¶æœ€ç»ˆã€ç»“æœã€ä¸º 0 çš„å‡½æ•°ï¼Œæ‰æœ‰èµ„æ ¼åœ¨å½“å‰è¿™ä¸ªã€è¿‡ç¨‹ã€ä¸­ï¼Œè¢«ç§°ä¸ºã€æ— ç©·å°ã€ã€‚æ‰€ä»¥ï¼Œæ˜¯ä¸æ˜¯æ— ç©·å°ï¼Œå…³é”®å°±çœ‹å®ƒçš„ç»“æœæ˜¯ä¸æ˜¯ 0ã€‚",
            3: "é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æ”¹å˜ã€è¿‡ç¨‹ã€ï¼Œåˆä¼šæ€æ ·å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹åŒä¸€ä¸ªå‡½æ•° y = 1æ¯”xã€‚å½“ã€è¿‡ç¨‹ã€æ˜¯ x è¶‹å‘æ— ç©·å¤§æ—¶ï¼Œå®ƒçš„ã€ç»“æœã€æ˜¯ 0ï¼Œå› æ­¤å®ƒè·å¾—äº†æ— ç©·å°çš„èµ„æ ¼ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬æŠŠã€è¿‡ç¨‹ã€æ¢æˆ x è¶‹å‘ 0 æ—¶ï¼Œå®ƒçš„ã€ç»“æœã€å´å˜æˆäº†æ— ç©·å¤§ï¼Œå®ƒå°±å¤±å»äº†è¿™ä¸ªèµ„æ ¼ã€‚",
            4: "è¿™ä¸ªä¾‹å­æ­ç¤ºäº†æœ€æ·±åˆ»çš„ä¸€ç‚¹ï¼šåŒä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ä¸åŒçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥äº§ç”Ÿæˆªç„¶ä¸åŒçš„ç»“æœï¼Œä»è€Œæ‹¥æœ‰ä¸åŒçš„èº«ä»½ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç¬¼ç»Ÿåœ°é—®'ä¸€ä¸ªå‡½æ•°æ˜¯ä¸æ˜¯æ— ç©·å°'ï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜æœ¬èº«é—®å¾—ä¸å®Œæ•´ã€‚",
            5: "æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„ç»“è®ºéå¸¸ç›´æ¥ï¼šç†è§£æ— ç©·å°ï¼Œå°±è¦ç‰¢ç‰¢æŠ“ä½ã€è¿‡ç¨‹ã€å’Œã€ç»“æœã€è¿™ä¸¤ä¸ªè¯ã€‚å¿…é¡»å…ˆæœ‰ä¸€ä¸ªæ˜ç¡®çš„ã€è¿‡ç¨‹ã€ï¼Œå‡½æ•°æ‰ä¼šæœ‰å¯¹åº”çš„ã€ç»“æœã€ã€‚å½“ä¸”ä»…å½“è¿™ä¸ªã€ç»“æœã€æ˜¯0æ—¶ï¼Œæˆ‘ä»¬æ‰ç§°è¯¥å‡½æ•°åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯ã€æ— ç©·å°ã€ã€‚",

            // æ— ç©·å¤§éƒ¨åˆ†ï¼ˆç¬¬6-10é¡µï¼‰
            6: "ç°åœ¨æˆ‘ä»¬æ¥å­¦ä¹ æ— ç©·å°çš„\"å¦ä¸€åŠ\"â€”â€”æ— ç©·å¤§ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒæè¿°çš„ä¹Ÿæ˜¯ä¸€ç§è¶‹åŠ¿ï¼Œä½†æ–¹å‘ç›¸åï¼Œæ˜¯å‡½æ•°å€¼çš„ç»å¯¹å€¼æ— é™å¢å¤§çš„è¡Œä¸ºã€‚",
            7: "é‚£ä¹ˆï¼Œæ— ç©·å¤§å’Œæ— ç©·å°ä¹‹é—´æœ‰ä»€ä¹ˆç²¾ç¡®çš„å…³ç³»å‘¢ï¼Ÿéå¸¸ç®€å•ï¼šåœ¨åŒä¸€ä¸ªå˜åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªä¸ä¸º0çš„å‡½æ•°æ˜¯æ— ç©·å°ï¼Œé‚£ä¹ˆå®ƒçš„å€’æ•°å°±ä¸€å®šæ˜¯æ— ç©·å¤§ã€‚åè¿‡æ¥ä¹Ÿå®Œå…¨æˆç«‹ã€‚å®ƒä»¬å°±åƒä¸€æšç¡¬å¸çš„ä¸¤é¢ï¼Œå¯†ä¸å¯åˆ†ã€‚",
            8: "æˆ‘ä»¬ç”¨æœ€ç®€å•çš„å‡½æ•° f(x) = x æ¥éªŒè¯ä¸€ä¸‹ã€‚å½“è¿‡ç¨‹æ˜¯ x è¶‹å‘äº0æ—¶ï¼Œå®ƒçš„ç»“æœä¹Ÿæ˜¯0ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªæ— ç©·å°ã€‚è€Œå½“è¿‡ç¨‹æ˜¯ x è¶‹å‘äºæ— ç©·å¤§æ—¶ï¼Œå®ƒçš„ç»“æœä¹Ÿè¶‹å‘æ— ç©·å¤§ï¼Œæ‰€ä»¥å®ƒåˆæ˜¯ä¸€ä¸ªæ— ç©·å¤§ã€‚",
            9: "ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å€’æ•°ï¼Œf(x) = 1æ¯”xã€‚å¥‡å¦™çš„äº‹æƒ…å‘ç”Ÿäº†ï¼šåœ¨ x è¶‹å‘äº0çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„ç»“æœæ˜¯æ— ç©·å¤§ï¼›è€Œåœ¨ x è¶‹å‘äºæ— ç©·å¤§çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„ç»“æœæ˜¯0ï¼Œæ˜¯ä¸€ä¸ªæ— ç©·å°ã€‚è¿™å®Œç¾åœ°å°è¯äº†æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„å€’æ•°å…³ç³»ã€‚",
            10: "æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ç»“è®ºæ˜¯ï¼šæ— ç©·å°ä¸æ— ç©·å¤§æ˜¯ä¸€å¯¹ç›¸å¯¹çš„æ¦‚å¿µï¼Œå®ƒä»¬çš„èº«ä»½å®Œå…¨ç”±ã€è¿‡ç¨‹ã€å†³å®šã€‚è€Œåœ¨åŒä¸€ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬é€šè¿‡ç®€å•çš„ã€å€’æ•°å…³ç³»ã€ç´§å¯†åœ°è”ç³»åœ¨ä¸€èµ·ã€‚ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œä½ å°±æŒæ¡äº†å‡½æ•°æé™è¡Œä¸ºçš„æ ¸å¿ƒã€‚"
        };


        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'normal') {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.className = 'status-indicator';
                if (type === 'connected') {
                    indicator.classList.add('connected');
                } else if (type === 'error') {
                    indicator.classList.add('error');
                } else if (type === 'connecting') {
                    indicator.classList.add('connecting');
                } else if (type === 'recording') {
                    indicator.classList.add('recording');
                } else if (type === 'success') {
                    indicator.classList.add('connected');
                }
            }
        }

        // æ£€æµ‹SDKåŠ è½½çŠ¶æ€
        function checkSDKStatus() {
            if (typeof window.AvatarPlatform !== 'undefined') {
                console.log('âœ… è®¯é£å®˜æ–¹SDKå·²åŠ è½½ - ç‰ˆæœ¬:', window.AvatarPlatform.getVersion ? window.AvatarPlatform.getVersion() : 'æœªçŸ¥');
                updateStatus('SDKå·²åŠ è½½', 'connected');
                return true;
            } else {
                console.log('â³ è®¯é£SDKæ¨¡å—æ­£åœ¨åŠ è½½ä¸­...');
                updateStatus('SDKåŠ è½½ä¸­...', 'connecting');
                return false;
            }
        }

        // ç›‘å¬SDKå‡†å¤‡å°±ç»ªäº‹ä»¶
        window.addEventListener('sdkReady', function() {
            console.log('ğŸ‰ SDKæ¨¡å—åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ªï¼');
            checkSDKStatus();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const contentArea = document.getElementById('contentArea');
            // å…ˆåˆ›å»ºå°é¢é¡µ
            const coverPage = document.createElement('div');
            coverPage.className = 'page active';
            coverPage.dataset.page = '1';
            coverPage.innerHTML = `
                <div style="display: flex; width: 100%; height: 100%; align-items: center; justify-content: center;">
                    <div style="flex: 1; text-align: center; padding: 2rem;">
                        <h1 style="font-size: 2.2rem; font-weight: bold; color: #f1c40f; text-shadow: 0 0 8px rgba(241, 196, 15, 0.5); margin-bottom: 1rem;">
                            æ— ç©·å°ä¸æ— ç©·å¤§
                        </h1>
                        <p style="font-size: 1.1rem; color: #9ca3af; margin-bottom: 1.5rem;">
                            ç¬¬2ç«  è§†é¢‘ 2.2
                        </p>
                        <div style="display: inline-block; text-align: left; margin-top: 1.5rem;">
                            <p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">âœ“ æ— ç©·å°çš„å®šä¹‰ä¸æ€§è´¨</p>
                            <p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">âœ“ æ— ç©·å¤§çš„å®šä¹‰ä¸æ€§è´¨</p>
                            <p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">âœ“ æ— ç©·å°ä¸æ— ç©·å¤§çš„å…³ç³»</p>
                            <p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">âœ“ è¿‡ç¨‹ä¸ç»“æœçš„ç†è§£</p>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <svg style="width: 100%; max-width: 500px; height: 400px;" viewBox="0 0 600 500">
                            <defs>
                                <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#2ecc71;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <text x="200" y="140" font-size="50" fill="url(#grad2)" text-anchor="middle" font-family="serif">
                                Î±
                                <animate attributeName="opacity" values="0;1;1;0.7" dur="3s" repeatCount="indefinite"/>
                            </text>
                            <text x="400" y="140" font-size="50" fill="#e74c3c" text-anchor="middle" font-family="serif">
                                âˆ
                                <animate attributeName="opacity" values="0.7;1;1;0" dur="3s" begin="1.5s" repeatCount="indefinite"/>
                            </text>
                            <circle cx="200" cy="300" r="35" fill="none" stroke="#3498db" stroke-width="3">
                                <animate attributeName="r" values="35;50;35" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="400" cy="300" r="35" fill="none" stroke="#e74c3c" stroke-width="3">
                                <animate attributeName="r" values="35;50;35" dur="2s" begin="1s" repeatCount="indefinite"/>
                            </circle>
                            <text x="300" y="380" font-size="24" fill="#ecf0f1" text-anchor="middle">è¿‡ç¨‹ â†’ ç»“æœ</text>
                        </svg>
                    </div>
                </div>
            `;
            contentArea.appendChild(coverPage);
            
            // å†åˆ›å»ºå†…å®¹é¡µ
            boardContent.forEach((content, i) => {
                const page = document.createElement('div');
                page.className = 'page';
                page.dataset.page = i + 2;
                page.innerHTML = `
                    <div class="chalk-text">
                        <div class="page-title">${content.title}</div>
                        <div class="text-medium">${content.text}</div>
                    </div>
                    <div class="graph-container">
                        <svg id="viz-${i+2}" width="100%" height="100%"></svg>
                    </div>
                `;
                contentArea.appendChild(page);
            });
            switchToPage(1, false);
            console.log('âœ¨ æ— ç©·å°ä¸æ— ç©·å¤§æ•™å­¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            checkSDKStatus();
        });

        function switchToPage(pageNum, shouldSpeak = true) {
            if (pageNum < 1 || pageNum > totalPages) return;
            currentPage = pageNum;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-page="${pageNum}"]`).classList.add('active');
            updatePageInfo();

            setTimeout(() => {
                drawPageGraph(pageNum);
                if(window.MathJax && window.MathJax.typeset) {
                    window.MathJax.typeset();
                }
            }, 50);

            if (shouldSpeak && !isAutoPlaying) {
                speakContent(pageNum);
            }
        }

        // é™é»˜é¡µé¢åˆ‡æ¢ - ä¸æ’­æ”¾è¯­éŸ³ï¼Œä¸“ç”¨äºè‡ªåŠ¨æ’­æ”¾
        function switchToPageSilent(pageNum) {
            if (pageNum < 1 || pageNum > totalPages) {
                console.log(`âŒ é¡µé¢åˆ‡æ¢å¤±è´¥ï¼šé¡µç ${pageNum}è¶…å‡ºèŒƒå›´(1-${totalPages})`);
                return;
            }

            console.log(`ğŸ”„ å¼€å§‹åˆ‡æ¢åˆ°ç¬¬${pageNum}é¡µ...`);

            // ç§»é™¤æ‰€æœ‰é¡µé¢çš„activeç±»
            const allPages = document.querySelectorAll('.page');
            console.log(`ğŸ“„ æ‰¾åˆ°${allPages.length}ä¸ªé¡µé¢å…ƒç´ `);
            allPages.forEach((page, index) => {
                page.classList.remove('active');
                console.log(`   - ç§»é™¤ç¬¬${index + 1}ä¸ªé¡µé¢çš„activeç±»`);
            });

            // æ·»åŠ ç›®æ ‡é¡µé¢çš„activeç±»
            const targetPage = document.querySelector(`[data-page="${pageNum}"]`);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageNum;
                updatePageInfo();
                console.log(`âœ… æˆåŠŸåˆ‡æ¢åˆ°ç¬¬${pageNum}é¡µ`);

                // å¼ºåˆ¶é‡ç»˜
                targetPage.offsetHeight; // è§¦å‘é‡ç»˜

                // ç»˜åˆ¶å›¾åƒ
                setTimeout(() => {
                    drawPageGraph(pageNum);
                    console.log(`ğŸ¨ ç¬¬${pageNum}é¡µå›¾åƒç»˜åˆ¶å®Œæˆ`);
                }, 300);
            } else {
                console.log(`âŒ æœªæ‰¾åˆ°ç¬¬${pageNum}é¡µçš„DOMå…ƒç´ `);
            }
        }

        function drawPageGraph(pageNum) {
            const svg = d3.select(`#viz-${pageNum}`);
            svg.selectAll("*").remove(); // Clear previous content

            const container = svg.node().parentNode;
            const width = container.clientWidth;
            const height = container.clientHeight;
            svg.attr('viewBox', `0 0 ${width} ${height}`);

            switch(pageNum) {
                case 1: drawComparisonGraph(svg, width, height); break;
                case 2: drawQualificationGraph(svg, width, height); break;
                case 3: drawProcessChangeGraph(svg, width, height); break;
                case 4: drawRevelationGraph(svg, width, height); break;
                case 5: drawConclusionGraph(svg, width, height); break;
                case 6: drawInfinityIntroGraph(svg, width, height); break;
                case 7: drawReciprocalRelationGraph(svg, width, height); break;
                case 8: drawCase1Graph(svg, width, height); break;
                case 9: drawCase2Graph(svg, width, height); break;
                case 10: drawFinalConclusionGraph(svg, width, height); break;
            }
        }

        // --- D3 Graph Drawing Functions (æ— ç©·å°éƒ¨åˆ†) ---
        function drawComparisonGraph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-1.5, 3.5]).range([0, w]);
            const y = d3.scaleLinear().domain([-2, 7]).range([h, 0]);

            g.append("g").attr("transform", `translate(0,${y(0)})`).call(d3.axisBottom(x).ticks(5)).attr("class", "axis");
            g.append("g").attr("transform", `translate(${x(0)},0)`).call(d3.axisLeft(y).ticks(5)).attr("class", "axis");

            const funcG = d => d * d;
            const funcF = d => d + 5;

            const lineG = d3.line().x(d => x(d)).y(d => y(funcG(d))).curve(d3.curveCatmullRom);
            g.append("path").datum(d3.range(-1.5, 2.7, 0.1)).attr("fill", "none").attr("stroke", "#f87171").attr("stroke-width", 3).attr("d", lineG);
            const lineF = d3.line().x(d => x(d)).y(d => y(funcF(d)));
            g.append("path").datum(d3.range(-1.5, 2, 0.1)).attr("fill", "none").attr("stroke", "#38bdf8").attr("stroke-width", 3).attr("d", lineF);

            g.append("text").attr("x", x(2.5)).attr("y", y(funcG(2.5) + 0.5)).text("y = xÂ²").attr("class", "label").attr("fill", "#f87171");
            g.append("text").attr("x", x(1)).attr("y", y(funcF(1) + 0.5)).text("y = x+5").attr("class", "label").attr("fill", "#38bdf8");

            const gDot = g.append("circle").attr("r", 10).attr("fill", "#f87171");
            const fDot = g.append("circle").attr("r", 10).attr("fill", "#38bdf8");

            function animate() {
                const duration = 4000;
                const ease = d3.easeCubicInOut;
                const startX = 3, endX = 0.01;
                const xInterpolator = d3.interpolate(startX, endX);

                gDot.transition().duration(duration).ease(ease)
                    .attrTween("cx", () => t => x(xInterpolator(t)))
                    .attrTween("cy", () => t => y(funcG(xInterpolator(t))));
                fDot.transition().duration(duration).ease(ease)
                    .attrTween("cx", () => t => x(xInterpolator(t)))
                    .attrTween("cy", () => t => y(funcF(xInterpolator(t))))
                    .on("end", animate);
            }
            animate();
        }

        function drawQualificationGraph(svg, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;

            const textOffset = Math.min(width * 0.3, 200);
            const fontSize = Math.min(width * 0.08, 36);

            const g_result = svg.append("text").text("ç»“æœ: 0").attr("x", centerX - textOffset).attr("y", centerY).attr("font-size", fontSize + "px").attr("text-anchor", "middle").attr("fill", "#6ee7b7");
            const f_result = svg.append("text").text("ç»“æœ: 5").attr("x", centerX + textOffset).attr("y", centerY).attr("font-size", fontSize + "px").attr("text-anchor", "middle").attr("fill", "#f87171");

            const gate = svg.append("rect").attr("x", centerX - 100).attr("y", centerY - 150).attr("width", 200).attr("height", 300).attr("fill", "none").attr("stroke", "#38bdf8").attr("stroke-width", 3).attr("stroke-dasharray", "10,5");
            svg.append("text").text("èµ„æ ¼è®¤è¯").attr("x", centerX).attr("y", centerY - 170).attr("text-anchor", "middle").attr("class", "label").attr("fill", "#38bdf8");
            svg.append("text").text("ç»“æœ = 0 ?").attr("x", centerX).attr("y", centerY + 180).attr("text-anchor", "middle").attr("class", "label").attr("fill", "#38bdf8");

            const checkmark = svg.append("text").text("âœ”").attr("x", centerX).attr("y", centerY + 50).attr("font-size", "80px").attr("fill", "#6ee7b7").attr("text-anchor", "middle").attr("opacity", 0);
            const cross = svg.append("text").text("âœ–").attr("x", centerX).attr("y", centerY + 50).attr("font-size", "80px").attr("fill", "#f87171").attr("text-anchor", "middle").attr("opacity", 0);

            g_result.transition().duration(1500).ease(d3.easeCubicInOut).attr("x", centerX).on("end", () => checkmark.transition().duration(500).attr("opacity", 1));
            f_result.transition().duration(1500).ease(d3.easeCubicInOut).attr("x", centerX).on("end", () => {
                cross.transition().duration(500).attr("opacity", 1);
                gate.transition().duration(500).attr("stroke", "#f87171");
            });
        }

        function drawProcessChangeGraph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-6, 6]).range([0, w]);
            const y = d3.scaleLinear().domain([-5, 12]).range([h, 0]);
            const func = d => 1 / d;

            g.append("g").attr("transform", `translate(0,${y(0)})`).call(d3.axisBottom(x)).attr("class", "axis");
            g.append("g").attr("transform", `translate(${x(0)},0)`).call(d3.axisLeft(y)).attr("class", "axis");

            const line = d3.line().x(d => x(d)).y(d => y(func(d)));
            g.append("path").datum(d3.range(0.08, 6, 0.05)).attr("fill", "none").attr("stroke", "#a78bfa").attr("stroke-width", 3).attr("d", line);
            g.append("path").datum(d3.range(-6, -0.2, 0.05)).attr("fill", "none").attr("stroke", "#a78bfa").attr("stroke-width", 3).attr("d", line);
            g.append("text").attr("x", x(4)).attr("y", y(func(4) + 1)).text("y = 1/x").attr("class", "label").attr("fill", "#a78bfa");

            const dot = g.append("circle").attr("r", 10).attr("fill", "#a78bfa");
            const textLabel = g.append("text").attr("x", w/2).attr("y", -10).attr("text-anchor", "middle").attr("class", "label").attr("font-size", "28px");

            function animateToInfinity() {
                textLabel.text("è¿‡ç¨‹: x â†’ âˆ  ç»“æœ: y â†’ 0").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const startX = 0.5, endX = 6;
                const interpolator = d3.interpolate(startX, endX);
                dot.transition().duration(4000).ease(d3.easeQuadIn)
                   .attrTween("cx", () => t => x(interpolator(t)))
                   .attrTween("cy", () => t => y(func(interpolator(t))))
                   .on("end", () => textLabel.transition().duration(500).attr("opacity", 0).on("end", animateToZero));
            }
            function animateToZero() {
                textLabel.text("è¿‡ç¨‹: x â†’ 0  ç»“æœ: y â†’ âˆ").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const startX = 2, endX = 0.08;
                const interpolator = d3.interpolate(startX, endX);
                dot.transition().duration(4000).ease(d3.easeQuadOut)
                   .attrTween("cx", () => t => x(interpolator(t)))
                   .attrTween("cy", () => t => y(func(interpolator(t))))
                   .on("end", () => textLabel.transition().duration(500).attr("opacity", 0).on("end", animateToInfinity));
            }
            animateToInfinity();
        }

        function drawRevelationGraph(svg, width, height) {
             const centerX = width / 2;
             const centerY = height / 2;

             const titleFontSize = Math.min(width * 0.06, 28);
             const circleOffset = Math.min(width * 0.25, 160);
             const circleRadius = Math.min(width * 0.15, height * 0.2, 100);
             const textFontSize = Math.min(width * 0.06, 32);

             svg.append("text").text("y = 1/x").attr("x", centerX).attr("y", centerY - height * 0.35).attr("font-size", titleFontSize + "px").attr("text-anchor", "middle").attr("fill", "#a78bfa");

             const lens1 = svg.append("g").attr("transform", `translate(${centerX - circleOffset}, ${centerY})`);
             lens1.append("circle").attr("r", circleRadius).attr("fill", "#1e293b").attr("stroke", "#38bdf8").attr("stroke-width", 2);
             lens1.append("text").text("è¿‡ç¨‹: x â†’ âˆ").attr("y", -circleRadius - 20).attr("text-anchor", "middle").attr("class", "label");
             lens1.append("text").text("ç»“æœ: 0").attr("y", 10).attr("font-size", textFontSize + "px").attr("text-anchor", "middle").attr("fill", "#6ee7b7");

             const lens2 = svg.append("g").attr("transform", `translate(${centerX + circleOffset}, ${centerY})`);
             lens2.append("circle").attr("r", circleRadius).attr("fill", "#1e293b").attr("stroke", "#38bdf8").attr("stroke-width", 2);
             lens2.append("text").text("è¿‡ç¨‹: x â†’ 0").attr("y", -circleRadius - 20).attr("text-anchor", "middle").attr("class", "label");
             lens2.append("text").text("ç»“æœ: âˆ").attr("y", 10).attr("font-size", textFontSize + "px").attr("text-anchor", "middle").attr("fill", "#f87171");

             const questionMark = svg.append("text").text("?").attr("x", centerX).attr("y", centerY + 220).attr("font-size", "90px").attr("text-anchor", "middle").attr("fill", "white");

             lens1.attr("opacity", 0).transition().duration(1000).delay(500).attr("opacity", 1);
             lens2.attr("opacity", 0).transition().duration(1000).delay(1000).attr("opacity", 1);
             questionMark.attr("opacity", 0).transition().duration(1000).delay(1500).attr("opacity", 1);
        }

        function drawConclusionGraph(svg, width, height) {
            const textGroup = svg.append("g").attr("transform", `translate(${width/2}, ${height/2})`);

            const mainFontSize = Math.min(width * 0.12, 60);
            const titleFontSize = Math.min(width * 0.15, 70);

            const processText = textGroup.append("text").text("è¿‡ç¨‹").attr("font-size", mainFontSize + "px").attr("fill", "#38bdf8").attr("text-anchor", "middle");
            const resultText = textGroup.append("text").text("ç»“æœ").attr("font-size", mainFontSize + "px").attr("fill", "#6ee7b7").attr("text-anchor", "middle");
            const finalText = textGroup.append("text").text("æ— ç©·å°").attr("font-size", titleFontSize + "px").attr("font-weight", "bold").attr("fill", "white").attr("text-anchor", "middle");

            processText.attr("x", -width/2).attr("opacity", 0).transition().duration(1200).ease(d3.easeBounceOut).attr("x", -width/4).attr("opacity", 1);
            resultText.attr("x", width/2).attr("opacity", 0).transition().duration(1200).ease(d3.easeBounceOut).attr("x", width/4).attr("opacity", 1);

            const arrow = textGroup.append("path").attr("d", "M -120 0 L 120 0").attr("stroke", "white").attr("stroke-width", 4).attr("marker-end", "url(#arrow)").attr("opacity", 0);
            svg.append("defs").append("marker").attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", 5).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "white");

            setTimeout(() => {
               processText.transition().duration(1000).attr("x", -180);
               resultText.transition().duration(1000).attr("x", 180);
               arrow.transition().delay(500).duration(500).attr("opacity", 1);
               setTimeout(() => {
                   processText.transition().duration(800).attr("opacity", 0);
                   resultText.transition().duration(800).attr("opacity", 0);
                   arrow.transition().duration(800).attr("opacity", 0);
                   finalText.attr("opacity", 0).transition().delay(800).duration(1000).attr("opacity", 1).attr("transform", "scale(1.2)").transition().attr("transform", "scale(1)");
               }, 2000);
            }, 2000);
        }

        // --- D3 Graph Drawing Functions (æ— ç©·å¤§éƒ¨åˆ†) ---
        function drawInfinityIntroGraph(svg, width, height) {
            const fontSize = Math.min(width * 0.15, height * 0.2, 80);
            const text = svg.append("text").attr("x", width / 2).attr("y", height / 2).attr("text-anchor", "middle").attr("dominant-baseline", "middle").attr("font-size", fontSize + "px").attr("font-weight", "bold").attr("fill", "url(#grad0)");
            const gradient = svg.append("defs").append("linearGradient").attr("id", "grad0").attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%");
            gradient.append("stop").attr("offset", "0%").style("stop-color", "#e1bee7");
            gradient.append("stop").attr("offset", "100%").style("stop-color", "#81c784");
            text.selectAll("tspan").data("æ— ç©·å¤§".split("")).enter().append("tspan").text(d => d).attr("opacity", 0).attr("dy", "-30px").transition().duration(500).delay((d, i) => i * 150).attr("opacity", 1).attr("dy", "0px");
        }

        function drawReciprocalRelationGraph(svg, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;
            const boxWidth = Math.min(width * 0.35, 180);
            const boxHeight = Math.min(height * 0.25, 100);
            const gap = Math.min(width * 0.15, 100);

            const box1 = svg.append("g").attr("transform", `translate(${centerX - boxWidth - gap/2}, ${centerY - boxHeight/2})`);
            box1.append("rect").attr("width", boxWidth).attr("height", boxHeight).attr("fill", "#1e293b").attr("stroke", "#38bdf8").attr("stroke-width", 3).attr("rx", 10);
            box1.append("text").text("æ— ç©·å°").attr("x", boxWidth/2).attr("y", boxHeight/2).attr("text-anchor", "middle").attr("dominant-baseline", "middle").attr("font-size", "28px").attr("fill", "#6ee7b7");

            const box2 = svg.append("g").attr("transform", `translate(${centerX + gap/2}, ${centerY - boxHeight/2})`);
            box2.append("rect").attr("width", boxWidth).attr("height", boxHeight).attr("fill", "#1e293b").attr("stroke", "#f87171").attr("stroke-width", 3).attr("rx", 10);
            box2.append("text").text("æ— ç©·å¤§").attr("x", boxWidth/2).attr("y", boxHeight/2).attr("text-anchor", "middle").attr("dominant-baseline", "middle").attr("font-size", "28px").attr("fill", "#f87171");

            svg.append("defs").append("marker").attr("id", "arrow2").attr("viewBox", "0 -5 10 10").attr("refX", 9).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#f39c12");

            const arrow = svg.append("line")
                .attr("x1", centerX - gap/2 - 10)
                .attr("y1", centerY)
                .attr("x2", centerX + gap/2 + 10)
                .attr("y2", centerY)
                .attr("stroke", "#f39c12")
                .attr("stroke-width", 3)
                .attr("marker-end", "url(#arrow2)")
                .attr("opacity", 0);

            svg.append("text")
                .text("å€’æ•°å…³ç³»")
                .attr("x", centerX)
                .attr("y", centerY - boxHeight/2 - 30)
                .attr("text-anchor", "middle")
                .attr("font-size", "24px")
                .attr("fill", "#f39c12")
                .attr("opacity", 0)
                .transition()
                .delay(1000)
                .duration(800)
                .attr("opacity", 1);

            arrow.transition().delay(1500).duration(800).attr("opacity", 1);
        }

        function drawCase1Graph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-2, 6]).range([0, w]);
            const y = d3.scaleLinear().domain([-1, 8]).range([h, 0]);

            g.append("g").attr("transform", `translate(0,${y(0)})`).call(d3.axisBottom(x)).attr("class", "axis");
            g.append("g").attr("transform", `translate(${x(0)},0)`).call(d3.axisLeft(y)).attr("class", "axis");

            const line = d3.line().x(d => x(d)).y(d => y(d));
            g.append("path").datum(d3.range(-2, 6, 0.1)).attr("fill", "none").attr("stroke", "#f87171").attr("stroke-width", 3).attr("d", line);
            g.append("text").attr("x", x(5)).attr("y", y(5) - 20).text("y = x").attr("class", "label").attr("fill", "#f87171");

            const dot = g.append("circle").attr("r", 10).attr("fill", "#f87171");
            const label = g.append("text").attr("x", w/2).attr("y", -10).attr("text-anchor", "middle").attr("class", "label");

            function animateToZero() {
                label.text("x â†’ 0, y â†’ 0 (æ— ç©·å°)").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const interpolator = d3.interpolate(3, 0.01);
                dot.transition().duration(3000).ease(d3.easeQuadOut)
                    .attrTween("cx", () => t => x(interpolator(t)))
                    .attrTween("cy", () => t => y(interpolator(t)))
                    .on("end", () => label.transition().duration(500).attr("opacity", 0).on("end", animateToInfinity));
            }

            function animateToInfinity() {
                label.text("x â†’ âˆ, y â†’ âˆ (æ— ç©·å¤§)").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const interpolator = d3.interpolate(0.5, 5.5);
                dot.transition().duration(3000).ease(d3.easeQuadIn)
                    .attrTween("cx", () => t => x(interpolator(t)))
                    .attrTween("cy", () => t => y(interpolator(t)))
                    .on("end", () => label.transition().duration(500).attr("opacity", 0).on("end", animateToZero));
            }

            animateToZero();
        }

        function drawCase2Graph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-6, 6]).range([0, w]);
            const y = d3.scaleLinear().domain([-8, 12]).range([h, 0]);
            const func = d => 1 / d;

            g.append("g").attr("transform", `translate(0,${y(0)})`).call(d3.axisBottom(x)).attr("class", "axis");
            g.append("g").attr("transform", `translate(${x(0)},0)`).call(d3.axisLeft(y)).attr("class", "axis");

            const line = d3.line().x(d => x(d)).y(d => y(func(d)));
            g.append("path").datum(d3.range(0.08, 6, 0.05)).attr("fill", "none").attr("stroke", "#38bdf8").attr("stroke-width", 3).attr("d", line);
            g.append("path").datum(d3.range(-6, -0.2, 0.05)).attr("fill", "none").attr("stroke", "#38bdf8").attr("stroke-width", 3).attr("d", line);
            g.append("text").attr("x", x(4)).attr("y", y(func(4) + 1)).text("y = 1/x").attr("class", "label").attr("fill", "#38bdf8");

            const dot = g.append("circle").attr("r", 10).attr("fill", "#38bdf8");
            const label = g.append("text").attr("x", w/2).attr("y", -10).attr("text-anchor", "middle").attr("class", "label");

            function animateToZero() {
                label.text("x â†’ 0, y â†’ âˆ (æ— ç©·å¤§)").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const interpolator = d3.interpolate(2, 0.08);
                dot.transition().duration(3000).ease(d3.easeQuadOut)
                    .attrTween("cx", () => t => x(interpolator(t)))
                    .attrTween("cy", () => t => y(func(interpolator(t))))
                    .on("end", () => label.transition().duration(500).attr("opacity", 0).on("end", animateToInfinity));
            }

            function animateToInfinity() {
                label.text("x â†’ âˆ, y â†’ 0 (æ— ç©·å°)").attr("opacity", 0).transition().duration(500).attr("opacity", 1);
                const interpolator = d3.interpolate(0.5, 6);
                dot.transition().duration(3000).ease(d3.easeQuadIn)
                    .attrTween("cx", () => t => x(interpolator(t)))
                    .attrTween("cy", () => t => y(func(interpolator(t))))
                    .on("end", () => label.transition().duration(500).attr("opacity", 0).on("end", animateToZero));
            }

            animateToZero();
        }

        function drawFinalConclusionGraph(svg, width, height) {
            const textGroup = svg.append("g").attr("transform", `translate(${width/2}, ${height/2})`);

            const mainFontSize = Math.min(width * 0.1, 50);

            const infinitesimalText = textGroup.append("text").text("æ— ç©·å°").attr("font-size", mainFontSize + "px").attr("fill", "#6ee7b7").attr("text-anchor", "middle").attr("y", -60);
            const infinityText = textGroup.append("text").text("æ— ç©·å¤§").attr("font-size", mainFontSize + "px").attr("fill", "#f87171").attr("text-anchor", "middle").attr("y", 60);

            svg.append("defs").append("marker").attr("id", "arrow3").attr("viewBox", "0 -5 10 10").attr("refX", 9).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "white");

            const line1 = textGroup.append("line").attr("x1", 0).attr("y1", -30).attr("x2", 0).attr("y2", 30).attr("stroke", "white").attr("stroke-width", 3).attr("marker-end", "url(#arrow3)").attr("opacity", 0);
            const line2 = textGroup.append("line").attr("x1", 0).attr("y1", 30).attr("x2", 0).attr("y2", -30).attr("stroke", "white").attr("stroke-width", 3).attr("marker-end", "url(#arrow3)").attr("opacity", 0);

            infinitesimalText.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            infinityText.attr("opacity", 0).transition().delay(500).duration(1000).attr("opacity", 1);
            line1.transition().delay(1500).duration(800).attr("opacity", 1);
            line2.transition().delay(1500).duration(800).attr("opacity", 1);

            textGroup.append("text").text("å€’æ•°å…³ç³»").attr("y", 120).attr("text-anchor", "middle").attr("font-size", "24px").attr("fill", "#f39c12").attr("opacity", 0).transition().delay(2500).duration(800).attr("opacity", 1);
        }

        // ç­‰å¾…SDKåŠ è½½å®Œæˆ
        function waitForSDK() {
            return new Promise((resolve, reject) => {
                if (typeof window.AvatarPlatform !== 'undefined') {
                    resolve();
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('SDKåŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                }, 15000);

                window.addEventListener('sdkReady', function handler() {
                    clearTimeout(timeout);
                    window.removeEventListener('sdkReady', handler);
                    resolve();
                });
            });
        }

        // --- Control & Avatar Functions ---
        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = 'ğŸ”„ å¯åŠ¨ä¸­...';
            startBtn.disabled = true;

            try {
                console.log('â³ ç­‰å¾…SDKæ¨¡å—åŠ è½½...');
                updateStatus('ç­‰å¾…SDKåŠ è½½...', 'connecting');
                await waitForSDK();

                console.log('âœ… è®¯é£å®˜æ–¹SDKå·²åŠ è½½');
                updateStatus('SDKå·²åŠ è½½', 'connecting');

                if(avatarPlatform) {
                    avatarPlatform.destroy();
                }

                avatarPlatform = new window.AvatarPlatform({
                    useInlinePlayer: true
                });

                avatarPlatform
                    .on('connected', (initResp) => {
                        console.log('ğŸ‰ è™šæ‹Ÿäººè¿æ¥æˆåŠŸï¼', initResp);
                        isConnected = true;
                        isTeaching = true;
                        updateStatus('å·²è¿æ¥', 'connected');
                        startBtn.textContent = 'ğŸ’– è™šæ‹Ÿäººå·²å°±ç»ª';

                        setTimeout(() => {
                            speakContent(1);
                        }, 1000);
                    })
                    .on('disconnected', (err) => {
                        console.log('ğŸ”Œ è™šæ‹Ÿäººè¿æ¥æ–­å¼€');
                        isConnected = false;
                        updateStatus('è¿æ¥æ–­å¼€', 'error');
                        if (err) {
                            console.error('âŒ è¿æ¥å¼‚å¸¸æ–­å¼€:', err);
                        }
                    })
                    .on('error', (error) => {
                        console.error('âŒ è™šæ‹Ÿäººé”™è¯¯:', error);
                        updateStatus('é”™è¯¯: ' + error.message, 'error');
                        startBtn.textContent = 'âŒ è¿æ¥å¤±è´¥';
                        startBtn.disabled = false;
                        isTeaching = false;
                    })
                    .on('frame_start', (frameData) => {
                        console.log('ğŸ¬ [frame_start] å¼€å§‹æ’­æ”¾å¸§:', frameData);
                    })
                    .on('frame_stop', (frameData) => {
                        console.log('â¹ï¸ [frame_stop] æ’­æ”¾å¸§ç»“æŸ:', frameData);
                        console.log('âœ… ===== è¯­éŸ³æ’­æ”¾å®Œæˆï¼Œå¯ä»¥åˆ‡æ¢ä¸‹ä¸€é¡µ =====');

                        if (speechCompleteResolve) {
                            speechCompleteResolve();
                            speechCompleteResolve = null;
                        }
                    });

                console.log('ğŸ”§ æ­£åœ¨è®¾ç½®è™šæ‹ŸäººAPIé…ç½®...');
                avatarPlatform.setApiInfo({
                    appId: 'f34b6995',
                    apiKey: '11bce7d2c44157a6875476f368ceb2a0',
                    apiSecret: 'NjIzNjk2ZWQ0ZGNjMGE0ODkzYjhmNzQy',
                    sceneId: '233767656807862272',
                    serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact'
                });
                console.log('âœ… APIé…ç½®è®¾ç½®å®Œæˆ');

                avatarPlatform.setGlobalParams({
                    stream: {
                        protocol: 'xrtc',
                        alpha: 1,
                        bitrate: 1000000,
                        fps: 25
                    },
                    avatar: {
                        avatar_id: '110332017',
                        width: 1920,
                        height: 1080,
                        scale: 1,
                        move_h: 0,
                        move_v: 0,
                        audio_format: 1
                    },
                    tts: {
                        vcn: 'x4_yiting',
                        speed: 50,
                        pitch: 50,
                        volume: 100
                    },
                    avatar_dispatch: {
                        interactive_mode: 1,
                        content_analysis: 0
                    }
                });

                await avatarPlatform.start({
                    wrapper: document.getElementById('avatarWrapper')
                });

                console.log('ğŸ“ è™šæ‹Ÿäººæ•™å­¦ç³»ç»Ÿå¯åŠ¨å®Œæˆ');

            } catch (error) {
                console.error('âŒ å¯åŠ¨å¤±è´¥:', error);
                updateStatus('å¯åŠ¨å¤±è´¥', 'error');
                startBtn.textContent = 'ğŸ”„ é‡è¯•';
                startBtn.disabled = false;
            }
        }

        async function performVirtualAction(actionId) {
            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('âš ï¸ è™šæ‹Ÿäººæœªè¿æ¥ï¼Œè·³è¿‡åŠ¨ä½œæ‰§è¡Œ');
                return;
            }

            try {
                await avatarPlatform.writeCmd("action", actionId);
                console.log(`âœ… æ‰§è¡ŒåŠ¨ä½œ: ${actionId}`);
            } catch (error) {
                console.error(`âŒ åŠ¨ä½œæ‰§è¡Œå¤±è´¥ (${actionId}):`, error);
            }
        }

        function getActionsForPage(pageNum) {
            const actionMap = {
                1: [{ type: 'action', value: 'A_LH_please_O', wb: 2, we: 6 }],
                2: [{ type: 'action', value: 'A_LH_introduced_O', wb: 2, we: 8 }],
                3: [{ type: 'action', value: 'A_RLH_emphasize_O', wb: 2, we: 8 }],
                4: [{ type: 'action', value: 'A_RH_please1_O', wb: 2, we: 6 }],
                5: [{ type: 'action', value: 'A_U_No_pointing_O', wb: 2, we: 5 }],
                6: [{ type: 'action', value: 'A_RLH_welcome_O', wb: 2, we: 8 }],
                7: [{ type: 'action', value: 'A_RLH_emphasize_O', wb: 2, we: 8 }],
                8: [{ type: 'action', value: 'A_LH_please_O', wb: 2, we: 6 }],
                9: [{ type: 'action', value: 'A_LH_introduced_O', wb: 2, we: 8 }],
                10: [{ type: 'action', value: 'A_U_No_pointing_O', wb: 2, we: 5 }]
            };
            return actionMap[pageNum] || [{ type: 'action', value: 'A_U_No_pointing_O', wb: 2, we: 5 }];
        }

        let speechCompleteResolve = null;

        async function speakContent(pageNum) {
            console.log(`ğŸ” æ£€æŸ¥æ’­æ”¾æ¡ä»¶: isTeaching=${isTeaching}, isConnected=${isConnected}, avatarPlatform=${!!avatarPlatform}`);

            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('âš ï¸ è™šæ‹Ÿäººæœªè¿æ¥æˆ–æœªå¼€å§‹æ•™å­¦ï¼Œè·³è¿‡è¯­éŸ³æ’­æŠ¥');
                return Promise.resolve();
            }

            const content = subtitleScript[pageNum];
            if (!content) return Promise.resolve();

            const speechPromise = new Promise((resolve) => {
                speechCompleteResolve = resolve;
            });

            try {
                const actions = getActionsForPage(pageNum);
                if (actions && actions[0]) {
                    await performVirtualAction(actions[0].value);
                }

                await avatarPlatform.writeText(content, {
                    nlp: false
                });

                console.log(`âœ… æ²æ²è®²è§£ç¬¬${pageNum}é¡µå¼€å§‹æ’­æ”¾ï¼ŒåŠ¨ä½œ: ${actions[0]?.value}`);

                if (isAutoPlaying) {
                    updateAutoPlaySubtitle(pageNum, content);
                } else {
                    updateSubtitle(content);
                }
            } catch (error) {
                console.error('âŒ è™šæ‹Ÿäººè®²è§£å¤±è´¥:', error);
                if (speechCompleteResolve) {
                    speechCompleteResolve();
                }
            }

            return speechPromise;
        }

        function updateSubtitle(text) {
            const subtitleArea = document.getElementById('subtitleArea');
            if (subtitleArea) {
                subtitleArea.textContent = text;
            }
        }

        function updateAutoPlaySubtitle(pageNum, text) {
            const subtitleArea = document.getElementById('subtitleArea');
            if (subtitleArea && isAutoPlaying) {
                const prefix = `ã€ç¬¬${pageNum}é¡µ/${totalPages}é¡µã€‘`;
                subtitleArea.textContent = prefix + text;
            } else if (subtitleArea) {
                subtitleArea.textContent = text;
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                switchToPage(currentPage + 1);
            }
        }
        function previousPage() {
            if (currentPage > 1) {
                switchToPage(currentPage - 1);
            }
        }
        function restart() { switchToPage(1); }
        function updatePageInfo() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
        }

        function getPageTitle(pageNum) {
            const titles = {
                1: "æ— ç©·å°ï¼šè¿‡ç¨‹ä¸ç»“æœ",
                2: "æ— ç©·å°çš„èµ„æ ¼è®¤è¯",
                3: "è¿‡ç¨‹ä¸åŒï¼Œç»“æœä¹Ÿä¸åŒ",
                4: "ä¸€ä¸ªå…³é”®çš„å¯ç¤º",
                5: "æ— ç©·å°çš„ç»“è®º",
                6: "æ— ç©·å¤§ï¼šä¸æ— ç©·å°ç›¸å¯¹",
                7: "æ— ç©·å¤§ä¸æ— ç©·å°çš„å…³ç³»",
                8: "æ¡ˆä¾‹ç ”ç©¶(ä¸€): f(x)=x",
                9: "æ¡ˆä¾‹ç ”ç©¶(äºŒ): f(x)=1/x",
                10: "æœ€ç»ˆç»“è®º"
            };
            return titles[pageNum] || `ç¬¬${pageNum}é¡µ`;
        }

        function getPageDuration(pageNum) {
            const durations = {
                1: 27000, 2: 20000, 3: 22000, 4: 17000, 5: 16000,
                6: 18000, 7: 20000, 8: 18000, 9: 22000, 10: 20000
            };
            return durations[pageNum] || 15000;
        }

        let isAutoPlaying = false;
        async function startAutoPlay() {
            if (isAutoPlaying) {
                stopAutoPlay();
                return;
            }

            try {
                console.log('ğŸ¬ å¼€å§‹è‡ªåŠ¨æ’­æ”¾å®Œæ•´è¯¾ç¨‹...');
                isAutoPlaying = true;

                const autoPlayBtn = document.getElementById('autoPlayBtn');
                autoPlayBtn.textContent = 'â¹ï¸ åœæ­¢æ’­æ”¾';
                autoPlayBtn.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';

                updateStatus(`ğŸ¬ è‡ªåŠ¨æ’­æ”¾å°†åœ¨ 1 ç§’åå¼€å§‹ï¼Œè¯·å‡†å¤‡å½•å±ï¼`, 'recording');
                console.log(`â° å€’è®¡æ—¶: 1ç§’`);
                await new Promise(resolve => setTimeout(resolve, 1000));

                updateStatus('ğŸ¬ è‡ªåŠ¨æ’­æ”¾å¼€å§‹ï¼', 'recording');
                console.log('ğŸš€ è‡ªåŠ¨æ’­æ”¾æ­£å¼å¼€å§‹ï¼');

                document.body.classList.add('recording-mode');
                console.log('ğŸ“¹ è¿›å…¥å½•åˆ¶æ¨¡å¼ï¼Œéšè—UIå…ƒç´ ');

                if (!isConnected) {
                    console.log('ğŸ¬ åå°å°è¯•è¿æ¥è™šæ‹Ÿäºº...');
                    startTeaching().catch(error => {
                        console.log('âš ï¸ è™šæ‹Ÿäººè¿æ¥å¤±è´¥ï¼Œç»§ç»­é¡µé¢æ’­æ”¾:', error);
                    });
                }

                console.log(`ğŸš€ å¼€å§‹é€é¡µæ’­æ”¾ï¼Œæ€»å…±${totalPages}é¡µ`);
                for (let page = 1; page <= totalPages; page++) {
                    try {
                        if (!isAutoPlaying) {
                            console.log('ğŸ›‘ è‡ªåŠ¨æ’­æ”¾è¢«åœæ­¢');
                            break;
                        }

                        console.log(`\nğŸ¬ === å¼€å§‹æ’­æ”¾ç¬¬${page}é¡µ/${totalPages}é¡µ ===`);

                        switchToPageSilent(page);
                        updateStatus(`ğŸ“– ç¬¬${page}é¡µ/${totalPages}é¡µ - ${getPageTitle(page)}`, 'recording');
                        console.log(`ğŸ“„ å·²åˆ‡æ¢åˆ°ç¬¬${page}é¡µ: ${getPageTitle(page)}`);

                        console.log(`â³ ç­‰å¾…é¡µé¢æ¸²æŸ“ 0.8ç§’...`);
                        await new Promise(resolve => setTimeout(resolve, 800));

                        if (isConnected && isTeaching && avatarPlatform) {
                            console.log(`ğŸµ æ’­æ”¾ç¬¬${page}é¡µè¯­éŸ³...`);
                            try {
                                await speakContent(page);
                                console.log(`âœ… ç¬¬${page}é¡µè¯­éŸ³æ’­æ”¾å®Œæˆï¼ˆé€šè¿‡frame_stopäº‹ä»¶ç¡®è®¤ï¼‰`);

                            } catch (error) {
                                console.error(`âŒ ç¬¬${page}é¡µè¯­éŸ³æ’­æ”¾å¤±è´¥:`, error);
                                const pageTime = getPageDuration(page);
                                await new Promise(resolve => setTimeout(resolve, pageTime));
                            }
                        } else {
                            console.log(`âš ï¸ è™šæ‹Ÿäººä¸å¯ç”¨ï¼Œè·³è¿‡è¯­éŸ³æ’­æ”¾`);
                            const pageTime = getPageDuration(page);
                            console.log(`â° ç­‰å¾…é˜…è¯»æ—¶é—´ ${pageTime/1000}ç§’...`);
                            await new Promise(resolve => setTimeout(resolve, pageTime));
                        }

                        if (page === totalPages) {
                            console.log(`â³ æœ€åä¸€é¡µï¼Œåœé¡¿2ç§’...`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }

                        console.log(`âœ… ç¬¬${page}é¡µæ’­æ”¾å®Œæˆ\n`);

                    } catch (error) {
                        console.error(`âŒ ç¬¬${page}é¡µæ’­æ”¾è¿‡ç¨‹å‡ºé”™:`, error);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }

                console.log('ğŸ‰ æ‰€æœ‰é¡µé¢æ’­æ”¾å®Œæˆï¼');

                if (isAutoPlaying) {
                    console.log('â° ç­‰å¾…3ç§’åç»“æŸå½•åˆ¶...');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    stopAutoPlay();
                }

            } catch (error) {
                console.error('âŒ è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
                updateStatus('è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                stopAutoPlay();
            }
        }

        function stopAutoPlay() {
            if (isAutoPlaying) {
                isAutoPlaying = false;

                document.body.classList.remove('recording-mode');
                console.log('ğŸ“¹ é€€å‡ºå½•åˆ¶æ¨¡å¼ï¼Œæ¢å¤UIå…ƒç´ ');

                const autoPlayBtn = document.getElementById('autoPlayBtn');
                autoPlayBtn.textContent = 'ğŸ¬ è‡ªåŠ¨æ’­æ”¾';
                autoPlayBtn.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';

                console.log('â¹ï¸ è‡ªåŠ¨æ’­æ”¾å·²åœæ­¢');
                updateStatus('è‡ªåŠ¨æ’­æ”¾å·²åœæ­¢', 'normal');
            }
        }

        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextPage();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousPage();
                    break;
                case 'Enter':
                    e.preventDefault();
                    handleEnterKey();
                    break;
            }
        });

        function handleEnterKey() {
            if (!isTeaching) {
                startTeaching();
            } else if (isConnected) {
                speakContent(currentPage);
                console.log('ğŸµ Enteré”®è§¦å‘ï¼šé‡æ–°æ’­æ”¾å½“å‰é¡µå†…å®¹');
            } else {
                console.log('âš ï¸ è™šæ‹Ÿäººæœªè¿æ¥ï¼Œæ— æ³•æ’­æ”¾');
            }
        }

        window.addEventListener('beforeunload', function() {
            if (isAutoPlaying) {
                stopAutoPlay();
            }

            if (avatarPlatform && isConnected) {
                avatarPlatform.stop();
            }
        });
    </script>
</body>
</html>
