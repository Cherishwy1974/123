<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>
   02_2.11_ä¸¤ä¸ªé‡è¦æé™
  </title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://d3js.org/d3.v7.min.js">
</script>
<style>
   * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Serif SC', serif;
            background: #1a1a2e;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        .blackboard {
            width: 100vw;
            height: 100vh;
            background: #1a1a2e;
            position: relative;
            border: 10px solid #795548;
            margin: 0;
        }
        /* è™šæ‹Ÿäººæ˜¾ç¤ºåŒºåŸŸ - ç¨å¾®ä¸‹ç§»ï¼Œé¿å…é®æŒ¡å†…å®¹ */
        .avatar-container {
            position: fixed;
            top: 60%; left: 50%;
            transform: translate(-50%, -50%);
            width: 975px; height: 1105px;
            overflow: hidden; z-index: 50;
            pointer-events: none; background: transparent;
            border: none; box-shadow: none;
        }
        .wrapper {
            width: 100%; height: 100%;
            background: transparent; pointer-events: auto;
        }
        /* æ•™å­¦å†…å®¹åŒºåŸŸ - é¿è®©è™šæ‹Ÿäººï¼Œå·¦å³åˆ†å¸ƒ */
        .content-area {
            position: absolute;
            top: 20px; left: 50px; right: 50px; bottom: 120px;
            z-index: 10; overflow: hidden;
        }
        .page {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0; visibility: hidden;
            transition: all 0.7s ease-in-out;
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 3fr; /* è°ƒæ•´æ¯”ä¾‹ï¼Œç»™å›¾æ›´å¤§ç©ºé—´ */
            gap: 20px;
            align-items: center;
        }
        .page.active {
            opacity: 1; visibility: visible;
        }
        /* å°é¢é¡µç‰¹æ®Šæ ·å¼ - è¦†ç›–gridå¸ƒå±€ */
        .page.cover-page {
            display: flex !important;
            grid-template-columns: none !important;
            padding: 0 !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .page.cover-page > div {
            display: flex !important;
        }
        .chalk-text {
            color: #ffffff;
            font-family: 'Noto Serif SC', 'Source Han Serif SC', 'Source Han Serif CN',
                         'Songti SC', 'SimSun', 'å®‹ä½“', serif;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .page-title {
            font-size: 24px; font-weight: bold;
            color: #e1bee7; margin-bottom: 1rem;
        }
        .text-medium {
            font-size: 16px;
            margin-bottom: 0.8rem;
            line-height: 1.7;
            color: #f3e5f5;
            font-weight: 500;
        }
        .emphasis {
            color: #FF6B6B;
            font-size: 18px;
        }
        .text-medium p {
            margin-bottom: 1rem;
        }
        .text-medium strong {
            color: #81c784;
            font-weight: 600;
        }
        .graph-container {
            background: transparent;
            border: none;
            padding: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        /* å­—å¹•åŒºåŸŸ - å…¨å®½æ˜¾ç¤ºï¼Œè™šæ‹Ÿäººä¸å½±å“å¸ƒå±€ */
        .subtitle-area {
            position: absolute;
            bottom: 20px; left: 50px; right: 50px;
            height: 50px; background: rgba(0,0,0,0.8);
            border-radius: 8px; display: flex;
            align-items: center; justify-content: center;
            z-index: 60; color: white;
            font-size: 0.9rem; text-align: center;
            padding: 0 20px; line-height: 1.4;
        }
        /* å·¦ä¾§æ§åˆ¶æ  */
        .control-bar {
            position: fixed;
            left: -9999px;
            top: 50%;
            transform: translateY(-50%);
            width: 270px;
            height: auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            z-index: 200;
            border-radius: 0 20px 20px 0;
            padding: 25px 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-bar:hover { 
            left: -9999px; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.3); 
        }
        .control-bar::before {
            content: 'â–¶ï¸';
            position: absolute;
            top: 50%;
            right: -30px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 8px;
            border-radius: 0 15px 15px 0;
            font-size: 0.9rem;
            writing-mode: vertical-lr;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #333;
        }
        .btn {
            padding: 14px 22px;
            background: rgba(255, 255, 255, 0.25);
            color: #333;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            text-align: center;
            backdrop-filter: blur(5px);
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }
        .btn:hover { 
            background: rgba(255, 255, 255, 0.35); 
            transform: translateY(-3px); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); 
        }
        .btn.primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.3); 
        }
        .btn.primary:hover { 
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); 
            box-shadow: 0 8px 25px rgba(102,126,234,0.4); 
        }

        /* åæ ‡ç³»æ ·å¼ - æ”¹ä¸ºç™½è‰² */
        .viz-panel .axis path,
        .viz-panel .axis line {
            stroke: white;
            stroke-width: 2;
        }
        .viz-panel .axis text {
            fill: white;
            font-size: 18px;
        }
        .viz-panel .label {
            fill: white;
            font-size: 18px;
            font-weight: 500;
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ - é»˜è®¤éšè— */
        .status-indicator {
            position: absolute;
            top: 10px; right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            color: white; border-radius: 5px;
            font-size: 12px; z-index: 100;
            transition: opacity 0.3s ease;
            display: none; /* é»˜è®¤éšè—çº¢è‰²æç¤º */
        }
        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); }
        .status-indicator.recording {
            background: rgba(244, 67, 54, 0.8);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); }

        /* å½•åˆ¶æ¨¡å¼ä¸‹éšè—çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .recording-mode .status-indicator {
            opacity: 0; pointer-events: none;
        }
        /* å½•åˆ¶æ¨¡å¼ä¸‹éšè—æ§åˆ¶æ  */
        .recording-mode .control-bar {
            left: -9999px; transition: left 0.5s ease;
        }
  </style>
</head>
<body>
<div class="blackboard">
<div class="status-indicator" id="statusIndicator">
    ç­‰å¾…è¿æ¥
   </div>
<div class="avatar-container">
<div class="wrapper" id="avatarWrapper">
</div>
</div>
<div class="content-area" id="contentArea">
<div class="page active cover-page" data-page="1">
<div style="display: flex !important; width: 100%; height: 100%; align-items: center; justify-content: center;">
<div style="flex: 1; text-align: center; padding: 2rem;">
<h1 style="font-size: 2.2rem; font-weight: bold; color: #f1c40f; text-shadow: 0 0 8px rgba(241, 196, 15, 0.5); margin-bottom: 1rem;">
        ä¸¤ä¸ªé‡è¦æé™
       </h1>
<p style="font-size: 1.1rem; color: #9ca3af; margin-bottom: 1.5rem;">
        ç¬¬2ç«  è§†é¢‘ 2.5
       </p>
<div style="display: inline-block; text-align: left; margin-top: 1.5rem;">
<p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">
         âœ“ ç¬¬ä¸€é‡è¦æé™ lim(sinx/x)
        </p>
<p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">
         âœ“ ç¬¬äºŒé‡è¦æé™ lim(1+1/x)^x
        </p>
<p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">
         âœ“ ä¸¤ä¸ªæé™çš„æ¨å¹¿å½¢å¼
        </p>
<p style="font-size: 0.95rem; color: #e0e0e0; margin: 0.6rem 0;">
         âœ“ é‡è¦æé™çš„å…¸å‹åº”ç”¨
        </p>
</div>
</div>
<div style="flex: 1; display: flex; align-items: center; justify-content: center;">
<svg style="width: 100%; max-width: 500px; height: 400px;" viewbox="0 0 600 500">
<defs>
<lineargradient id="grad1" x1="0%" x2="100%" y1="0%" y2="100%">
<stop offset="0%" style="stop-color:#3498db;stop-opacity:1">
</stop>
<stop offset="100%" style="stop-color:#9b59b6;stop-opacity:1">
</stop>
</lineargradient>
</defs>
<text fill="url(#grad1)" font-family="serif" font-size="60" text-anchor="middle" x="300" y="120">
         lim
         <animate attributename="opacity" dur="2s" repeatcount="indefinite" values="0.5;1;0.5">
</animate>
</text>
<line stroke="#3498db" stroke-width="3" x1="100" x2="500" y1="250" y2="250">
</line>
<circle cx="500" cy="250" fill="#e74c3c" r="15">
<animate attributename="r" dur="2s" repeatcount="indefinite" values="10;20;10">
</animate>
</circle>
<path d="M 100 250 Q 300 150 500 250" fill="none" stroke="#2ecc71" stroke-width="3">
<animate attributename="stroke-dasharray" dur="3s" repeatcount="indefinite" values="0,1000;1000,0">
</animate>
</path>
<text fill="#e74c3c" font-size="24" text-anchor="middle" x="500" y="300">
         xâ†’xâ‚€
        </text>
</svg>
</div>
</div>
</div>

<!-- Pages will be dynamically generated here -->
</div>
<div class="subtitle-area" id="subtitleArea">
    æ¬¢è¿å­¦ä¹ ä¸¤ä¸ªé‡è¦æé™!ç‚¹å‡»"å¼€å§‹è®²è¯¾"å¯åŠ¨è™šæ‹Ÿäººè®²å¸ˆã€‚
   </div>
<div class="control-bar">
<div style="color: white; margin-bottom: 1rem; text-align: center; font-size: 12px;">
     ç¬¬
     <span id="currentPage">
      1
     </span>
     é¡µ / å…±
     <span id="totalPages">
      7
     </span>
     é¡µ
    </div>
<div id="connectionStatus" style="color: #ffab40; margin-bottom: 1rem; text-align: center; font-size: 11px;">
     è™šæ‹Ÿäººæœªè¿æ¥
    </div>
<button class="btn" onclick="previousPage()">
     â¬…ï¸ ä¸Šä¸€é¡µ
    </button>
<button class="btn primary" id="startBtn" onclick="startTeaching()">
     ğŸ€ å¼€å§‹è®²è¯¾
    </button>
<button class="btn" onclick="nextPage()">
     ä¸‹ä¸€é¡µ â¡ï¸
    </button>
<button class="btn" onclick="restart()">
     ğŸ”„ é‡æ–°å¼€å§‹
    </button>
<button class="btn" id="autoPlayBtn" onclick="startAutoPlay()" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
     ğŸ¬ è‡ªåŠ¨æ’­æ”¾
    </button>
<div style="color: #ffab40; margin-top: 0.5rem; text-align: center; font-size: 10px; line-height: 1.2;">
     ğŸ’¡ å½•åˆ¶æç¤º:
     <br/>
     ç‚¹å‡»è‡ªåŠ¨æ’­æ”¾åç«‹å³å¼€å§‹å½•å±
     <br/>
     ç³»ç»Ÿä¼šè‡ªåŠ¨å®Œæˆå…¨éƒ¨æ¼”ç¤º
    </div>
</div>
</div>
<script>
   window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: ['base', 'ams']
            },
            startup: {
                pageReady: () => {
                    console.log('MathJax is ready.');
                    return MathJax.startup.defaultPageReady();
                }
            }
        };
  </script>
<script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<!-- è®¯é£å®˜æ–¹SDK - æŒ‰ç…§æˆåŠŸæ¡ˆä¾‹çš„åŠ è½½æ–¹å¼ -->
<script type="module">
        // æ’­æ”¾å®Œæˆæ ‡è®°ï¼ˆä¾›OBSæ£€æµ‹ï¼‰
        window.playbackFinished = false;

   try {
                    // æ ¹æ®æˆåŠŸæ¡ˆä¾‹,å¯¼å…¥è®¯é£å®˜æ–¹SDK
        const { default: AvatarPlatform, SDKEvents, PlayerEvents, RecorderEvents, UserMedia } = await import('./avatar-sdk-web_3.1.2.1002/index.js');

        // æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡
        window.AvatarPlatform = AvatarPlatform;
        window.SDKEvents = SDKEvents;
        window.PlayerEvents = PlayerEvents;
        window.RecorderEvents = RecorderEvents;
        window.UserMedia = UserMedia;

        console.log('âœ… è®¯é£å®˜æ–¹SDKæ¨¡å—å·²åŠ è½½');
        console.log('SDKç‰ˆæœ¬:', AvatarPlatform.getVersion());
        console.log('å¯ç”¨äº‹ä»¶:', { SDKEvents, PlayerEvents, RecorderEvents });

    } catch (error) {
        console.error('âŒ SDKæ¨¡å—åŠ è½½å¤±è´¥:', error);
        throw error; // ç›´æ¥æŠ›å‡ºé”™è¯¯,ä¸ä½¿ç”¨æ¨¡æ‹ŸSDK
    }

        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶,é€šçŸ¥SDKå·²å‡†å¤‡å°±ç»ª
        window.dispatchEvent(new CustomEvent('sdkReady'));
  </script>
<script>
   let avatarPlatform = null;
        let isConnected = false;
        let isTeaching = false;
        let currentPage = 1;
        const totalPages = 7;

        // ç®€åŒ–çš„æ•™å­¦å†…å®¹ - é¿å…æˆªæ–­
        const boardContent = [
            {
                title: "ç¬¬ä¸€é‡è¦æé™",
                text: "<p><strong>æ ¸å¿ƒå…¬å¼:</strong></p><p>$\\lim\\limits_{x \\to 0} \\frac{\\sin x}{x} = 1$</p><p><strong>ç‰¹ç‚¹åˆ†æ:</strong></p><ul><li>è¿™æ˜¯ä¸€ä¸ª <span class='highlight'>$\\frac{0}{0}$ å‹æœªå®šå¼</span></li><li>å½“ $x \\to 0$ æ—¶,$\\sin x \\to 0$,$x \\to 0$</li><li>ä½†æ¯”å€¼çš„æé™å­˜åœ¨ä¸”ç­‰äº1</li></ul><p><strong>å‡ ä½•æ„ä¹‰:</strong><br>åœ¨å•ä½åœ†ä¸­,å½“åœ†å¿ƒè§’å¾ˆå°æ—¶,å¼§é•¿ã€æ­£å¼¦å€¼å’Œè§’åº¦è¶‹äºç›¸ç­‰ã€‚</p><p><strong>é‡è¦æ€§:</strong>è¿™æ˜¯ä¸‰è§’å‡½æ•°æ±‚å¯¼çš„ç†è®ºåŸºç¡€ã€‚</p>"
            },
            {
                title: "ç¬¬ä¸€é‡è¦æé™çš„æ¨å¹¿",
                text: "<p><strong>æ ¸å¿ƒæ€æƒ³:</strong>åªè¦ä¸€ä¸ªæ•´ä½“ $\\Delta$ è¶‹å‘äº 0,é‚£ä¹ˆ $\\frac{\\sin(\\Delta)}{\\Delta}$ çš„æé™å°±æ˜¯ 1ã€‚</p><p><strong>æ¨å¹¿å…¬å¼:</strong></p><p>$\\lim\\limits_{\\Delta \\to 0} \\frac{\\sin(\\Delta)}{\\Delta} = 1$</p><p><strong>åº”ç”¨å®ä¾‹:</strong></p><ul><li>å½“ $x \\to 1$ æ—¶,$(x-1) \\to 0$:$\\lim\\limits_{x \\to 1} \\frac{\\sin(x - 1)}{x - 1} = 1$</li><li>å½“ $x \\to 0$ æ—¶,$3x \\to 0$:$\\lim\\limits_{x \\to 0} \\frac{\\sin 3x}{3x} = 1$</li></ul><p><strong>è§£é¢˜æŠ€å·§:</strong>è¯†åˆ« \"æ•´ä½“\" æ˜¯å…³é”®ã€‚</p>"
            },
            {
                title: "ç¬¬äºŒé‡è¦æé™",
                text: "<p><strong>æ ¸å¿ƒå…¬å¼:</strong></p><p>$\\lim\\limits_{x \\to \\infty} \\left(1 + \\frac{1}{x}\\right)^x = e$</p><p><strong>ç‰¹ç‚¹åˆ†æ:</strong></p><ul><li>è¿™æ˜¯ä¸€ä¸ª <span class='highlight'>$1^{\\infty}$ å‹æœªå®šå¼</span></li><li>å½“ $x \\to \\infty$ æ—¶,$(1+\\frac{1}{x}) \\to 1$,æŒ‡æ•° $x \\to \\infty$</li><li>æé™å€¼æ˜¯è‡ªç„¶å¯¹æ•°çš„åº• $e \\approx 2.71828$</li></ul><p><strong>æ•°å­¦æ„ä¹‰:</strong></p><ul><li>å®šä¹‰äº†è‡ªç„¶å¯¹æ•°çš„åº•æ•° $e$</li><li>è¿ç»­å¤åˆ©è®¡ç®—çš„ç†è®ºåŸºç¡€</li><li>æŒ‡æ•°å‡½æ•°å’Œå¯¹æ•°å‡½æ•°çš„é‡è¦çº½å¸¦</li></ul><p><strong>å®é™…åº”ç”¨:</strong>é“¶è¡Œå¤åˆ©ã€äººå£å¢é•¿æ¨¡å‹ç­‰ã€‚</p>"
            },
            {
                title: "ç¬¬äºŒé‡è¦æé™çš„æ¨å¹¿",
                text: "<p><strong>æ ¸å¿ƒæ€æƒ³:</strong>åªè¦ä¸€ä¸ªæ•´ä½“ $\\Delta$ è¶‹å‘äº $\\infty$,é‚£ä¹ˆ $(1+\\frac{1}{\\Delta})^{\\Delta}$ çš„æé™å°±æ˜¯ $e$ã€‚</p><p><strong>æ¨å¹¿å…¬å¼:</strong></p><p>$\\lim\\limits_{\\Delta \\to \\infty} \\left(1 + \\frac{1}{\\Delta}\\right)^{\\Delta} = e$</p><p><strong>å˜å½¢å½¢å¼:</strong></p><ul><li>å½“ $u \\to 0$ æ—¶:$\\lim\\limits_{u \\to 0} (1 + u)^{\\frac{1}{u}} = e$</li><li>æ›´ä¸€èˆ¬çš„å½¢å¼:$\\lim\\limits_{n \\to \\infty} \\left(1 + \\frac{k}{n}\\right)^n = e^k$</li></ul><p><strong>è®°å¿†æŠ€å·§:</strong>\"1åŠ ä»€ä¹ˆåˆ†ä¹‹ä¸€,å†å¼€ä»€ä¹ˆæ¬¡æ–¹,æé™éƒ½æ˜¯e\"</p>"
            },
            {
                title: "ç¬¬ä¸€é‡è¦æé™æ€»ç»“",
                text: "<p><strong>æ ‡å‡†å½¢å¼:</strong></p><p>$\\lim\\limits_{\\Delta \\to 0} \\frac{\\sin(\\Delta)}{\\Delta} = 1$</p><p><strong>é€‚ç”¨æ¡ä»¶:</strong></p><ul><li>åˆ†å­å«æœ‰æ­£å¼¦å‡½æ•°</li><li>åˆ†æ¯ä¸æ­£å¼¦å‡½æ•°çš„è‡ªå˜é‡ç›¸åŒ</li><li>è¯¥è‡ªå˜é‡è¶‹å‘äº0</li></ul><p><strong>è§£é¢˜æ­¥éª¤:</strong></p><ul><li>1. è¯†åˆ«æ­£å¼¦å‡½æ•°ä¸­çš„\"æ•´ä½“\"</li><li>2. ç¡®è®¤è¯¥\"æ•´ä½“\"è¶‹å‘äº0</li><li>3. æ„é€ æ ‡å‡†å½¢å¼</li><li>4. ç›´æ¥åº”ç”¨å…¬å¼</li></ul><p><strong>å¸¸è§å˜å½¢:</strong> $\\frac{\\sin kx}{kx}$ã€$\\frac{\\tan x}{x}$ã€$\\frac{\\arcsin x}{x}$ ç­‰</p>"
            },
            {
                title: "ç¬¬äºŒé‡è¦æé™æ€»ç»“",
                text: "<p><strong>æ ‡å‡†å½¢å¼:</strong></p><p>$\\lim\\limits_{\\Delta \\to \\infty} \\left(1 + \\frac{1}{\\Delta}\\right)^{\\Delta} = e$</p><p><strong>é€‚ç”¨æ¡ä»¶:</strong></p><ul><li>åº•æ•°å½¢å¦‚ $(1 + \\frac{1}{\\Delta})$</li><li>æŒ‡æ•°ä¸º $\\Delta$</li><li>$\\Delta$ è¶‹å‘äºæ— ç©·å¤§</li></ul><p><strong>è§£é¢˜æ­¥éª¤:</strong></p><ul><li>1. è¯†åˆ«åº•æ•°ä¸­çš„\"æ•´ä½“\"å˜é‡</li><li>2. ç¡®è®¤è¯¥å˜é‡è¶‹å‘äºæ— ç©·å¤§</li><li>3. å°†è¡¨è¾¾å¼åŒ–ä¸ºæ ‡å‡†å½¢å¼</li><li>4. ç›´æ¥åº”ç”¨å…¬å¼å¾—åˆ° $e$</li></ul><p><strong>å®é™…æ„ä¹‰:</strong>å¤åˆ©è®¡ç®—ã€è‡ªç„¶å¢é•¿æ¨¡å‹çš„æ•°å­¦åŸºç¡€ã€‚</p>"
            }
        ];

        const subtitleScript = {
            1: "åŒå­¦ä»¬å¥½,ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸¤ä¸ªåœ¨å¾®ç§¯åˆ†ä¸­å æ®æ ¸å¿ƒåœ°ä½çš„é‡è¦æé™ã€‚æŒæ¡å®ƒä»¬,æ˜¯è§£å†³è®¸å¤šå¤æ‚æé™é—®é¢˜çš„åŸºç¡€,ä¹Ÿæ˜¯åç»­å­¦ä¹ å¯¼æ•°å’Œç§¯åˆ†çš„é‡è¦å·¥å…·ã€‚å®ƒä»¬åˆ†åˆ«ç”¨äºè§£å†³0æ¯”0å‹å’Œ1çš„æ— ç©·å¤§æ¬¡å¹‚å‹æœªå®šå¼ã€‚",
            2: "é¦–å…ˆæ˜¯ç¬¬ä¸€é‡è¦æé™ã€‚å½“è‡ªå˜é‡xæ— é™è¶‹è¿‘äº0æ—¶,æ­£å¼¦å‡½æ•°sinxä¸xçš„æ¯”å€¼,å…¶æé™ä¸º1ã€‚è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„0æ¯”0å‹æœªå®šå¼,ä½†å®ƒçš„ç»“æœæ˜¯ç¡®å®šçš„,å°±æ˜¯1ã€‚å³ä¾§å›¾åƒæ˜¾ç¤ºäº†å‡½æ•°çš„å˜åŒ–è¶‹åŠ¿ã€‚è¿™ä¸ªæé™æœ‰ç€æ·±åˆ»çš„å‡ ä½•æ„ä¹‰,æ˜¯ä¸‰è§’å‡½æ•°æ±‚å¯¼çš„ç†è®ºåŸºç¡€ã€‚",
            3: "ç¬¬ä¸€é‡è¦æé™æœ‰ä¸€ä¸ªéå¸¸å®ç”¨çš„æ¨å¹¿å½¢å¼ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯:åªè¦ä¸€ä¸ªæ•´ä½“è¶‹å‘äº0,é‚£ä¹ˆè¿™ä¸ªæ•´ä½“çš„æ­£å¼¦ä¸è¿™ä¸ªæ•´ä½“çš„æ¯”å€¼,æé™å°±ä¸º1ã€‚æ¯”å¦‚å½“xè¶‹å‘äº1æ—¶,xå‡1å°±è¶‹å‘äº0,æ‰€ä»¥å¯ä»¥ç›´æ¥åº”ç”¨ã€‚è¯†åˆ«æ•´ä½“æ˜¯è§£é¢˜çš„å…³é”®æŠ€å·§ã€‚",
            4: "æ¥ä¸‹æ¥æ˜¯ç¬¬äºŒé‡è¦æé™ã€‚å½“xè¶‹å‘æ— ç©·å¤§æ—¶,1åŠ xåˆ†ä¹‹1çš„xæ¬¡æ–¹,å®ƒçš„æé™æ˜¯è‡ªç„¶å¯¹æ•°çš„åº•æ•°e,çº¦ç­‰äº2.718ã€‚è¿™æ˜¯ä¸€ä¸ª1çš„æ— ç©·å¤§æ¬¡å¹‚å‹æœªå®šå¼ã€‚è¿™ä¸ªæé™å®šä¹‰äº†è‡ªç„¶å¯¹æ•°çš„åº•æ•°,æ˜¯è¿ç»­å¤åˆ©è®¡ç®—å’Œè‡ªç„¶å¢é•¿æ¨¡å‹çš„ç†è®ºåŸºç¡€ã€‚",
            5: "ç¬¬äºŒé‡è¦æé™ä¹Ÿæœ‰æ¨å¹¿å½¢å¼ã€‚åªè¦ä¸€ä¸ªæ•´ä½“è¶‹å‘äºæ— ç©·å¤§,é‚£ä¹ˆ1åŠ æ•´ä½“åˆ†ä¹‹1çš„æ•´ä½“æ¬¡æ–¹,æé™å°±æ˜¯eã€‚è¿™ä¸ªæ¨å¹¿è®©æˆ‘ä»¬èƒ½å¤Ÿå¤„ç†æ›´å¤šå¤æ‚çš„æƒ…å†µ,åœ¨å®é™…åº”ç”¨ä¸­éå¸¸æœ‰ç”¨ã€‚",
            6: "æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹è§£é¢˜æ–¹æ³•ã€‚å¯¹äºç¬¬ä¸€é‡è¦æé™,è¦è¯†åˆ«sinæ•´ä½“é™¤ä»¥æ•´ä½“çš„ç»“æ„,ç¡®è®¤æ•´ä½“è¶‹å‘äº0,ç„¶åç›´æ¥åº”ç”¨å…¬å¼ã€‚å¯¹äºç¬¬äºŒé‡è¦æé™,è¦è¯†åˆ«1åŠ æ•´ä½“åˆ†ä¹‹1çš„æ•´ä½“æ¬¡æ–¹çš„ç»“æ„,ç¡®è®¤æ•´ä½“è¶‹å‘äºæ— ç©·å¤§ã€‚è§£é¢˜çš„æ ¸å¿ƒæ˜¯æŠŠå¤æ‚è¡¨è¾¾å¼çœ‹ä½œæ•´ä½“ã€‚",
            7: "æœ€åæˆ‘ä»¬çœ‹ä¸€äº›å®é™…åº”ç”¨ã€‚ç¬¬ä¸€é‡è¦æé™å¯ä»¥ç”¨æ¥å¤„ç†æ­£åˆ‡å‡½æ•°ã€åæ­£å¼¦å‡½æ•°ç­‰ç›¸å…³çš„æé™é—®é¢˜ã€‚ç¬¬äºŒé‡è¦æé™åœ¨å¤åˆ©è®¡ç®—ã€äººå£å¢é•¿ã€æ”¾å°„æ€§è¡°å˜ç­‰æ¨¡å‹ä¸­éƒ½æœ‰é‡è¦åº”ç”¨ã€‚è¿™ä¸¤ä¸ªæé™æ˜¯å¾®ç§¯åˆ†çš„é‡è¦å·¥å…·,ç†Ÿç»ƒæŒæ¡å®ƒä»¬èƒ½è§£å†³å¾ˆå¤šå®é™…é—®é¢˜ã€‚"
        };

        const autoPlayDurations = { 1: 15000, 2: 20000, 3: 18000, 4: 20000, 5: 15000, 6: 20000, 7: 18000 };

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'normal') {
            const indicator = document.getElementById('statusIndicator');
            const connectionStatus = document.getElementById('connectionStatus');

            if (indicator) {
                indicator.textContent = message;
                indicator.className = 'status-indicator';
                if (type === 'connected') {
                    indicator.classList.add('connected');
                } else if (type === 'error') {
                    indicator.classList.add('error');
                } else if (type === 'connecting') {
                    indicator.classList.add('connecting');
                }
            }

            if (connectionStatus) {
                connectionStatus.textContent = message;
                connectionStatus.style.color = type === 'connected' ? '#81c784' :
                                              type === 'error' ? '#f44336' : '#ffab40';
            }
        }

        // ç­‰å¾…SDKåŠ è½½å®Œæˆ
        function waitForSDK() {
            return new Promise((resolve, reject) => {
                if (typeof AvatarPlatform !== 'undefined') {
                    resolve();
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('SDKåŠ è½½è¶…æ—¶,è¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                }, 10000);

                window.addEventListener('sdkReady', function handler() {
                    clearTimeout(timeout);
                    window.removeEventListener('sdkReady', handler);
                    resolve();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const contentArea = document.getElementById('contentArea');
            
            // å°é¢é¡µå·²ç»åœ¨HTMLä¸­å­˜åœ¨ï¼Œä¸éœ€è¦åŠ¨æ€åˆ›å»º

            // åˆ›å»ºå†…å®¹é¡µ
            boardContent.forEach((content, i) => {
                const page = document.createElement('div');
                page.className = 'page';
                page.dataset.page = i + 2;
                page.innerHTML = `
                    <div class="chalk-text">
                        <div class="page-title">${content.title}</div>
                        <div class="text-medium">${content.text}</div>
                    </div>
                    <div class="graph-container">
                        <svg id="viz-${i+2}" width="100%" height="100%"></svg>
                    </div>
                `;
                contentArea.appendChild(page);
            });

            // è®¾ç½®æ€»é¡µæ•°ï¼ˆ+1å› ä¸ºæœ‰å°é¢ï¼‰
            document.getElementById('totalPages').textContent = totalPages + 1;
            switchToPage(1, false);
            console.log('âœ¨ ä¸¤ä¸ªé‡è¦æé™æ•™å­¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

            // ğŸš€ è‡ªåŠ¨å¯åŠ¨æ’­æ”¾ - å»¶è¿Ÿ3ç§’åè‡ªåŠ¨å¼€å§‹
            setTimeout(() => {
                console.log('ğŸš€ è‡ªåŠ¨å¯åŠ¨æ’­æ”¾...');
                startAutoPlay();
            }, 3000);
        });

        function switchToPage(pageNum, shouldSpeak = true) {
            if (pageNum < 1 || pageNum > totalPages + 1) return;
            currentPage = pageNum;
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            const activeSlide = document.querySelector(`[data-page="${pageNum}"]`);
            if (activeSlide) {
                activeSlide.style.display = 'grid';
                requestAnimationFrame(() => {
                    activeSlide.classList.add('active');
                    drawPageGraph(pageNum);
                    if(window.MathJax && typeof window.MathJax.typeset === 'function') {
                        window.MathJax.typeset();
                    }
                });
            }
            updatePageInfo();
            if (shouldSpeak && !isAutoPlaying) {
                speakContent(pageNum);
            }
        }

        // é™é»˜é¡µé¢åˆ‡æ¢ - ä¸æ’­æ”¾è¯­éŸ³,ä¸“ç”¨äºè‡ªåŠ¨æ’­æ”¾
        function switchToPageSilent(pageNum) {
            if (pageNum < 1 || pageNum > totalPages) {
                console.log(`âŒ é¡µé¢åˆ‡æ¢å¤±è´¥:é¡µç ${pageNum}è¶…å‡ºèŒƒå›´(1-${totalPages})`);
                return;
            }

            console.log(`ğŸ”„ å¼€å§‹åˆ‡æ¢åˆ°ç¬¬${pageNum}é¡µ...`);

            const allPages = document.querySelectorAll('.page');
            allPages.forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });

            const targetPage = document.querySelector(`[data-page="${pageNum}"]`);
            if (targetPage) {
                targetPage.style.display = 'grid';
                currentPage = pageNum;
                updatePageInfo();
                console.log(`âœ… æˆåŠŸåˆ‡æ¢åˆ°ç¬¬${pageNum}é¡µ`);

                targetPage.offsetHeight; // è§¦å‘é‡ç»˜

                setTimeout(() => {
                    targetPage.classList.add('active');
                    drawPageGraph(pageNum);
                    console.log(`ğŸ¨ ç¬¬${pageNum}é¡µå›¾åƒç»˜åˆ¶å®Œæˆ`);
                }, 300);
            } else {
                console.log(`âŒ æœªæ‰¾åˆ°ç¬¬${pageNum}é¡µçš„DOMå…ƒç´ `);
            }
        }

        function drawPageGraph(pageNum) {
            // å°é¢é¡µï¼ˆç¬¬1é¡µï¼‰ä¸éœ€è¦ç»˜åˆ¶å›¾åƒï¼Œå·²æœ‰é™æ€SVG
            if (pageNum === 1) {
                console.log('âœ… ç¬¬1é¡µæ˜¯å°é¢é¡µï¼Œè·³è¿‡å›¾åƒç»˜åˆ¶');
                return;
            }

            const svg = d3.select(`#viz-${pageNum}`);
            if (svg.empty()) {
                console.log(`âš ï¸ æœªæ‰¾åˆ°#viz-${pageNum}çš„SVGå…ƒç´ `);
                return;
            }

            svg.selectAll("*").remove();

            const container = svg.node().parentNode;
            const width = container.clientWidth;
            const height = container.clientHeight;
            svg.attr('viewBox', `0 0 ${width} ${height}`);

            switch(pageNum) {
                case 2: drawSinXOverXGraph(svg, width, height); break;
                case 3: drawGeneralSinGraph(svg, width, height); break;
                case 4: drawEGraph(svg, width, height); break;
                case 5: drawGeneralEGraph(svg, width, height); break;
                case 6: drawConclusionGraph1(svg, width, height); break;
                case 7: drawConclusionGraph2(svg, width, height); break;
            }
        }

        function drawIntroGraph(svg, width, height) {
            const lim1 = svg.append("foreignObject")
                .attr("x", width / 2 - 200)
                .attr("y", height / 2 - 100)
                .attr("width", 400)
                .attr("height", 60)
                .append("xhtml:div")
                .style("font-size", "22px")
                .style("color", "#81c784")
                .style("text-align", "center")
                .style("font-weight", "bold")
                .html("$ \\lim\\limits_{x \\to 0} \\frac{\\sin x}{x} = 1 $");

            const lim2 = svg.append("foreignObject")
                .attr("x", width / 2 - 200)
                .attr("y", height / 2 + 20)
                .attr("width", 400)
                .attr("height", 60)
                .append("xhtml:div")
                .style("font-size", "22px")
                .style("color", "#ffab40")
                .style("text-align", "center")
                .style("font-weight", "bold")
                .html("$ \\lim\\limits_{x \\to \\infty} \\left(1 + \\frac{1}{x}\\right)^x = e $");

            lim1.style("opacity", 0).transition().duration(1000).delay(500).style("opacity", 1);
            lim2.style("opacity", 0).transition().duration(1000).delay(1000).style("opacity", 1);
            setTimeout(() => { if(window.MathJax && typeof window.MathJax.typeset === 'function') window.MathJax.typeset(); }, 100);
        }

        function drawSinXOverXGraph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-6, 6]).range([0, w]);
            const y = d3.scaleLinear().domain([-0.5, 1.5]).range([h, 0]);

            // ç™½è‰²åæ ‡è½´
            const xAxis = g.append("g").attr("transform", `translate(0,${y(0)})`).call(d3.axisBottom(x));
            xAxis.selectAll("path, line").attr("stroke", "white").attr("stroke-width", 2);
            xAxis.selectAll("text").attr("fill", "white").attr("font-size", "14px");

            const yAxis = g.append("g").attr("transform", `translate(${x(0)},0)`).call(d3.axisLeft(y));
            yAxis.selectAll("path, line").attr("stroke", "white").attr("stroke-width", 2);
            yAxis.selectAll("text").attr("fill", "white").attr("font-size", "14px");

            // y=1çš„å‚è€ƒçº¿
            g.append("line").attr("x1", 0).attr("x2", w).attr("y1", y(1)).attr("y2", y(1))
                .attr("stroke", "#e1bee7").attr("stroke-width", 2).attr("stroke-dasharray", "5,5");
            g.append("text").attr("x", x(4.5)).attr("y", y(1.1)).text("y = 1")
                .attr("fill", "#e1bee7").attr("font-size", "16px");

            // sin(x)/xå‡½æ•°æ›²çº¿
            const func = d => d === 0 ? 1 : Math.sin(d) / d;
            const line = d3.line().x(d => x(d)).y(d => y(func(d)));
            g.append("path").datum(d3.range(-6, 6, 0.1).filter(d => Math.abs(d) > 0.01))
                .attr("fill", "none").attr("stroke", "#81c784").attr("stroke-width", 3).attr("d", line);

            // åœ¨x=0å¤„ç”»ä¸€ä¸ªç‰¹æ®Šç‚¹
            g.append("circle").attr("cx", x(0)).attr("cy", y(1)).attr("r", 6)
                .attr("fill", "#81c784").attr("stroke", "white").attr("stroke-width", 2);

            // åŠ¨ç”»ç‚¹
            const dot = g.append("circle").attr("r", 8).attr("fill", "#ffab40");

            function animate() {
                const startX = -5, endX = 5;
                const interpolator = d3.interpolate(startX, endX);
                dot.transition().duration(4000).ease(d3.easeCubicInOut)
                   .attrTween("cx", () => t => x(interpolator(t)))
                   .attrTween("cy", () => t => {
                       const currentX = interpolator(t);
                       return y(Math.abs(currentX) < 0.01 ? 1 : func(currentX));
                   })
                   .on("end", () => {
                       const backInterpolator = d3.interpolate(endX, startX);
                       dot.transition().duration(4000).ease(d3.easeCubicInOut)
                          .attrTween("cx", () => t => x(backInterpolator(t)))
                          .attrTween("cy", () => t => {
                              const currentX = backInterpolator(t);
                              return y(Math.abs(currentX) < 0.01 ? 1 : func(currentX));
                          })
                          .on("end", animate);
                   });
            }
            animate();
        }

        function drawGeneralSinGraph(svg, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;

            // æ›´å¤§æ›´æ¸…æ™°çš„æ¡†å’Œæ–‡å­—
            const box = svg.append("rect").attr("x", centerX - 120).attr("y", centerY - 180)
                .attr("width", 240).attr("height", 120).attr("fill", "#2d3748")
                .attr("stroke", "#ffab40").attr("stroke-width", 4).attr("rx", 8);
            const boxText = svg.append("text").attr("x", centerX).attr("y", centerY - 120)
                .text("Î”").attr("font-size", "64px").attr("fill", "#ffab40")
                .attr("text-anchor", "middle").attr("dominant-baseline", "middle")
                .attr("font-weight", "bold");

            // æ›´æ¸…æ™°çš„ç®­å¤´
            const arrow = svg.append("text").attr("x", centerX).attr("y", centerY - 30)
                .text("â†“").attr("font-size", "56px").attr("fill", "#ffffff")
                .attr("text-anchor", "middle").attr("font-weight", "bold");
            const zeroText = svg.append("text").attr("x", centerX).attr("y", centerY + 50)
                .text("0").attr("font-size", "64px").attr("fill", "#ffffff")
                .attr("text-anchor", "middle").attr("font-weight", "bold");

            // æ›´æ¸…æ™°çš„å…¬å¼
            const formula = svg.append("foreignObject").attr("x", 0).attr("y", centerY + 120)
                .attr("width", width).attr("height", 120)
                .append("xhtml:div").style("font-size", "42px").style("color", "#81c784")
                .style("text-align", "center").style("font-weight", "bold")
                .html("$ \\frac{\\sin(\\Delta)}{\\Delta} \\to 1 $");

            // åŠ¨ç”»åºåˆ—
            box.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            boxText.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            arrow.attr("opacity", 0).transition().delay(500).duration(1000).attr("opacity", 1);
            zeroText.attr("opacity", 0).transition().delay(1000).duration(1000).attr("opacity", 1);
            formula.style("opacity", 0).transition().delay(1500).duration(1000).style("opacity", 1);
            setTimeout(() => { if(window.MathJax && typeof window.MathJax.typeset === 'function') window.MathJax.typeset(); }, 100);
        }

        function drawEGraph(svg, width, height) {
            const margin = { top: 50, right: 50, bottom: 50, left: 60 };
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([0, 20]).range([0, w]);
            const y = d3.scaleLinear().domain([1, 3]).range([h, 0]);

            // ç™½è‰²åæ ‡è½´
            const xAxis = g.append("g").attr("transform", `translate(0,${y(1)})`).call(d3.axisBottom(x));
            xAxis.selectAll("path, line").attr("stroke", "white").attr("stroke-width", 2);
            xAxis.selectAll("text").attr("fill", "white").attr("font-size", "14px");

            const yAxis = g.append("g").call(d3.axisLeft(y));
            yAxis.selectAll("path, line").attr("stroke", "white").attr("stroke-width", 2);
            yAxis.selectAll("text").attr("fill", "white").attr("font-size", "14px");

            const e = Math.E;
            // y=eçš„å‚è€ƒçº¿
            g.append("line").attr("x1", 0).attr("x2", w).attr("y1", y(e)).attr("y2", y(e))
                .attr("stroke", "#e1bee7").attr("stroke-width", 2).attr("stroke-dasharray", "5,5");
            g.append("text").attr("x", x(12)).attr("y", y(e - 0.1)).text("y = e â‰ˆ 2.718")
                .attr("fill", "#e1bee7").attr("font-size", "16px");

            // (1+1/x)^xå‡½æ•°æ›²çº¿
            const func = d => Math.pow(1 + 1/d, d);
            const line = d3.line().x(d => x(d)).y(d => y(func(d)));
            g.append("path").datum(d3.range(0.5, 20, 0.2))
                .attr("fill", "none").attr("stroke", "#ffab40").attr("stroke-width", 3).attr("d", line);

            // åŠ¨ç”»ç‚¹
            const dot = g.append("circle").attr("r", 8).attr("fill", "#ffab40");

            function animate() {
                const startX = 1, endX = 20;
                const interpolator = d3.interpolate(startX, endX);
                dot.transition().duration(5000).ease(d3.easeLinear)
                   .attrTween("cx", () => t => x(interpolator(t)))
                   .attrTween("cy", () => t => y(func(interpolator(t))))
                   .on("end", () => {
                       const backInterpolator = d3.interpolate(endX, startX);
                       dot.transition().duration(3000).ease(d3.easeLinear)
                          .attrTween("cx", () => t => x(backInterpolator(t)))
                          .attrTween("cy", () => t => y(func(backInterpolator(t))))
                          .on("end", animate);
                   });
            }
            animate();
        }

        function drawGeneralEGraph(svg, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;

            // æ›´å¤§æ›´æ¸…æ™°çš„æ¡†å’Œæ–‡å­—
            const box = svg.append("rect").attr("x", centerX - 120).attr("y", centerY - 180)
                .attr("width", 240).attr("height", 120).attr("fill", "#2d3748")
                .attr("stroke", "#ffab40").attr("stroke-width", 4).attr("rx", 8);
            const boxText = svg.append("text").attr("x", centerX).attr("y", centerY - 120)
                .text("Î”").attr("font-size", "64px").attr("fill", "#ffab40")
                .attr("text-anchor", "middle").attr("dominant-baseline", "middle")
                .attr("font-weight", "bold");

            // æ›´æ¸…æ™°çš„ç®­å¤´
            const arrow = svg.append("text").attr("x", centerX).attr("y", centerY - 30)
                .text("â†“").attr("font-size", "56px").attr("fill", "#ffffff")
                .attr("text-anchor", "middle").attr("font-weight", "bold");
            const infText = svg.append("text").attr("x", centerX).attr("y", centerY + 50)
                .text("âˆ").attr("font-size", "64px").attr("fill", "#ffffff")
                .attr("text-anchor", "middle").attr("font-weight", "bold");

            // æ›´æ¸…æ™°çš„å…¬å¼
            const formula = svg.append("foreignObject").attr("x", 0).attr("y", centerY + 120)
                .attr("width", width).attr("height", 120)
                .append("xhtml:div").style("font-size", "36px").style("color", "#ffab40")
                .style("text-align", "center").style("font-weight", "bold")
                .html("$ \\left(1 + \\frac{1}{\\Delta}\\right)^{\\Delta} \\to e $");

            // åŠ¨ç”»åºåˆ—
            box.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            boxText.attr("opacity", 0).transition().duration(1000).attr("opacity", 1);
            arrow.attr("opacity", 0).transition().delay(500).duration(1000).attr("opacity", 1);
            infText.attr("opacity", 0).transition().delay(1000).duration(1000).attr("opacity", 1);
            formula.style("opacity", 0).transition().delay(1500).duration(1000).style("opacity", 1);
            setTimeout(() => { if(window.MathJax && typeof window.MathJax.typeset === 'function') window.MathJax.typeset(); }, 100);
        }

        function drawConclusionGraph1(svg, width, height) {
             const g = svg.append("g").attr("transform", `translate(${width/2}, ${height/2})`);
             const text = g.append("foreignObject").attr("x", -width/2).attr("y", -80)
                .attr("width", width).attr("height", 160)
                .append("xhtml:div").style("font-size", "32px").style("color", "#81c784")
                .style("text-align", "center").style("font-weight", "bold")
                .html("$ \\lim\\limits_{\\Delta \\to 0} \\frac{\\sin(\\Delta)}{\\Delta} = 1 $");
             setTimeout(() => { if(window.MathJax && typeof window.MathJax.typeset === 'function') window.MathJax.typeset(); }, 100);
             text.style("opacity", 0).transition().duration(1000).style("opacity", 1);
        }

        function drawConclusionGraph2(svg, width, height) {
             const g = svg.append("g").attr("transform", `translate(${width/2}, ${height/2})`);
             const text = g.append("foreignObject").attr("x", -width/2).attr("y", -80)
                .attr("width", width).attr("height", 160)
                .append("xhtml:div").style("font-size", "32px").style("color", "#ffab40")
                .style("text-align", "center").style("font-weight", "bold")
                .html("$ \\lim\\limits_{\\Delta \\to \\infty} \\left(1 + \\frac{1}{\\Delta}\\right)^{\\Delta} = e $");
             setTimeout(() => { if(window.MathJax && typeof window.MathJax.typeset === 'function') window.MathJax.typeset(); }, 100);
             text.style("opacity", 0).transition().duration(1000).style("opacity", 1);
        }

        // è™šæ‹Ÿäººæ§åˆ¶ - ä½¿ç”¨æ­£ç¡®çš„é…ç½®
        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = 'ğŸ”„ å¯åŠ¨ä¸­...';
            startBtn.disabled = true;

            try {
                console.log('â³ ç­‰å¾…SDKæ¨¡å—åŠ è½½...');
                updateStatus('ç­‰å¾…SDKåŠ è½½...', 'connecting');
                await waitForSDK();

                console.log('âœ… è®¯é£å®˜æ–¹SDKå·²åŠ è½½');
                updateStatus('SDKå·²åŠ è½½', 'connecting');

                if(avatarPlatform) {
                    avatarPlatform.destroy();
                }

                // åˆ›å»ºè™šæ‹Ÿäººå®ä¾‹
                avatarPlatform = new AvatarPlatform({
                    useInlinePlayer: true
                });

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                avatarPlatform
                    .on('connected', (initResp) => {
                        console.log('ğŸ‰ è™šæ‹Ÿäººè¿æ¥æˆåŠŸ!', initResp);
                        isConnected = true;
                        isTeaching = true;
                        updateStatus('å·²è¿æ¥', 'connected');
                        startBtn.textContent = 'ğŸ’– è™šæ‹Ÿäººå·²å°±ç»ª';
                        startBtn.disabled = false;

                        setTimeout(() => {
                            speakContent(1);
                        }, 1000);
                    })
                    .on('disconnected', (err) => {
                        console.log('ğŸ”Œ è™šæ‹Ÿäººè¿æ¥æ–­å¼€');
                        isConnected = false;
                        isTeaching = false;
                        updateStatus('è¿æ¥æ–­å¼€', 'error');
                        startBtn.textContent = 'ğŸ€ å¼€å§‹è®²è¯¾';
                        startBtn.disabled = false;
                        if (err) {
                            console.error('âŒ è¿æ¥å¼‚å¸¸æ–­å¼€:', err);
                        }
                    })
                    .on('error', (error) => {
                        console.error('âŒ è™šæ‹Ÿäººé”™è¯¯:', error);
                        updateStatus('é”™è¯¯: ' + error.message, 'error');
                        startBtn.textContent = 'âŒ è¿æ¥å¤±è´¥';
                        startBtn.disabled = false;
                        isTeaching = false;
                        isConnected = false;
                    });

                // ä½¿ç”¨æ­£ç¡®çš„APIé…ç½®
                avatarPlatform.setApiInfo({
                    appId: 'e8c180ed',                                    // æ•°å­¦è®²è§£ AppID
                    apiKey: 'e0c44f0e2ef0f47582ffa7e864da0d9b',             // æ•°å­¦è®²è§£ APIå¯†é’¥
                    apiSecret: 'MDZkNDNiZWU4NDkzNWM5MDQzMTY4N2Nh',       // æ•°å­¦è®²è§£ APIå¯†é’¥
                    sceneId: '237415046114840576',                       // æ•°å­¦è®²è§£ åœºæ™¯ID
                    serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact'
                });

                // ä½¿ç”¨æ­£ç¡®çš„å…¨å±€å‚æ•°
                avatarPlatform.setGlobalParams({
                    stream: {
                        protocol: 'xrtc',
                        alpha: 1,
                        bitrate: 1000000,
                        fps: 25
                    },
                    avatar: {
                        avatar_id: '110332017',
                        width: 1920,
                        height: 1080,
                        scale: 1,
                        move_h: 0,
                        move_v: 0,
                        audio_format: 1
                    },
                    tts: {
                        vcn: 'x4_yiting',
                        speed: 50,
                        pitch: 50,
                        volume: 100
                    },
                    avatar_dispatch: {
                        interactive_mode: 1,
                        content_analysis: 0
                    }
                });

                // å¯åŠ¨è™šæ‹Ÿäºº
                await avatarPlatform.start({
                    wrapper: document.getElementById('avatarWrapper')
                });

                console.log('ğŸ“ è™šæ‹Ÿäººæ•™å­¦ç³»ç»Ÿå¯åŠ¨å®Œæˆ');

            } catch (error) {
                console.error('âŒ å¯åŠ¨å¤±è´¥:', error);
                updateStatus('å¯åŠ¨å¤±è´¥', 'error');
                startBtn.textContent = 'ğŸ”„ é‡è¯•';
                startBtn.disabled = false;

                alert(`å¯åŠ¨å¤±è´¥:${error.message}\n\nè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`);
            }
        }

        // åŠ¨ä½œæ‰§è¡Œ
        async function performVirtualAction(actionId) {
            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('âš ï¸ è™šæ‹Ÿäººæœªè¿æ¥,è·³è¿‡åŠ¨ä½œæ‰§è¡Œ');
                return;
            }

            try {
                await avatarPlatform.writeCmd("action", actionId);
                console.log(`âœ… æ‰§è¡ŒåŠ¨ä½œ: ${actionId}`);
            } catch (error) {
                console.error(`âŒ åŠ¨ä½œæ‰§è¡Œå¤±è´¥ (${actionId}):`, error);
            }
        }

        // åŠ¨ä½œæ˜ å°„
        function getActionsForPage(pageNum) {
            const actionMap = {
                1: 'A_RLH_welcome_O',
                2: 'A_LH_introduced_O',
                3: 'A_RH_please1_O',
                4: 'A_RLH_emphasize_O',
                5: 'A_U_No_pointing_O',
                6: 'A_RLH_welcome_O',
                7: 'A_RH_please1_O'
            };
            return actionMap[pageNum];
        }

        // è¯­éŸ³æ’­æ”¾
        async function speakContent(pageNum) {
            console.log(`ğŸ” æ£€æŸ¥æ’­æ”¾æ¡ä»¶: isTeaching=${isTeaching}, isConnected=${isConnected}, avatarPlatform=${!!avatarPlatform}`);

            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('âš ï¸ è™šæ‹Ÿäººæœªè¿æ¥æˆ–æœªå¼€å§‹æ•™å­¦,è·³è¿‡è¯­éŸ³æ’­æŠ¥');
                return;
            }

            const content = subtitleScript[pageNum];
            if (!content) return;

            try {
                // å…ˆæ‰§è¡ŒåŠ¨ä½œ
                const actionId = getActionsForPage(pageNum);
                if (actionId) {
                    await performVirtualAction(actionId);
                }

                // ç„¶åæ’­æ”¾è¯­éŸ³å†…å®¹
                await avatarPlatform.writeText(content, {
                    nlp: false
                });

                console.log(`âœ… è™šæ‹Ÿäººè®²è§£ç¬¬${pageNum}é¡µ,åŠ¨ä½œ: ${actionId}`);

                // æ›´æ–°å­—å¹•æ˜¾ç¤º
                updateSubtitle(content);
            } catch (error) {
                console.error('âŒ è™šæ‹Ÿäººè®²è§£å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å­—å¹•æ˜¾ç¤º
        function updateSubtitle(text) {
            const subtitleArea = document.getElementById('subtitleArea');
            if (subtitleArea) {
                subtitleArea.textContent = text;
            }
        }

        // é¡µé¢æ§åˆ¶å‡½æ•°
        function nextPage() {
            if (currentPage < totalPages) {
                switchToPage(currentPage + 1);
            }
        }
        function previousPage() {
            if (currentPage > 1) {
                switchToPage(currentPage - 1);
            }
        }
        function restart() { switchToPage(1); }
        function updatePageInfo() {
            document.getElementById('currentPage').textContent = currentPage;
        }

        // è·å–é¡µé¢æ ‡é¢˜
        function getPageTitle(pageNum) {
            return boardContent[pageNum - 1]?.title || `ç¬¬${pageNum}é¡µ`;
        }

        // è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
        let isAutoPlaying = false;
        async function startAutoPlay() {
            if (isAutoPlaying) {
                stopAutoPlay();
                return;
            }

            try {
                console.log('ğŸ¬ å¼€å§‹è‡ªåŠ¨æ’­æ”¾å®Œæ•´è¯¾ç¨‹...');
                isAutoPlaying = true;

                const autoPlayBtn = document.getElementById('autoPlayBtn');
                autoPlayBtn.textContent = 'â¹ï¸ åœæ­¢æ’­æ”¾';
                autoPlayBtn.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';

                updateStatus(`ğŸ¬ è‡ªåŠ¨æ’­æ”¾å°†åœ¨ 1 ç§’åå¼€å§‹,è¯·å‡†å¤‡å½•å±!`, 'connecting');
                await new Promise(resolve => setTimeout(resolve, 1000));

                updateStatus('ğŸ¬ è‡ªåŠ¨æ’­æ”¾å¼€å§‹!', 'connected');
                document.body.classList.add('recording-mode');

                // å¦‚æœè™šæ‹Ÿäººæœªè¿æ¥,åœ¨åå°å°è¯•è¿æ¥
                if (!avatarPlatform || !isConnected) {
                    console.log('ğŸ¬ å¯åŠ¨è™šæ‹Ÿäºº...');
                    await startTeaching();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                // é€é¡µæ’­æ”¾
                for (let page = 1; page <= totalPages; page++) {
                    try {
                        if (!isAutoPlaying) break;

                        console.log(`\nğŸ¬ === å¼€å§‹æ’­æ”¾ç¬¬${page}é¡µ/${totalPages}é¡µ ===`);

                        switchToPageSilent(page);
                        updateStatus(`ğŸ“– ç¬¬${page}é¡µ/${totalPages}é¡µ - ${getPageTitle(page)}`, 'connected');

                        await new Promise(resolve => setTimeout(resolve, 800));

                        if (isConnected && isTeaching && avatarPlatform) {
                            console.log(`ğŸµ æ’­æ”¾ç¬¬${page}é¡µè¯­éŸ³...`);
                            try {
                                await speakContent(page);
                                const pageTime = autoPlayDurations[page];
                                await new Promise(resolve => setTimeout(resolve, pageTime));
                            } catch (error) {
                                console.error(`âŒ ç¬¬${page}é¡µè¯­éŸ³æ’­æ”¾å¤±è´¥:`, error);
                                const pageTime = autoPlayDurations[page];
                                await new Promise(resolve => setTimeout(resolve, pageTime));
                            }
                        } else {
                            const pageTime = autoPlayDurations[page];
                            await new Promise(resolve => setTimeout(resolve, pageTime));
                        }

                        const waitTime = page === totalPages ? 2000 : 1000;
                        await new Promise(resolve => setTimeout(resolve, waitTime));

                    } catch (error) {
                        console.error(`âŒ ç¬¬${page}é¡µæ’­æ”¾è¿‡ç¨‹å‡ºé”™:`, error);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }

                if (isAutoPlaying) {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    stopAutoPlay();
                }

            } catch (error) {
                console.error('âŒ è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
                updateStatus('è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                stopAutoPlay();
            }
        }

        function stopAutoPlay() {
            if (isAutoPlaying) {
                isAutoPlaying = false;
                window.playbackFinished = true;
                document.title = "PLAYBACK_FINISHED";
                console.log('ğŸ‰ æ’­æ”¾å®Œæˆï¼å·²ä¿®æ”¹æ ‡é¢˜ä¸º PLAYBACK_FINISHED');
                document.body.classList.remove('recording-mode');

                const autoPlayBtn = document.getElementById('autoPlayBtn');
                autoPlayBtn.textContent = 'ğŸ¬ è‡ªåŠ¨æ’­æ”¾';
                autoPlayBtn.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';

                console.log('â¹ï¸ è‡ªåŠ¨æ’­æ”¾å·²åœæ­¢');
                updateStatus('è‡ªåŠ¨æ’­æ”¾å·²åœæ­¢', 'normal');
            }
        }

        // é¡µé¢å…³é—­æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (isAutoPlaying) {
                stopAutoPlay();
            }

            if (avatarPlatform && isConnected) {
                avatarPlatform.stop();
            }
        });
  </script>
</body>
</html>
