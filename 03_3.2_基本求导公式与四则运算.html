<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, initial-scale=1.0">
    <title>03_3.2_基本求导公式与四则运算</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            svg: { fontCache: 'global' },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('✅ MathJax已加载');
                    });
                }
            }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Noto Serif SC', serif; background: #1a1a2e; overflow: hidden; height: 100vh; width: 100vw; }
        .blackboard { width: 100vw; height: 100vh; background: #1a1a2e; position: relative; border: 10px solid #795548; margin: 0; }

        .avatar-container {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 975px;
            height: 1105px;
            overflow: hidden;
            z-index: 50;
            pointer-events: none;
            background: transparent;
        }

        .wrapper { width: 100%; height: 100%; background: transparent; pointer-events: auto; }

        .slide-container { width: 100%; height: 100%; position: relative; }
        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background-color: transparent;
        }
        .slide.active { opacity: 1; visibility: visible; }

        .slide-content { display: flex; flex-direction: row; gap: 2rem; width: 100%; height: 95%; }

        .chalkboard {
            flex: 0 0 45%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }

        .chalkboard h2 {
            color: #f1c40f;
            border-bottom: 2px solid #f39c12;
            font-size: 28px;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .chalkboard h3 {
            color: #1abc9c;
            font-size: 22px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .chalkboard p, .chalkboard li {
            color: #e0e0e0;
            font-size: 18px;
            line-height: 1.8;
            margin: 8px 0;
        }

        .chalkboard strong { color: #e74c3c; }

        .math-formula {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
            font-size: 20px;
            color: #1abc9c;
            text-align: center;
            margin: 15px 0;
        }

        .visualization {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .control-bar {
            position: fixed;
            left: -9999px;
            top: 50%;
            transform: translateY(-50%);
            width: 270px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 200;
            border-radius: 0 20px 20px 0;
            padding: 25px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn {
            padding: 14px 22px;
            background: rgba(255, 255, 255, 0.25);
            color: #333;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            text-align: center;
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .subtitle-area {
            position: absolute;
            bottom: 20px;
            left: 50px;
            right: 50px;
            min-height: 50px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            color: white;
            font-size: 23px;
            text-align: center;
            padding: 15px 20px;
            line-height: 1.4;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 5px;
            font-size: 16px;
            z-index: 100;
            display: none;
        }

        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); display: block; }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); display: block; }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); display: block; }
    </style>
</head>
<body class="blackboard">
    <div class="status-indicator" id="statusIndicator">等待连接</div>

    <div class="avatar-container">
        <div class="wrapper" id="avatarWrapper"></div>
    </div>

    <div class="slide-container">
        <!-- 第1页：引入 - 为什么需要求导公式 -->
        <div class="slide active">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>为什么需要求导公式?</h2>
                    <p>上节课我们学习了导数的<strong>定义</strong>:</p>
                    <div class="math-formula">
                        $$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$
                    </div>
                    <p>但是,如果每次都用定义来求导...</p>
                    <h3>问题来了!</h3>
                    <p>对于 $f(x) = x^{100}$,用定义求导需要展开:</p>
                    <div class="math-formula">
                        $(x+h)^{100} = x^{100} + 100x^{99}h + \\cdots$
                    </div>
                    <p><strong>太慢了!</strong> 我们需要更高效的方法 — 求导公式!</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#f39c12;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <!-- 复杂计算示意 -->
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">用定义太慢...</text>

                        <circle cx="150" cy="200" r="40" fill="none" stroke="#e74c3c" stroke-width="3">
                            <animate attributeName="r" dur="2s" values="40;50;40" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="210">(x+h)^100</text>

                        <text fill="#f39c12" font-size="60" text-anchor="middle" x="300" y="220">→</text>

                        <circle cx="450" cy="200" r="40" fill="none" stroke="#2ecc71" stroke-width="3">
                            <animate attributeName="r" dur="2s" values="40;50;40" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="450" y="210">公式</text>

                        <text fill="#3498db" font-size="24" text-anchor="middle" x="300" y="350">需要更高效的工具!</text>

                        <path d="M 100 400 Q 200 350 500 400" fill="none" stroke="url(#grad1)" stroke-width="4">
                            <animate attributeName="d" dur="3s"
                                values="M 100 400 Q 200 350 500 400;
                                        M 100 400 Q 200 420 500 400;
                                        M 100 400 Q 200 350 500 400"
                                repeatCount="indefinite"/>
                        </path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第2页:幂函数求导公式 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>基础公式一:幂函数</h2>
                    <h3>核心公式</h3>
                    <div class="math-formula">
                        $$(x^n)' = nx^{n-1}$$
                    </div>
                    <p><strong>记忆方法:</strong> 指数变成系数,指数减1</p>

                    <h3>特殊情况</h3>
                    <ul style="margin-left: 30px;">
                        <li>常数: $(C)' = 0$ (不变的东西导数为0)</li>
                        <li>$x$: $(x)' = 1$</li>
                        <li>$x^2$: $(x^2)' = 2x$</li>
                        <li>$x^3$: $(x^3)' = 3x^2$</li>
                        <li>$\\frac{1}{x} = x^{-1}$: $(\\frac{1}{x})' = -\\frac{1}{x^2}$</li>
                    </ul>

                    <p style="margin-top: 20px;"><strong>推广:</strong> 对所有实数 $n$ 都成立!</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">幂函数求导规律</text>

                        <!-- 动画演示 x^3 的导数 -->
                        <g opacity="0">
                            <rect x="100" y="100" width="400" height="80" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="2" rx="10"/>
                            <text fill="#ecf0f1" font-size="24" x="150" y="145">x³ → 3x²</text>
                            <animate attributeName="opacity" dur="8s" values="0;1;1;1;1" repeatCount="indefinite"/>
                        </g>

                        <g opacity="0">
                            <circle cx="200" cy="140" r="15" fill="#e74c3c"/>
                            <text fill="#fff" font-size="14" text-anchor="middle" x="200" y="145">3</text>
                            <text fill="#f39c12" font-size="16" x="220" y="145">指数下来</text>
                            <animate attributeName="opacity" dur="8s" values="0;0;1;1;1" repeatCount="indefinite"/>
                        </g>

                        <g opacity="0">
                            <rect x="100" y="220" width="400" height="80" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="10"/>
                            <text fill="#ecf0f1" font-size="24" x="150" y="265">x⁴ → 4x³</text>
                            <animate attributeName="opacity" dur="8s" values="0;0;0;1;1" repeatCount="indefinite"/>
                        </g>

                        <g opacity="0">
                            <rect x="100" y="340" width="400" height="80" fill="rgba(155,89,182,0.1)" stroke="#9b59b6" stroke-width="2" rx="10"/>
                            <text fill="#ecf0f1" font-size="24" x="150" y="385">1/x → -1/x²</text>
                            <animate attributeName="opacity" dur="8s" values="0;0;0;0;1" repeatCount="indefinite"/>
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第3页:指数与对数函数 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>基础公式二:指数与对数</h2>
                    <h3>指数函数</h3>
                    <div class="math-formula">
                        $$(e^x)' = e^x$$
                    </div>
                    <p><strong>惊人的性质:</strong> $e^x$ 的导数还是自己!</p>
                    <div class="math-formula">
                        $$(a^x)' = a^x \\ln a$$
                    </div>

                    <h3>对数函数</h3>
                    <div class="math-formula">
                        $$(\\ln x)' = \\frac{1}{x}$$
                    </div>
                    <p><strong>几何意义:</strong> $\\ln x$ 的切线斜率 = $\\frac{1}{x}$</p>
                    <div class="math-formula">
                        $$(\\log_a x)' = \\frac{1}{x \\ln a}$$
                    </div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <defs>
                            <linearGradient id="grad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2ecc71;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="60">e^x 的神奇性质</text>

                        <!-- 坐标系 -->
                        <line x1="100" y1="350" x2="500" y2="350" stroke="#ecf0f1" stroke-width="2"/>
                        <line x1="150" y1="100" x2="150" y2="400" stroke="#ecf0f1" stroke-width="2"/>

                        <!-- e^x 曲线 -->
                        <path d="M 150 350 Q 250 250 350 150 Q 400 100 450 80"
                              fill="none" stroke="url(#grad2)" stroke-width="3">
                            <animate attributeName="opacity" dur="2s" values="0;1;1" repeatCount="indefinite"/>
                        </path>

                        <!-- 标注 -->
                        <text fill="#3498db" font-size="18" x="380" y="120">y = e^x</text>
                        <text fill="#2ecc71" font-size="18" x="380" y="150">y' = e^x</text>

                        <circle cx="300" cy="200" r="8" fill="#e74c3c">
                            <animate attributeName="r" dur="2s" values="8;12;8" repeatCount="indefinite"/>
                        </circle>

                        <text fill="#f39c12" font-size="20" text-anchor="middle" x="300" y="450">导数 = 原函数!</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第4页:三角函数求导 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>基础公式三:三角函数</h2>
                    <h3>核心公式</h3>
                    <div class="math-formula">
                        $$(\\sin x)' = \\cos x$$
                    </div>
                    <div class="math-formula">
                        $$(\\cos x)' = -\\sin x$$
                    </div>
                    <p><strong>记忆技巧:</strong> sin → cos (正变余)</p>
                    <p style="margin-left: 30px;">cos → -sin (余变负正)</p>

                    <h3>其他三角函数</h3>
                    <div class="math-formula">
                        $$(\\tan x)' = \\sec^2 x = \\frac{1}{\\cos^2 x}$$
                    </div>
                    <p style="color: #95a5a6; font-size: 16px;">提示: tan = sin/cos,用除法法则可推导</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">三角函数导数关系</text>

                        <!-- sin x 和 cos x 的关系 -->
                        <circle cx="200" cy="200" r="70" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="200" y="205">sin x</text>

                        <line x1="270" y1="200" x2="330" y2="200" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                        <text fill="#f39c12" font-size="18" text-anchor="middle" x="300" y="180">求导</text>

                        <circle cx="400" cy="200" r="70" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="400" y="205">cos x</text>

                        <!-- cos x 到 -sin x -->
                        <line x1="400" y1="270" x2="400" y2="330" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                        <text fill="#f39c12" font-size="18" x="410" y="305">求导</text>

                        <circle cx="400" cy="400" r="70" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="400" y="405">-sin x</text>

                        <!-- -sin x 到 -cos x -->
                        <line x1="330" y1="400" x2="270" y2="400" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                        <text fill="#f39c12" font-size="18" text-anchor="middle" x="300" y="420">求导</text>

                        <circle cx="200" cy="400" r="70" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="200" y="405">-cos x</text>

                        <!-- -cos x 回到 sin x -->
                        <line x1="200" y1="330" x2="200" y2="270" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow)"/>
                        <text fill="#f39c12" font-size="18" x="210" y="305">求导</text>

                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第5页:四则运算法则 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>求导的四则运算法则</h2>
                    <h3>1. 线性性质(和差法则)</h3>
                    <div class="math-formula">
                        $$(af(x) \\pm bg(x))' = af'(x) \\pm bg'(x)$$
                    </div>
                    <p>常数可以提取,和差分别求导</p>

                    <h3>2. 乘法法则</h3>
                    <div class="math-formula">
                        $$(f \\cdot g)' = f' \\cdot g + f \\cdot g'$$
                    </div>
                    <p><strong>口诀:</strong> "前导后不导 + 前不导后导"</p>

                    <h3>3. 除法法则</h3>
                    <div class="math-formula">
                        $$\\left(\\frac{f}{g}\\right)' = \\frac{f' \\cdot g - f \\cdot g'}{g^2}$$
                    </div>
                    <p><strong>注意:</strong> 分母要平方! 分子是"上导下 - 上下导"</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">乘法法则图解</text>

                        <!-- f 和 g -->
                        <rect x="100" y="100" width="150" height="60" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="175" y="135">f</text>

                        <rect x="350" y="100" width="150" height="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="425" y="135">g</text>

                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="140">×</text>

                        <!-- 求导箭头 -->
                        <line x1="175" y1="160" x2="175" y2="220" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow2)"/>
                        <line x1="425" y1="160" x2="425" y2="220" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow2)"/>

                        <!-- 结果 -->
                        <rect x="75" y="240" width="200" height="70" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="175" y="280">f' · g</text>

                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="280">+</text>

                        <rect x="325" y="240" width="200" height="70" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="425" y="280">f · g'</text>

                        <!-- 最终结果 -->
                        <rect x="150" y="350" width="300" height="80" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="395">(f · g)' = f'g + fg'</text>

                        <defs>
                            <marker id="arrow2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第6页:综合练习1 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>综合练习 1</h2>
                    <h3>例题1: 乘法法则</h3>
                    <p>求 $y = x^2 \\cdot e^x$ 的导数</p>

                    <p style="margin-top: 15px;"><strong>解:</strong> 使用乘法法则 $(fg)' = f'g + fg'$</p>
                    <p style="margin-left: 30px;">令 $f = x^2$, $g = e^x$</p>
                    <p style="margin-left: 30px;">则 $f' = 2x$, $g' = e^x$</p>

                    <div class="math-formula">
                        $$y' = 2x \\cdot e^x + x^2 \\cdot e^x = (2x + x^2)e^x$$
                    </div>

                    <h3 style="margin-top: 25px;">例题2: 除法法则</h3>
                    <p>求 $y = \\frac{\\sin x}{x}$ 的导数</p>

                    <p style="margin-top: 15px;"><strong>解:</strong> 使用除法法则</p>
                    <div class="math-formula">
                        $$y' = \\frac{\\cos x \\cdot x - \\sin x \\cdot 1}{x^2} = \\frac{x\\cos x - \\sin x}{x^2}$$
                    </div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">例题1 演算过程</text>

                        <!-- 步骤展示 -->
                        <g opacity="0">
                            <rect x="80" y="100" width="440" height="60" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="20" x="100" y="135">y = x² · e^x</text>
                            <animate attributeName="opacity" dur="10s" values="0;1;1;1;1;1" repeatCount="indefinite"/>
                        </g>

                        <g opacity="0">
                            <rect x="80" y="180" width="440" height="60" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="20" x="100" y="215">f' · g = 2x · e^x</text>
                            <animate attributeName="opacity" dur="10s" values="0;0;1;1;1;1" repeatCount="indefinite"/>
                        </g>

                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="275" opacity="0">
                            +
                            <animate attributeName="opacity" dur="10s" values="0;0;0;1;1;1" repeatCount="indefinite"/>
                        </text>

                        <g opacity="0">
                            <rect x="80" y="290" width="440" height="60" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="20" x="100" y="325">f · g' = x² · e^x</text>
                            <animate attributeName="opacity" dur="10s" values="0;0;0;1;1;1" repeatCount="indefinite"/>
                        </g>

                        <line x1="100" y1="370" x2="500" y2="370" stroke="#f39c12" stroke-width="2" opacity="0">
                            <animate attributeName="opacity" dur="10s" values="0;0;0;0;1;1" repeatCount="indefinite"/>
                        </line>

                        <g opacity="0">
                            <rect x="80" y="390" width="440" height="70" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="3" rx="8"/>
                            <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="435">y' = (2x + x²)e^x</text>
                            <animate attributeName="opacity" dur="10s" values="0;0;0;0;0;1" repeatCount="indefinite"/>
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第7页:综合练习2 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>综合练习 2</h2>
                    <h3>例题3: 综合应用</h3>
                    <p>求 $y = \\frac{\\ln x}{x^2}$ 的导数</p>

                    <p style="margin-top: 15px;"><strong>解:</strong> 使用除法法则</p>
                    <p style="margin-left: 30px;">$f = \\ln x$, $f' = \\frac{1}{x}$</p>
                    <p style="margin-left: 30px;">$g = x^2$, $g' = 2x$</p>

                    <div class="math-formula">
                        $$y' = \\frac{\\frac{1}{x} \\cdot x^2 - \\ln x \\cdot 2x}{(x^2)^2} = \\frac{x - 2x\\ln x}{x^4}$$
                    </div>

                    <div class="math-formula">
                        $$= \\frac{1 - 2\\ln x}{x^3}$$
                    </div>

                    <p style="margin-top: 20px; color: #95a5a6;"><strong>技巧:</strong> 化简时约掉公因子 $x$</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">除法法则记忆</text>

                        <rect x="150" y="100" width="300" height="80" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="150">
                            <tspan x="300">f</tspan>
                            <tspan dy="-10" font-size="18">─</tspan>
                        </text>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="170">g</text>

                        <line x1="300" y1="180" x2="300" y2="240" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow3)"/>
                        <text fill="#f39c12" font-size="18" x="310" y="215">求导</text>

                        <rect x="100" y="260" width="400" height="150" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="300">
                            <tspan x="300">f'g - fg'</tspan>
                            <tspan dy="-8" font-size="18">─────</tspan>
                        </text>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="330">g²</text>

                        <text fill="#e74c3c" font-size="18" x="120" y="370">↑</text>
                        <text fill="#e74c3c" font-size="16" x="135" y="370">上导下</text>

                        <text fill="#e74c3c" font-size="18" x="220" y="370">-</text>

                        <text fill="#e74c3c" font-size="18" x="250" y="370">↑</text>
                        <text fill="#e74c3c" font-size="16" x="265" y="370">上下导</text>

                        <text fill="#f39c12" font-size="18" text-anchor="middle" x="300" y="395">分母平方!</text>

                        <defs>
                            <marker id="arrow3" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第8页:总结 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>本节总结</h2>
                    <h3>基本公式(必须记住!)</h3>
                    <ul style="margin-left: 30px;">
                        <li>$(x^n)' = nx^{n-1}$</li>
                        <li>$(e^x)' = e^x$, $(a^x)' = a^x \\ln a$</li>
                        <li>$(\\ln x)' = \\frac{1}{x}$</li>
                        <li>$(\\sin x)' = \\cos x$, $(\\cos x)' = -\\sin x$</li>
                    </ul>

                    <h3 style="margin-top: 20px;">四则运算法则</h3>
                    <ul style="margin-left: 30px;">
                        <li>$(af \\pm bg)' = af' \\pm bg'$ (线性)</li>
                        <li>$(fg)' = f'g + fg'$ (乘法)</li>
                        <li>$(\\frac{f}{g})' = \\frac{f'g - fg'}{g^2}$ (除法)</li>
                    </ul>

                    <p style="margin-top: 25px; color: #f39c12;"><strong>下节预告:</strong></p>
                    <p>链式法则 — 复合函数求导的利器!</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">公式全家福</text>

                        <circle cx="150" cy="200" r="60" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="205">幂函数</text>

                        <circle cx="450" cy="200" r="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="450" y="205">指对数</text>

                        <circle cx="150" cy="380" r="60" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="1s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="385">三角</text>

                        <circle cx="450" cy="380" r="60" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="1.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="450" y="385">四则</text>

                        <circle cx="300" cy="290" r="80" fill="rgba(241,196,15,0.3)" stroke="#f39c12" stroke-width="4">
                            <animate attributeName="r" dur="3s" values="80;90;80" repeatCount="indefinite" begin="2s"/>
                        </circle>
                        <text fill="#f1c40f" font-size="22" text-anchor="middle" x="300" y="295">导数</text>
                        <text fill="#f1c40f" font-size="22" text-anchor="middle" x="300" y="320">工具箱</text>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div class="subtitle-area" id="subtitleArea">
        欢迎学习基本求导公式与四则运算!点击开始讲课启动虚拟人讲师。
    </div>

    <div class="control-bar">
        <div style="color: #f1c40f; font-weight: bold; margin-bottom: 15px; text-align: center;">
            第 <span id="currentSlide">1</span> / <span id="totalSlides">8</span> 页
        </div>
        <button class="btn" id="prevBtn" onclick="previousSlide()">⬅️ 上一页</button>
        <button class="btn primary" id="startBtn" onclick="startTeaching()">🎀 开始讲课</button>
        <button class="btn" id="nextBtn" onclick="nextSlide()">下一页 ➡️</button>
        <button class="btn" onclick="restart()">🔄 重新开始</button>
        <button class="btn" id="autoPlayBtn" onclick="startAutoPlay()">🎬 自动播放</button>
    </div>

    <script type="module">
        window.playbackFinished = false;

        try {
            const { default: AvatarPlatform, SDKEvents, PlayerEvents, RecorderEvents, UserMedia } = await import('./avatar-sdk-web_3.1.2.1002/index.js');
            window.AvatarPlatform = AvatarPlatform;
            window.SDKEvents = SDKEvents;
            window.PlayerEvents = PlayerEvents;
            window.RecorderEvents = RecorderEvents;
            window.UserMedia = UserMedia;
            console.log('✅ 讯飞SDK模块已加载');
        } catch (error) {
            console.error('❌ SDK加载失败:', error);
        }
        window.dispatchEvent(new CustomEvent('sdkReady'));
    </script>

    <script>
        const lessonTitle = "基本求导公式与四则运算";

        const subtitleScript = {
            "1": "同学们好!上节课我们学习了导数的定义:f撇x等于当h趋于0时,f括号x加h减f括号x,全部除以h的极限。但是如果每次都用定义来求导,会非常复杂!比如要求x的100次方的导数,就要展开括号x加h的100次方,这需要用二项式定理,计算量巨大!所以我们迫切需要更高效的方法,这就是今天要学习的基本求导公式。有了这些公式,求导就像查表一样简单快捷!",
            "2": "首先来看幂函数的求导公式。这是最基础也是最重要的公式:x的n次方求导,等于n乘以x的n减1次方。记忆方法很简单:把指数n拿下来作为系数,然后指数减1。让我们看几个例子。常数C的导数是0,因为常数不变化。x的导数是1,可以看作x的1次方,指数1下来,x的0次方等于1。x平方的导数是2x,x立方的导数是3x平方。特别注意,这个公式对所有实数n都成立!比如1除以x可以写成x的负1次方,导数就是负1乘以x的负2次方,也就是负的1除以x平方。根号x是x的二分之一次方,导数是二分之一乘以x的负二分之一次方。",
            "3": "接下来看指数函数和对数函数的求导公式。指数函数中,e的x次方最为特殊,它有一个神奇的性质:e的x次方求导还是e的x次方!这个性质使得e成为自然对数的底,在微积分中有极其重要的地位。如果底数不是e,而是一般的a,那么a的x次方求导等于a的x次方乘以ln a。对数函数方面,自然对数ln x的导数等于1除以x。从几何意义理解,ln x图像在x处的切线斜率就是1除以x。x越大,切线越平缓。一般对数log以a为底x的导数,等于1除以括号x乘以ln a。记住这些公式的关键是理解e和ln的特殊关系。",
            "4": "三角函数的求导公式也有规律可循。正弦函数sin x的导数是cos x,余弦函数cos x的导数是负的sin x。记忆口诀是:正弦变余弦,余弦变负正弦。为什么会有这个规律呢?从图像上看,sin x的切线斜率变化恰好对应cos x的值。在x等于0处,sin x的切线斜率最大,而cos 0等于1。再看tan x,它的导数是sec平方x,也就是1除以cos平方x。这可以用除法法则从tan x等于sin x除以cos x推导出来。如果你连续对sin x求导,会发现:sin求导得cos,cos求导得负sin,负sin求导得负cos,负cos求导又回到sin,形成了一个循环!",
            "5": "掌握了基本公式后,我们需要学习四则运算法则,这样才能处理更复杂的函数。首先是线性性质,也叫和差法则:a倍的f加减b倍的g,求导等于a倍的f撇加减b倍的g撇。这说明常数可以提取出来,和差可以分别求导。乘法法则稍微复杂一点:f乘以g的导数,等于f撇乘以g,加上f乘以g撇。口诀是"前导后不导,加上前不导后导"。注意有两项!除法法则是:f除以g的导数,等于括号f撇乘以g减去f乘以g撇,全部除以g的平方。分子是"上导下减上下导",分母是g的平方。一定要记住分母要平方!这个很容易忘记。",
            "6": "让我们通过具体例题来练习乘法法则和除法法则。例题1:求y等于x平方乘以e的x次方的导数。这是两个函数相乘,用乘法法则。设f等于x平方,g等于e的x次方,那么f撇等于2x,g撇等于e的x次方。根据乘法法则,y撇等于2x乘以e的x次方,加上x平方乘以e的x次方。可以提取公因子e的x次方,得到括号2x加x平方乘以e的x次方。例题2:求y等于sin x除以x的导数。这是除法,用除法法则。f等于sin x,f撇等于cos x;g等于x,g撇等于1。代入公式:y撇等于括号cos x乘以x减去sin x乘以1,全部除以x平方,结果是x cos x减sin x,除以x平方。",
            "7": "再看一道综合性更强的例题。例题3:求y等于ln x除以x平方的导数。这也是除法法则的应用。f等于ln x,f撇等于1除以x;g等于x平方,g撇等于2x。根据除法法则,y撇等于1除以x乘以x平方,减去ln x乘以2x,全部除以x平方的平方,也就是x的四次方。分子是x减去2x ln x,分母是x的四次方。现在注意化简技巧:分子分母同时约去一个x,得到1减2 ln x,全部除以x的三次方。这就是最终答案。做除法法则的题目时,一定要注意:第一,分子的符号,是减号不是加号;第二,分母要平方;第三,最后要化简到最简形式。",
            "8": "好,今天的课程我们就讲到这里。让我们回顾一下学习的内容。基本求导公式有三类:第一类是幂函数,x的n次方导数等于nx的n减1次方;第二类是指数对数,e的x次方导数是e的x次方,ln x导数是1除以x;第三类是三角函数,sin x导数是cos x,cos x导数是负sin x。四则运算法则包括:和差法则可以分别求导,乘法法则是前导后不导加前不导后导,除法法则是上导下减上下导除以g平方。这些公式一定要熟记于心,因为它们是后续学习的基础!熟练掌握后,求导就会变得像四则运算一样简单。下节课我们要学习链式法则,那是处理复合函数求导的强大工具,比如e的x平方、sin的2x这类函数都要用链式法则。今天的课就到这里,同学们课后一定要多做练习,把公式记牢!再见!"
        };

        const actionMap = {
            "1": "A_RLH_welcome_O",
            "2": "A_RH_point_O",
            "3": "A_LH_introduced_O",
            "4": "A_RH_point_O",
            "5": "A_LH_introduced_O",
            "6": "A_RH_point_O",
            "7": "A_RH_point_O",
            "8": "A_RLH_welcome_O"
        };

        let currentSlide = 0;
        const totalSlides = 8;
        let avatarPlatform = null;
        let isConnected = false;
        let isTeaching = false;
        let isAutoPlaying = false;
        let speechFinishedResolve = null;

        const slides = document.querySelectorAll('.slide');

        function showSlide(index) {
            slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            currentSlide = index;
            document.getElementById('currentSlide').textContent = index + 1;

            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([slides[index]]).catch(err => console.error(err));
            }

            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === totalSlides - 1;
            updateSubtitle(index + 1);
        }

        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                showSlide(currentSlide + 1);
                if (!isAutoPlaying) speakContent(currentSlide + 1);
            }
        }

        function previousSlide() {
            if (currentSlide > 0) {
                showSlide(currentSlide - 1);
                if (!isAutoPlaying) speakContent(currentSlide + 1);
            }
        }

        function restart() {
            showSlide(0);
            if (avatarPlatform) {
                avatarPlatform.stop();
            }
            isConnected = false;
            isTeaching = false;
            isAutoPlaying = false;
        }

        function updateSubtitle(slideNum) {
            const subtitleArea = document.getElementById('subtitleArea');
            subtitleArea.textContent = subtitleScript[slideNum] || '';
        }

        async function speakContent(slideNum) {
            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('⚠️ 虚拟人未连接');
                return;
            }

            const content = subtitleScript[slideNum];
            if (!content) return;

            try {
                const action = actionMap[slideNum];
                if (action) {
                    await avatarPlatform.writeCmd("action", action);
                }

                await avatarPlatform.writeText(content, { nlp: false });
                updateSubtitle(slideNum);
            } catch (error) {
                console.error('❌ 讲解失败:', error);
            }
        }

        function updateStatus(message, type = 'normal') {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.className = 'status-indicator';
                if (type === 'connected') indicator.classList.add('connected');
                else if (type === 'error') indicator.classList.add('error');
                else if (type === 'connecting') indicator.classList.add('connecting');
            }
        }

        function waitForSDK() {
            return new Promise((resolve, reject) => {
                if (typeof AvatarPlatform !== 'undefined') {
                    resolve();
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('SDK加载超时'));
                }, 10000);

                window.addEventListener('sdkReady', function handler() {
                    clearTimeout(timeout);
                    window.removeEventListener('sdkReady', handler);
                    resolve();
                });
            });
        }

        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = '🔄 启动中...';
            startBtn.disabled = true;

            try {
                updateStatus('等待SDK...', 'connecting');
                await waitForSDK();

                if(avatarPlatform) {
                    avatarPlatform.destroy();
                }

                avatarPlatform = new AvatarPlatform({ useInlinePlayer: true });

                avatarPlatform
                    .on('connected', (initResp) => {
                        console.log('🎉 连接成功');
                        isConnected = true;
                        isTeaching = true;
                        updateStatus('已连接', 'connected');
                        startBtn.textContent = '💖 虚拟人已就绪';

                        setTimeout(() => {
                            speakContent(currentSlide + 1);
                        }, 1000);
                    })
                    .on('frame_stop', (data) => {
                        console.log('✅ 虚拟人讲解完成 frame_stop:', data);
                        if (isAutoPlaying && speechFinishedResolve) {
                            console.log('🎬 通知自动播放：虚拟人讲解完成');
                            speechFinishedResolve();
                            speechFinishedResolve = null;
                        }
                    })
                    .on('disconnected', (err) => {
                        isConnected = false;
                        updateStatus('连接断开', 'error');
                    })
                    .on('error', (error) => {
                        console.error('❌ 错误:', error);
                        updateStatus('错误', 'error');
                        startBtn.textContent = '❌ 连接失败';
                        startBtn.disabled = false;
                        isTeaching = false;
                    });

                avatarPlatform.setApiInfo({
                    appId: 'e8c180ed',
                    apiKey: 'e0c44f0e2ef0f47582ffa7e864da0d9b',
                    apiSecret: 'MDZkNDNiZWU4NDkzNWM5MDQzMTY4N2Nh',
                    sceneId: '237415046114840576',
                    serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact'
                });

                avatarPlatform.setGlobalParams({
                    stream: { protocol: 'xrtc', alpha: 1, bitrate: 1000000, fps: 25 },
                    avatar: { avatar_id: '110332017', width: 1920, height: 1080, scale: 1, move_h: 0, move_v: 0, audio_format: 1 },
                    tts: { vcn: 'x4_yiting', speed: 50, pitch: 50, volume: 100 },
                    avatar_dispatch: { interactive_mode: 1, content_analysis: 0 }
                });

                await avatarPlatform.start({ wrapper: document.getElementById('avatarWrapper') });
            } catch (error) {
                console.error('❌ 启动失败:', error);
                updateStatus('启动失败', 'error');
                startBtn.textContent = '🎀 开始讲课';
                startBtn.disabled = false;
            }
        }

        async function startAutoPlay() {
            if (!avatarPlatform || !isConnected) {
                await startTeaching();
                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            isAutoPlaying = true;
            document.getElementById('autoPlayBtn').disabled = true;

            for (let slide = currentSlide + 1; slide <= totalSlides; slide++) {
                if (!isAutoPlaying) break;

                console.log(`\n🎬 === 开始播放第${slide}页/${totalSlides}页 ===`);
                showSlide(slide - 1);

                // 如果虚拟人已连接，使用frame_stop事件同步
                if (isConnected && isTeaching && avatarPlatform) {
                    try {
                        // 先稍作等待确保状态稳定
                        await new Promise(resolve => setTimeout(resolve, 800));

                        // 创建Promise等待虚拟人讲解完成
                        const speechPromise = new Promise(resolve => {
                            speechFinishedResolve = resolve;
                        });

                        await speakContent(slide);
                        console.log(`⏳ 等待虚拟人讲解第${slide}页完成...`);

                        // 等待虚拟人讲解完成，或超时（防止卡住）
                        const timeoutDuration = (subtitleScript[slide].length / 4) * 1000 + 5000;
                        const timeoutPromise = new Promise(resolve =>
                            setTimeout(() => {
                                console.log(`⚠️ 第${slide}页讲解超时，继续下一页`);
                                resolve();
                            }, timeoutDuration)
                        );

                        await Promise.race([speechPromise, timeoutPromise]);
                        console.log(`✅ 第${slide}页讲解完成`);

                        // 页面间等待时间
                        if (slide < totalSlides) {
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }
                    } catch (error) {
                        console.error(`❌ 第${slide}页播放出错:`, error);
                    }
                } else {
                    // 虚拟人未连接，使用固定延时
                    console.log('⚠️ 虚拟人未连接，使用固定延时');
                    const duration = (subtitleScript[slide].length / 4) * 1000 + 3000;
                    await new Promise(resolve => setTimeout(resolve, duration));
                }
            }

            isAutoPlaying = false;
            document.getElementById('autoPlayBtn').disabled = false;
            window.playbackFinished = true;
            document.title = "PLAYBACK_FINISHED";
            console.log('🎉 播放完成');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextSlide();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousSlide();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                speakContent(currentSlide + 1);
            }
        });

        document.getElementById('totalSlides').textContent = totalSlides;
        showSlide(0);

        setTimeout(() => {
            console.log('🚀 自动启动播放...');
            startAutoPlay();
        }, 3000);
    </script>
</body>
</html>
