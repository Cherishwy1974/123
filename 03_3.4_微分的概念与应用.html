<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>03_3.4_微分的概念与应用 v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('✅ MathJax已加载');
                    });
                }
            }
        };
    </script>
    <!-- 优化：使用 chtml 版本，通常性能更好 -->
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Noto Serif SC', serif; background: #1a1a2e; overflow: hidden; height: 100vh; width: 100vw; }
        .blackboard { width: 100vw; height: 100vh; background: #1a1a2e; position: relative; border: 10px solid #795548; margin: 0; }
        .avatar-container { position: fixed; top: 60%; left: 50%; transform: translate(-50%, -50%); width: 975px; height: 1105px; overflow: hidden; z-index: 50; pointer-events: none; background: transparent; }
        .wrapper { width: 100%; height: 100%; background: transparent; pointer-events: auto; }
        .slide-container { width: 100%; height: 100%; position: relative; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.6s ease-in-out; display: flex; justify-content: center; align-items: center; padding: 2rem; background-color: transparent; }
        .slide.active { opacity: 1; visibility: visible; }
        .slide-content { display: flex; flex-direction: row; gap: 2rem; width: 100%; height: 95%; }
        .chalkboard { flex: 0 0 45%; padding: 20px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .chalkboard h2 { color: #f1c40f; border-bottom: 2px solid #f39c12; font-size: 28px; padding-bottom: 10px; margin-bottom: 20px; }
        .chalkboard h3 { color: #1abc9c; font-size: 22px; margin-top: 20px; margin-bottom: 10px; }
        .chalkboard p, .chalkboard li { color: #e0e0e0; font-size: 18px; line-height: 1.8; margin: 8px 0; }
        .chalkboard strong { color: #e74c3c; }
        /* 修复：使用 DIV 作为块级容器来承载块级公式 */
        .math-formula-box {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
            font-size: 20px;
            color: #1abc9c;
            text-align: center;
            margin: 15px 0;
        }
        .visualization { flex: 1; padding: 20px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .control-bar { position: fixed; left: -9999px; top: 50%; transform: translateY(-50%); width: 270px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); display: flex; flex-direction: column; gap: 12px; z-index: 200; border-radius: 0 20px 20px 0; padding: 25px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn { padding: 14px 22px; background: rgba(255, 255, 255, 0.25); color: #333; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; text-align: center; }
        .btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .subtitle-area { position: absolute; bottom: 20px; left: 50px; right: 50px; min-height: 50px; background: rgba(0,0,0,0.8); border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 60; color: white; font-size: 23px; text-align: center; padding: 15px 20px; line-height: 1.4; }
        .status-indicator { position: absolute; top: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.5); color: white; border-radius: 5px; font-size: 16px; z-index: 100; display: none; }
        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); display: block; }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); display: block; }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); display: block; }
    </style>
</head>
<body class="blackboard">
    <div class="status-indicator" id="statusIndicator">等待连接</div>
    <div class="avatar-container"><div class="wrapper" id="avatarWrapper"></div></div>
    <div class="slide-container">
        <!-- 第1页:课程引入 - 导数回顾 -->
        <div class="slide active">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>回顾：导数的概念</h2>
                    <p>我们已经学习了<strong>导数</strong>的概念：</p>
                    <div class="math-formula-box">\[f'(x) = \lim_{\Delta x \to 0} \frac{\Delta y}{\Delta x}\]</div>
                    <p>导数描述了函数的<strong>变化率</strong>。</p>
                    <p style="margin-top: 20px; color: #95a5a6;">今天我们要学习一个新概念——<strong>微分</strong>。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">微分的概念与应用</text>
                        <circle cx="300" cy="250" r="100" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="4">
                            <animate attributeName="r" dur="2s" values="100;110;100" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="28" text-anchor="middle" x="300" y="245">导数</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="275">f'(x)</text>
                        <text fill="#f39c12" font-size="60" text-anchor="middle" x="300" y="400">?</text>
                        <text fill="#1abc9c" font-size="24" text-anchor="middle" x="300" y="450">微分是什么?</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第2页:提出问题 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>一个新问题</h2>
                    <p>当自变量 \(x\) 有一个<strong>微小变化</strong> \(\Delta x\) 时，</p>
                    <p>函数 \(y\) 会变化多少？</p>
                    <p style="margin-top: 25px;">从导数的定义，当 \(\Delta x\) 很小时：</p>
                    <div class="math-formula-box">\[\Delta y \approx f'(x) \cdot \Delta x\]</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">变化量的关系</text>
                        <rect x="100" y="150" width="150" height="80" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="175" y="200">Δx</text>
                        <line x1="250" y1="190" x2="350" y2="190" stroke="#e74c3c" stroke-width="4" marker-end="url(#arrowhead)"/>
                        <text fill="#e74c3c" font-size="20" text-anchor="middle" x="300" y="170">×f'(x)</text>
                        <rect x="350" y="150" width="150" height="80" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="425" y="200">Δy</text>
                        <rect x="150" y="300" width="300" height="100" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="340">近似关系</text>
                        <text fill="#1abc9c" font-size="24" text-anchor="middle" x="300" y="375">Δy ≈ f'(x) · Δx</text>
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#e74c3c"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第3页:引出微分概念 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>微分的引入</h2>
                    <p><strong>微分</strong>专门研究函数增量的线性近似关系。</p>
                    <p style="margin-top: 20px; color: #e74c3c;">它是导数概念的延伸和应用！</p>
                    <p style="color: #1abc9c;">用简单的线性关系代替复杂的函数变化。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="50">导数 → 微分</text>
                        <circle cx="150" cy="200" r="70" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3">
                            <animate attributeName="r" dur="2s" values="70;80;70" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="150" y="195">导数</text>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="150" y="215">f'(x)</text>
                        <line x1="220" y1="200" x2="380" y2="200" stroke="#f39c12" stroke-width="4" marker-end="url(#arrowhead2)"/>
                        <text fill="#f39c12" font-size="18" text-anchor="middle" x="300" y="180">应用</text>
                        <circle cx="450" cy="200" r="70" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3">
                            <animate attributeName="r" dur="2s" values="70;80;70" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="450" y="195">微分</text>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="450" y="215">dy</text>
                        <rect x="100" y="320" width="400" height="100" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="360">微分是导数的延伸</text>
                        <text fill="#1abc9c" font-size="18" text-anchor="middle" x="300" y="390">用于估计函数的变化量</text>
                        <defs>
                            <marker id="arrowhead2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第4页:微分的定义 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>微分的定义</h2>
                    <p>设函数 \(y = f(x)\) 在点 \(x\) 可导，则：</p>
                    <div class="math-formula-box">\[dy = f'(x) \cdot dx\]</div>
                    <p style="margin-top: 15px;">其中：</p>
                    <p>• \(dx = \Delta x\) 是自变量的微分</p>
                    <p>• \(dy\) 是函数 \(y\) 的微分</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">微分的定义</text>
                        <rect x="100" y="150" width="400" height="80" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="28" text-anchor="middle" x="300" y="200">dy = f'(x) · dx</text>
                        <rect x="100" y="300" width="400" height="80" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="300" y="350">微分 = 导数 × 自变量增量</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第5页:微分与导数的关系 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>微分与导数的关系</h2>
                    <p>从 \(dy = f'(x) \cdot dx\) 可得：</p>
                    <div class="math-formula-box">\[f'(x) = \frac{dy}{dx}\]</div>
                    <p style="margin-top: 20px;"><strong>导数是微分之商！</strong></p>
                    <p style="color: #95a5a6;">\(\frac{dy}{dx}\) 可以真正理解为 \(dy\) 除以 \(dx\)。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">导数与微分</text>
                        <rect x="100" y="120" width="400" height="80" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="170">dy = f'(x) · dx</text>
                        <text fill="#f39c12" font-size="40" text-anchor="middle" x="300" y="250">⇅</text>
                        <rect x="100" y="280" width="400" height="80" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="330">f'(x) = dy/dx</text>
                        <rect x="100" y="400" width="400" height="60" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="2" rx="8"/>
                        <text fill="#1abc9c" font-size="18" text-anchor="middle" x="300" y="440">两种表达，同一个概念！</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第6页:两种增量 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>两种增量</h2>
                    <p>当自变量从 \(x\) 变到 \(x + \Delta x\) 时：</p>
                    <p style="margin-top: 15px;"><strong>1. 曲线实际增量 \(\Delta y\)：</strong></p>
                    <div class="math-formula-box">\[\Delta y = f(x + \Delta x) - f(x)\]</div>
                    <p><strong>2. 切线增量 \(dy\)：</strong></p>
                    <div class="math-formula-box">\[dy = f'(x) \cdot \Delta x\]</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="40">两种增量</text>
                        <line x1="100" y1="400" x2="550" y2="400" stroke="#ecf0f1" stroke-width="2"/>
                        <line x1="100" y1="100" x2="100" y2="400" stroke="#ecf0f1" stroke-width="2"/>
                        <text fill="#ecf0f1" font-size="14" x="560" y="405">x</text>
                        <text fill="#ecf0f1" font-size="14" x="105" y="90">y</text>
                        <path d="M 150 350 Q 250 200 350 250 Q 450 300 500 200" fill="none" stroke="#3498db" stroke-width="3"/>
                        <text fill="#3498db" font-size="16" x="450" y="180">y = f(x)</text>
                        <circle cx="250" cy="230" r="5" fill="#e74c3c"/>
                        <text fill="#e74c3c" font-size="14" x="215" y="220">(x, f(x))</text>
                        <line x1="150" y1="290" x2="400" y2="170" stroke="#2ecc71" stroke-width="2" stroke-dasharray="5,5"/>
                        <text fill="#2ecc71" font-size="14" x="380" y="160">切线</text>
                        <line x1="250" y1="405" x2="350" y2="405" stroke="#f39c12" stroke-width="3"/>
                        <line x1="250" y1="400" x2="250" y2="410" stroke="#f39c12" stroke-width="2"/>
                        <line x1="350" y1="400" x2="350" y2="410" stroke="#f39c12" stroke-width="2"/>
                        <text fill="#f39c12" font-size="16" text-anchor="middle" x="300" y="430">Δx</text>
                        <line x1="355" y1="200" x2="355" y2="250" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#2ecc71" font-size="16" x="365" y="230">dy</text>
                        <line x1="345" y1="230" x2="345" y2="250" stroke="#e74c3c" stroke-width="3"/>
                        <text fill="#e74c3c" font-size="16" x="320" y="245">Δy</text>
                        <circle cx="350" cy="250" r="5" fill="#e74c3c"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第7页:微分的计算 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>微分的计算</h2>
                    <p>由于 \(dy = f'(x) \cdot dx\),</p>
                    <p><strong>微分计算 = 导数计算!</strong></p>

                    <h3>基本微分公式</h3>
                    <div class="math-formula-box">\[d(x^n) = nx^{n-1}dx\]</div>
                    <div class="math-formula-box">\[d(\sin x) = \cos x \, dx\]</div>
                    <div class="math-formula-box">\[d(e^x) = e^x dx\]</div>
                    <div class="math-formula-box">\[d(\ln x) = \frac{1}{x} dx\]</div>

                    <h3>微分运算法则</h3>
                    <p>和导数运算法则<strong>完全一致</strong>!</p>
                    <div class="math-formula-box">\[d(u \pm v) = du \pm dv\]</div>
                    <div class="math-formula-box">\[d(uv) = u \, dv + v \, du\]</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">微分 ↔ 导数</text>

                        <!-- 对应关系展示 -->
                        <g>
                            <rect x="80" y="100" width="200" height="60" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="180" y="138">(x²)' = 2x</text>
                        </g>

                        <line x1="280" y1="130" x2="320" y2="130" stroke="#f39c12" stroke-width="3"/>
                        <text fill="#f39c12" font-size="20" text-anchor="middle" x="300" y="125">↔</text>

                        <g>
                            <rect x="320" y="100" width="200" height="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="420" y="138">d(x²) = 2x dx</text>
                        </g>

                        <!-- 第二组 -->
                        <g opacity="0">
                            <rect x="80" y="200" width="200" height="60" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="180" y="238">(sin x)' = cos x</text>
                            <animate attributeName="opacity" dur="8s" values="0;0;1;1" repeatCount="indefinite"/>
                        </g>

                        <line x1="280" y1="230" x2="320" y2="230" stroke="#f39c12" stroke-width="3" opacity="0">
                            <animate attributeName="opacity" dur="8s" values="0;0;1;1" repeatCount="indefinite"/>
                        </line>

                        <g opacity="0">
                            <rect x="320" y="200" width="200" height="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="2" rx="8"/>
                            <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="420" y="238">d(sin x) = cos x dx</text>
                            <animate attributeName="opacity" dur="8s" values="0;0;1;1" repeatCount="indefinite"/>
                        </g>

                        <!-- 结论 -->
                        <rect x="100" y="320" width="400" height="100" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="360">微分公式 = 导数公式 × dx</text>
                        <text fill="#1abc9c" font-size="18" text-anchor="middle" x="300" y="395">形式上完全一致!</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第8页:微分的形式不变性 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>微分的形式不变性</h2>
                    <p>这是微分的<strong>重要性质</strong>!</p>

                    <h3>定理</h3>
                    <p>无论 \(u\) 是<strong>自变量</strong>还是<strong>中间变量</strong>,</p>
                    <div class="math-formula-box">\[d(f(u)) = f'(u) \, du\]</div>
                    <p>这个形式<strong>保持不变</strong>!</p>

                    <h3>例子</h3>
                    <p>1. 若 \(u = x\) (自变量):</p>
                    <div class="math-formula-box">\[d(\sin x) = \cos x \, dx\]</div>

                    <p>2. 若 \(u = x^2\) (中间变量):</p>
                    <div class="math-formula-box">\[d(\sin x^2) = \cos(x^2) \, d(x^2)\]</div>
                    <p style="margin-left: 30px;">\(= \cos(x^2) \cdot 2x \, dx\)</p>

                    <p style="margin-top: 20px; color: #e74c3c;"><strong>形式不变!</strong> 这让计算更简单!</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="50">形式不变性</text>

                        <!-- 自变量情况 -->
                        <rect x="100" y="100" width="400" height="80" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="130">u = x (自变量)</text>
                        <text fill="#1abc9c" font-size="22" text-anchor="middle" x="300" y="165">d(sin u) = cos u · du</text>

                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="220">↓</text>
                        <text fill="#f39c12" font-size="18" text-anchor="middle" x="300" y="250">形式不变</text>
                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="280">↓</text>

                        <!-- 中间变量情况 -->
                        <rect x="100" y="300" width="400" height="120" fill="rgba(155,89,182,0.1)" stroke="#9b59b6" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="330">u = x² (中间变量)</text>
                        <text fill="#1abc9c" font-size="22" text-anchor="middle" x="300" y="365">d(sin u) = cos u · du</text>
                        <text fill="#e74c3c" font-size="18" text-anchor="middle" x="300" y="395">= cos(x²) · 2x dx</text>

                        <!-- 强调 -->
                        <circle cx="550" cy="140" r="30" fill="none" stroke="#e74c3c" stroke-width="3">
                            <animate attributeName="r" dur="2s" values="30;35;30" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#e74c3c" font-size="24" text-anchor="middle" x="550" y="150">!</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第9页:微分的应用1 - 近似计算 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>应用一:近似计算</h2>
                    <p>利用微分可以进行<strong>近似计算</strong>:</p>
                    <div class="math-formula-box">\[f(x + \Delta x) \approx f(x) + f'(x) \Delta x\]</div>

                    <h3>例题</h3>
                    <p>计算 \(\sqrt{4.02}\) 的近似值</p>

                    <p><strong>解:</strong> 令 \(f(x) = \sqrt{x}\), \(x = 4\), \(\Delta x = 0.02\)</p>
                    <p style="margin-left: 30px;">\(f'(x) = \frac{1}{2\sqrt{x}}\)</p>
                    <p style="margin-left: 30px;">\(f'(4) = \frac{1}{2\sqrt{4}} = \frac{1}{4}\)</p>

                    <div class="math-formula-box">\[\sqrt{4.02} \approx \sqrt{4} + \frac{1}{4} \times 0.02\]</div>
                    <div class="math-formula-box">\[= 2 + 0.005 = 2.005\]</div>

                    <p style="margin-top: 15px; color: #95a5a6;">实际值: 2.00499... (误差极小!)</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="40">近似计算原理</text>

                        <!-- 坐标系 -->
                        <line x1="100" y1="350" x2="550" y2="350" stroke="#ecf0f1" stroke-width="2"/>
                        <line x1="150" y1="100" x2="150" y2="400" stroke="#ecf0f1" stroke-width="2"/>

                        <!-- 曲线 y = √x -->
                        <path d="M 150 350 Q 250 200 350 150 Q 450 120 520 100"
                              fill="none" stroke="#3498db" stroke-width="3"/>
                        <text fill="#3498db" font-size="16" x="480" y="85">y = √x</text>

                        <!-- 点 (4, 2) -->
                        <circle cx="300" cy="200" r="6" fill="#e74c3c"/>
                        <text fill="#e74c3c" font-size="14" x="260" y="190">(4, 2)</text>
                        <line x1="300" y1="350" x2="300" y2="355" stroke="#e74c3c" stroke-width="2"/>
                        <text fill="#e74c3c" font-size="14" text-anchor="middle" x="300" y="375">4</text>

                        <!-- 切线 -->
                        <line x1="250" y1="212.5" x2="400" y2="187.5" stroke="#2ecc71" stroke-width="2" stroke-dasharray="5,5"/>
                        <text fill="#2ecc71" font-size="14" x="380" y="180">切线</text>

                        <!-- Δx -->
                        <line x1="300" y1="355" x2="350" y2="355" stroke="#f39c12" stroke-width="3"/>
                        <text fill="#f39c12" font-size="14" text-anchor="middle" x="325" y="375">Δx=0.02</text>

                        <!-- 近似点 -->
                        <circle cx="350" cy="195" r="6" fill="#2ecc71"/>
                        <text fill="#2ecc71" font-size="14" x="360" y="195">≈ 2.005</text>

                        <!-- 实际点 -->
                        <circle cx="350" cy="175" r="6" fill="#3498db"/>
                        <text fill="#3498db" font-size="14" x="360" y="170">实际值</text>

                        <!-- 说明 -->
                        <rect x="100" y="420" width="400" height="60" fill="rgba(241,196,15,0.2)" stroke="#f39c12" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="300" y="450">用切线近似曲线</text>
                        <text fill="#1abc9c" font-size="16" text-anchor="middle" x="300" y="470">Δx 越小,越准确!</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第10页:微分的应用2 - 误差估计 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>应用二:误差估计</h2>
                    <p>测量存在误差时,可用微分估计结果误差</p>

                    <h3>原理</h3>
                    <p>若 \(y = f(x)\),测量 \(x\) 时误差为 \(\Delta x\),</p>
                    <p>则 \(y\) 的<strong>绝对误差</strong>约为:</p>
                    <div class="math-formula-box">\[|\Delta y| \approx |dy| = |f'(x)| \cdot |\Delta x|\]</div>

                    <p><strong>相对误差</strong>约为:</p>
                    <div class="math-formula-box">\[\frac{|\Delta y|}{|y|} \approx \frac{|f'(x)| \cdot |\Delta x|}{|f(x)|}\]</div>

                    <h3>例题</h3>
                    <p>测量圆的半径 \(r = 10\)cm,误差不超过 0.05cm,</p>
                    <p>估计面积 \(S = \pi r^2\) 的误差。</p>

                    <p><strong>解:</strong> \(S' = 2\pi r\), 当 \(r = 10\) 时:</p>
                    <div class="math-formula-box">\[|\Delta S| \approx 2\pi \times 10 \times 0.05 = \pi \approx 3.14 \text{ cm}^2\]</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="40">误差传播</text>

                        <!-- 圆的示意图 -->
                        <circle cx="200" cy="220" r="80" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"/>
                        <circle cx="200" cy="220" r="85" fill="none" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,5"/>

                        <!-- 半径 -->
                        <line x1="200" y1="220" x2="280" y2="220" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#2ecc71" font-size="16" text-anchor="middle" x="240" y="210">r</text>

                        <!-- 误差标注 -->
                        <line x1="280" y1="220" x2="285" y2="220" stroke="#e74c3c" stroke-width="3"/>
                        <text fill="#e74c3c" font-size="14" x="290" y="220">Δr</text>

                        <!-- 误差公式框 -->
                        <rect x="320" y="100" width="250" height="250" fill="rgba(0,0,0,0.3)" stroke="#f39c12" stroke-width="2" rx="10"/>

                        <text fill="#f1c40f" font-size="20" text-anchor="middle" x="445" y="135">误差估计</text>

                        <text fill="#ecf0f1" font-size="16" x="340" y="170">输入误差:</text>
                        <text fill="#e74c3c" font-size="18" x="340" y="195">|Δr| ≤ 0.05 cm</text>

                        <line x1="340" y1="210" x2="550" y2="210" stroke="#f39c12" stroke-width="1"/>

                        <text fill="#ecf0f1" font-size="16" x="340" y="235">输出误差:</text>
                        <text fill="#2ecc71" font-size="18" x="340" y="260">|ΔS| ≈ |S'| · |Δr|</text>
                        <text fill="#2ecc71" font-size="18" x="340" y="285">= 2πr · |Δr|</text>
                        <text fill="#1abc9c" font-size="18" x="340" y="310">≈ 3.14 cm²</text>

                        <!-- 底部说明 -->
                        <rect x="100" y="400" width="400" height="60" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="300" y="435">微分帮助我们估计误差传播!</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 第11页:总结 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>本节总结</h2>
                    <h3>微分的核心概念</h3>
                    <ul style="margin-left: 30px;">
                        <li><strong>定义:</strong> \(dy = f'(x) \cdot dx\)</li>
                        <li><strong>几何意义:</strong> 切线的增量</li>
                        <li><strong>与导数的关系:</strong> \(f'(x) = \frac{dy}{dx}\)</li>
                    </ul>

                    <h3 style="margin-top: 20px;">重要性质</h3>
                    <ul style="margin-left: 30px;">
                        <li>形式不变性</li>
                        <li>运算法则与导数一致</li>
                    </ul>

                    <h3 style="margin-top: 20px;">两大应用</h3>
                    <ul style="margin-left: 30px;">
                        <li><strong>近似计算:</strong> \(f(x+\Delta x) \approx f(x) + f'(x)\Delta x\)</li>
                        <li><strong>误差估计:</strong> \(|\Delta y| \approx |f'(x)| \cdot |\Delta x|\)</li>
                    </ul>

                    <p style="margin-top: 25px; color: #f39c12;"><strong>核心思想:</strong></p>
                    <p>微分 = 用<strong>直线代替曲线</strong>的艺术!</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="60">微分知识体系</text>

                        <!-- 中心圆 -->
                        <circle cx="300" cy="250" r="80" fill="rgba(241,196,15,0.3)" stroke="#f39c12" stroke-width="4">
                            <animate attributeName="r" dur="3s" values="80;90;80" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#f1c40f" font-size="24" text-anchor="middle" x="300" y="245">微分</text>
                        <text fill="#f1c40f" font-size="20" text-anchor="middle" x="300" y="270">dy = f'dx</text>

                        <!-- 定义 -->
                        <circle cx="150" cy="150" r="60" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="145">定义</text>
                        <text fill="#ecf0f1" font-size="14" text-anchor="middle" x="150" y="165">dy=f'dx</text>
                        <line x1="210" y1="190" x2="260" y2="220" stroke="#f39c12" stroke-width="2"/>

                        <!-- 几何意义 -->
                        <circle cx="450" cy="150" r="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="1s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="450" y="145">几何</text>
                        <text fill="#ecf0f1" font-size="14" text-anchor="middle" x="450" y="165">切线增量</text>
                        <line x1="390" y1="190" x2="340" y2="220" stroke="#f39c12" stroke-width="2"/>

                        <!-- 近似计算 -->
                        <circle cx="150" cy="380" r="60" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="1.5s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="150" y="375">近似</text>
                        <text fill="#ecf0f1" font-size="14" text-anchor="middle" x="150" y="395">计算</text>
                        <line x1="210" y1="340" x2="260" y2="300" stroke="#f39c12" stroke-width="2"/>

                        <!-- 误差估计 -->
                        <circle cx="450" cy="380" r="60" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="3">
                            <animate attributeName="r" dur="3s" values="60;70;60" repeatCount="indefinite" begin="2s"/>
                        </circle>
                        <text fill="#ecf0f1" font-size="16" text-anchor="middle" x="450" y="375">误差</text>
                        <text fill="#ecf0f1" font-size="14" text-anchor="middle" x="450" y="395">估计</text>
                        <line x1="390" y1="340" x2="340" y2="300" stroke="#f39c12" stroke-width="2"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="subtitle-area" id="subtitleArea">欢迎学习微分的概念与应用!</div>
    <div class="control-bar">
        <div style="color: #f1c40f; font-weight: bold; margin-bottom: 15px; text-align: center;">第 <span id="currentSlide">1</span> / <span id="totalSlides">11</span> 页</div>
        <button class="btn" id="prevBtn" onclick="previousSlide()">⬅️ 上一页</button>
        <button class="btn primary" id="startBtn" onclick="startTeaching()">🎀 开始讲课</button>
        <button class="btn" id="nextBtn" onclick="nextSlide()">下一页 ➡️</button>
        <button class="btn" onclick="restart()">🔄 重新开始</button>
        <button class="btn" id="autoPlayBtn" onclick="startAutoPlay()">🎬 自动播放</button>
    </div>
    <script type="module">
        window.playbackFinished = false;
        try { const { default: AvatarPlatform, SDKEvents, PlayerEvents, RecorderEvents, UserMedia } = await import('./avatar-sdk-web_3.1.2.1002/index.js'); window.AvatarPlatform = AvatarPlatform; window.SDKEvents = SDKEvents; window.PlayerEvents = PlayerEvents; window.RecorderEvents = RecorderEvents; window.UserMedia = UserMedia; console.log('✅ 讯飞SDK模块已加载'); } catch (error) { console.error('❌ SDK加载失败:', error); } window.dispatchEvent(new CustomEvent('sdkReady'));
    </script>
    <script>
        // 字幕文本（专业规范）
        const subtitleScript = {
            "1": "导数 f'(x) 描述函数变化率 | 微分研究函数增量的线性近似",
            "2": "当 Δx 很小时，Δy ≈ f'(x)·Δx | 微分专门研究这一近似关系",
            "3": "微分是导数概念的延伸 | 用于估计函数变化量",
            "4": "定义：dy = f'(x)·dx | dx = Δx 为自变量微分，dy 为函数微分",
            "5": "导数 f'(x) = dy/dx | 导数是微分之商",
            "6": "Δy：曲线实际增量 = f(x+Δx) - f(x) | dy：切线增量 = f'(x)·Δx",
            "7": "基本公式：d(x^n) = nx^(n-1)dx | d(sin x) = cos x dx | 运算法则：d(u±v) = du±dv",
            "8": "形式不变性：d[f(u)] = f'(u)du | 无论 u 是自变量还是中间变量",
            "9": "近似计算：f(x+Δx) ≈ f(x) + f'(x)Δx | 例：√4.02 ≈ 2.005",
            "10": "误差估计：|Δy| ≈ |f'(x)|·|Δx| | 例：圆半径误差 ±0.05cm → 面积误差 ≈ π cm²",
            "11": "微分核心：dy = f'(x)dx | 应用：近似计算与误差估计 | 核心思想：以直代曲"
        };

        // 发音文本（口语化）
        const speechScript = {
            "1": "同学们好!我们已经学过导数了。导数f撇x描述的是函数的变化率。今天我们要学习一个新概念,叫做微分。",
            "2": "先来看一个问题:当自变量x有一个很小的变化delta x时,函数y会变化多少呢?从导数的定义我们知道,当delta x很小的时候,delta y大约等于f撇x乘以delta x。微分就是专门研究这个近似关系的!",
            "3": "微分是导数概念的延伸和应用。它可以帮助我们估计函数的变化量,在实际计算中非常有用。",
            "4": "微分的定义是这样的:设函数y等于f括号x在点x可导,那么dy等于f撇x乘以dx。这里,dx等于delta x,是自变量的微小增量,我们叫它自变量的微分。dy呢,就叫做函数y的微分。",
            "5": "微分和导数有什么关系呢?从定义式dy等于f撇x乘以dx可以看出,f撇x等于dy除以dx。这说明导数就是微分之商!以前我们把dy除以dx看作一个整体符号,现在有了微分的概念,它可以真正理解为dy除以dx了。",
            "6": "微分有清晰的几何意义。考虑曲线y等于f括号x,当自变量从x变到x加delta x时,有两种增量。第一种是delta y,它是曲线上的实际增量,等于f括号x加delta x减f括号x。第二种是dy,它是切线上的增量,等于f撇x乘以delta x。从图像上看,当delta x很小时,曲线的这一小段几乎可以用切线来代替!dy就是切线的竖直增量,delta y是曲线的竖直增量。当delta x越来越小时,dy越来越接近delta y。这就是微分的几何意义:用切线代替曲线。",
            "7": "微分的计算其实很简单,因为微分计算就是导数计算!所有的基本微分公式都可以从导数公式得到。比如x的n次方的微分,等于n乘以x的n减1次方乘以dx。sin x的微分等于cos x乘以dx。微分的运算法则和导数运算法则完全一致!u加减v的微分等于du加减dv。u乘以v的微分等于u乘以dv加v乘以du。所以掌握了导数,就等于掌握了微分,只需在结果后面乘以dx就行了!",
            "8": "微分有一个非常重要的性质,叫做形式不变性。这个性质说的是:无论u是自变量还是中间变量,d括号f括号u的形式总是f撇u乘以du,这个形式保持不变!让我们看一个例子。如果u等于x平方是中间变量,那么d括号sin x平方,仍然可以写成cos x平方乘以d括号x平方,再把d括号x平方算出来等于2x dx,所以最终结果是cos x平方乘以2x dx。看到了吗?形式不变性使得微分计算变得非常简单!",
            "9": "微分的第一个重要应用是近似计算。根据微分的定义,f括号x加delta x约等于f括号x加f撇x乘以delta x,当delta x很小时。我们可以用这个公式进行近似计算。来看一个例题:计算根号4点02的近似值。我们令f括号x等于根号x,取x等于4,delta x等于0点02。首先求导数:f撇x等于1除以2倍根号x,所以f撇4等于四分之一。代入公式:根号4点02约等于2加0点005,等于2点005。用计算器验证,实际值是2点00499,误差极小!",
            "10": "微分的第二个应用是误差估计。在实际测量中,总会有误差。如果测量x时有误差delta x,那么通过计算得到的y会有多大误差呢?根据微分,delta y的绝对值约等于f撇x的绝对值乘以delta x的绝对值。让我们看一个例题:测量圆的半径r等于10厘米,误差不超过0点05厘米,问面积的误差有多大?首先求导数:S撇等于2π乘以r。当r等于10时,delta S的绝对值约等于π,约等于3点14平方厘米。这说明半径的微小误差会通过公式放大。",
            "11": "好,让我们总结一下微分的核心内容。第一,微分的定义是dy等于f撇x乘以dx。第二,微分的几何意义是切线的增量。第三,微分有重要的形式不变性。第四,微分有两大应用:一是近似计算,二是误差估计。微分的核心思想就是以直代曲、以简化繁。掌握了微分,我们就多了一个强大的数学工具!今天的课就到这里,同学们再见!"
        };

        const actionMap = {
            "1": "A_RLH_welcome_O", "2": "A_RH_point_O", "3": "A_LH_introduced_O",
            "4": "A_RH_point_O", "5": "A_LH_introduced_O", "6": "A_RH_point_O",
            "7": "A_LH_introduced_O", "8": "A_RH_point_O", "9": "A_LH_introduced_O",
            "10": "A_RH_point_O", "11": "A_RLH_welcome_O"
        };

        let currentSlide = 0; const totalSlides = 11; let avatarPlatform = null; let isConnected = false; let isTeaching = false; let isAutoPlaying = false; let speechFinishedResolve = null; let isSpeaking = false; const slides = document.querySelectorAll('.slide');

        function showSlide(index) {
            slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            currentSlide = index;
            document.getElementById('currentSlide').textContent = index + 1;
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([slides[index]]).catch(err => console.error(err));
            }
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === totalSlides - 1;
            updateSubtitle(index + 1);
        }

        async function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                // 注意：不调用 stop()，避免断开连接
                // 直接翻页，新的讲解会覆盖旧的
                showSlide(currentSlide + 1);
                if (!isAutoPlaying && isTeaching && isConnected) {
                    await speakContent(currentSlide + 1);
                }
            }
        }

        async function previousSlide() {
            if (currentSlide > 0) {
                // 注意：不调用 stop()，避免断开连接
                // 直接翻页，新的讲解会覆盖旧的
                showSlide(currentSlide - 1);
                if (!isAutoPlaying && isTeaching && isConnected) {
                    await speakContent(currentSlide + 1);
                }
            }
        }
        function restart() {
            showSlide(0);
            // 注意：不调用 stop()，避免断开连接
            // 只重置状态标志
            isAutoPlaying = false;
            isSpeaking = false;
            speechFinishedResolve = null;
        }
        function updateSubtitle(slideNum) {
            const subtitleArea = document.getElementById('subtitleArea');
            subtitleArea.textContent = subtitleScript[slideNum] || '';
        }

        async function speakContent(slideNum) {
            if (!isTeaching || !isConnected || !avatarPlatform) {
                console.log('⚠️ 虚拟人未连接');
                return;
            }
            const content = speechScript[slideNum];
            if (!content) return;

            try {
                // 注意：不要调用 stop()，因为会导致整个连接断开
                // SDK会自动管理讲解队列

                isSpeaking = true;
                console.log(`[Sync] 🎤 开始讲解第${slideNum}页`);

                const action = actionMap[slideNum];
                if (action) {
                    await avatarPlatform.writeCmd("action", action);
                }
                await avatarPlatform.writeText(content, { nlp: false });
                updateSubtitle(slideNum);
            } catch (error) {
                console.error('❌ 讲解失败:', error);
                isSpeaking = false;
                // 如果讲解失败，也需要通知自动播放继续
                if (isAutoPlaying && speechFinishedResolve) {
                    speechFinishedResolve();
                    speechFinishedResolve = null;
                }
            }
        }
        // 计算单页播放时长（用于超时fallback）
        // 注意：speechScript中的内容已经是公式音译后的汉字，直接计算字数即可
        // 这个时间只用于网络异常时的保护，正常同步依赖 frame_stop 事件
        function getSlideDuration(slideNum) {
            const speech = speechScript[slideNum];
            if (!speech) return 10000;
            // 每个汉字按150毫秒计算（正常语速） + 3秒缓冲时间
            return speech.length * 150 + 3000;
        }
        function updateStatus(message, type = 'normal') { const indicator = document.getElementById('statusIndicator'); if (indicator) { indicator.textContent = message; indicator.className = 'status-indicator'; if (type === 'connected') indicator.classList.add('connected'); else if (type === 'error') indicator.classList.add('error'); else if (type === 'connecting') indicator.classList.add('connecting'); } }
        function waitForSDK() { return new Promise((resolve, reject) => { if (typeof AvatarPlatform !== 'undefined') { resolve(); return; } const timeout = setTimeout(() => { reject(new Error('SDK加载超时')); }, 10000); window.addEventListener('sdkReady', function handler() { clearTimeout(timeout); window.removeEventListener('sdkReady', handler); resolve(); }); }); }
        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = '🔄 启动中...';
            startBtn.disabled = true;

            try {
                updateStatus('等待SDK...', 'connecting');
                await waitForSDK();
                console.log('✅ SDK已就绪，开始初始化虚拟人...');

                if(avatarPlatform) {
                    console.log('🔄 销毁旧的虚拟人实例...');
                    avatarPlatform.destroy();
                }

                console.log('🎭 创建新的虚拟人实例...');
                avatarPlatform = new AvatarPlatform({ useInlinePlayer: true });

                avatarPlatform.on('connected', (initResp) => {
                    console.log('🎉 连接成功');
                    isConnected = true;
                    isTeaching = true;
                    updateStatus('已连接', 'connected');
                    startBtn.textContent = '💖 虚拟人已就绪';
                    // 等待2秒让连接稳定后再开始讲解
                    setTimeout(() => {
                        if (isConnected && !isAutoPlaying) {
                            speakContent(currentSlide + 1);
                        }
                    }, 2000);
                }).on('disconnected', (err) => {
                    console.error('❌ 虚拟人连接断开:', err);
                    isConnected = false;
                    isSpeaking = false;
                    updateStatus('连接断开', 'error');
                    startBtn.textContent = '🔄 重新连接';
                    startBtn.disabled = false;
                }).on('error', (error) => {
                    console.error('❌ 虚拟人SDK错误:', error);
                    console.error('错误详情:', JSON.stringify(error, null, 2));
                    updateStatus('错误: ' + (error.message || '未知错误'), 'error');
                    startBtn.textContent = '❌ 连接失败';
                    startBtn.disabled = false;
                    isTeaching = false;
                    isSpeaking = false;
                }).on('frame_stop', (data) => {
                    console.log(`[Sync] ✅ 收到 'frame_stop' 信号，讲解完成`);
                    isSpeaking = false;

                    if (isAutoPlaying && speechFinishedResolve) {
                        console.log('[Sync] 🎬 通知自动播放：可以进入下一页');
                        speechFinishedResolve();
                        speechFinishedResolve = null;
                    }
                });

                console.log('🔑 设置API信息...');
                avatarPlatform.setApiInfo({
                    appId: 'e8c180ed',
                    apiKey: 'e0c44f0e2ef0f47582ffa7e864da0d9b',
                    apiSecret: 'MDZkNDNiZWU4NDkzNWM5MDQzMTY4N2Nh',
                    sceneId: '237415046114840576',
                    serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact'
                });

                console.log('⚙️ 设置全局参数...');
                avatarPlatform.setGlobalParams({
                    stream: { protocol: 'xrtc', alpha: 1, bitrate: 1000000, fps: 25 },
                    avatar: { avatar_id: '110332017', width: 1920, height: 1080, scale: 1, move_h: 0, move_v: 0, audio_format: 1 },
                    tts: { vcn: 'x4_yiting', speed: 50, pitch: 50, volume: 100 },
                    avatar_dispatch: { interactive_mode: 1, content_analysis: 0 }
                });

                console.log('🚀 启动虚拟人连接...');
                await avatarPlatform.start({ wrapper: document.getElementById('avatarWrapper') });
            } catch (error) {
                console.error('❌ 启动失败:', error);
                console.error('错误堆栈:', error.stack);
                updateStatus('启动失败: ' + (error.message || '未知错误'), 'error');
                startBtn.textContent = '🎀 开始讲课';
                startBtn.disabled = false;
            }
        }
        async function startAutoPlay() {
            if (!avatarPlatform || !isConnected) {
                await startTeaching();
                // 等待3秒让虚拟人连接完全稳定
                await new Promise(resolve => setTimeout(resolve, 3000));

                // 再次检查连接状态
                if (!isConnected) {
                    console.error('❌ 虚拟人连接失败，无法自动播放');
                    alert('虚拟人连接失败，请检查网络后重试');
                    return;
                }
            }

            isAutoPlaying = true;
            document.getElementById('autoPlayBtn').disabled = true;

            try {
                for (let i = currentSlide; i < totalSlides; i++) {
                    if (!isAutoPlaying) {
                        console.log('🛑 自动播放被停止');
                        break;
                    }

                    console.log(`\n🎬 === 开始播放第${i + 1}页/${totalSlides}页 ===`);

                    // 先翻页
                    showSlide(i);

                    // 等待一小段时间让页面渲染
                    await new Promise(resolve => setTimeout(resolve, 300));

                    if (isConnected && isTeaching && avatarPlatform) {
                        try {
                            // 创建一个Promise等待讲解完成
                            const speechPromise = new Promise(resolve => {
                                speechFinishedResolve = resolve;
                            });

                            // 开始讲解
                            await speakContent(i + 1);
                            const expectedDuration = getSlideDuration(i + 1);
                            console.log(`⏳ 等待虚拟人讲解第${i + 1}页完成... (预计最长${(expectedDuration/1000).toFixed(1)}秒)`);

                            // 设置超时保护（仅作为兜底，正常应该由frame_stop触发）
                            const startTime = Date.now();
                            const timeoutPromise = new Promise(resolve => setTimeout(() => {
                                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                                console.log(`⚠️ 第${i + 1}页讲解超时(${elapsed}秒),继续下一页`);
                                isSpeaking = false;
                                speechFinishedResolve = null;
                                resolve();
                            }, expectedDuration));

                            // 等待讲解完成或超时
                            await Promise.race([speechPromise, timeoutPromise]);
                            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                            console.log(`✅ 第${i + 1}页讲解完成 (实际用时${elapsed}秒)`);

                            // 讲解完成后立即翻页，不需要额外等待
                            // frame_stop事件触发后应该立即进入下一页
                        } catch (error) {
                            console.error(`❌ 第${i + 1}页讲解异常:`, error);
                            isSpeaking = false;
                        }
                    } else {
                        console.log('⚠️ 虚拟人未连接,使用固定延时');
                        await new Promise(resolve => setTimeout(resolve, getSlideDuration(i + 1)));
                    }
                }

                if (isAutoPlaying) {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
            } catch (error) {
                console.error('❌ 自动播放失败:', error);
            } finally {
                isAutoPlaying = false;
                isSpeaking = false;
                document.getElementById('autoPlayBtn').disabled = false;
                window.playbackFinished = true;
                document.title = "PLAYBACK_FINISHED";
                console.log('🎉 播放完成');
            }
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); } else if (e.key === 'ArrowLeft') { e.preventDefault(); previousSlide(); } else if (e.key === 'Enter') { e.preventDefault(); speakContent(currentSlide + 1); } });
        document.getElementById('totalSlides').textContent = totalSlides; showSlide(0);
        setTimeout(() => { console.log('🚀 自动启动播放...'); startAutoPlay(); }, 3000);
    </script>
</body>
</html>
