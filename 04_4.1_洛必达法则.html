<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, initial-scale=1.0">
    <title>04_4.1_洛必达法则 (最终修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']], 
                displayMath: [['$$', '$$'], ['\\[', '\\]']], 
                processEscapes: true, 
                processEnvironments: true 
            },
            svg: { fontCache: 'global' },
            startup: { 
                pageReady: () => { 
                    return MathJax.startup.defaultPageReady().then(() => { 
                        console.log('✅ MathJax已加载'); 
                    }); 
                } 
            }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Noto Serif SC', serif; background: #1a1a2e; overflow: hidden; height: 100vh; width: 100vw; }
        .blackboard { width: 100vw; height: 100vh; background: #1a1a2e; position: relative; border: 10px solid #795548; margin: 0; }
        .avatar-container { position: fixed; top: 60%; left: 50%; transform: translate(-50%, -50%); width: 975px; height: 1105px; overflow: hidden; z-index: 50; pointer-events: none; background: transparent; }
        .wrapper { width: 100%; height: 100%; background: transparent; pointer-events: auto; }
        .slide-container { width: 100%; height: calc(100% - 100px); position: relative; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.6s ease-in-out; display: flex; justify-content: center; align-items: center; padding: 2rem; padding-bottom: 0; background-color: transparent; }
        .slide.active { opacity: 1; visibility: visible; }
        .slide-content { display: flex; flex-direction: row; gap: 2rem; width: 100%; height: 100%; max-height: 100%; }
        .chalkboard { flex: 0 0 45%; padding: 20px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .chalkboard h2 { color: #f1c40f; border-bottom: 2px solid #f39c12; font-size: 28px; padding-bottom: 10px; margin-bottom: 20px; }
        .chalkboard h3 { color: #1abc9c; font-size: 22px; margin-top: 20px; margin-bottom: 10px; }
        .chalkboard p, .chalkboard li, .chalkboard ul { color: #e0e0e0; font-size: 18px; line-height: 1.8; margin: 8px 0; }
        .chalkboard strong { color: #e74c3c; }
        .math-formula { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; border-left: 4px solid #f39c12; font-size: 20px; color: #1abc9c; text-align: center; margin: 15px 0; }
        .visualization { flex: 1; padding: 20px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .control-bar { position: fixed; left: -9999px; top: 50%; transform: translateY(-50%); width: 270px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); display: flex; flex-direction: column; gap: 12px; z-index: 200; border-radius: 0 20px 20px 0; padding: 25px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn { padding: 14px 22px; background: rgba(255, 255, 255, 0.25); color: #333; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; text-align: center; }
        .btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .subtitle-area { position: fixed; bottom: 10px; left: 50px; right: 50px; min-height: 60px; max-height: 90px; background: rgba(0,0,0,0.85); border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 100; color: white; font-size: 22px; text-align: center; padding: 15px 20px; line-height: 1.4; overflow-y: auto; }
        .status-indicator { position: absolute; top: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.5); color: white; border-radius: 5px; font-size: 16px; z-index: 100; display: none; }
        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); display: block; }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); display: block; }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); display: block; }
    </style>
</head>
<body class="blackboard">
    <div class="status-indicator" id="statusIndicator">等待连接</div>
    <div class="avatar-container"><div class="wrapper" id="avatarWrapper"></div></div>
    <div class="slide-container">
        
        <!-- Page 1: 对应语音1 -->
        <div class="slide active">
            <div class="slide-content">
                <div class="chalkboard" style="text-align: center;">
                    <h1 style="font-size: 2.8rem; font-weight: bold; color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.6);">洛必达法则</h1>
                    <p style="font-size: 1.2rem; color: #bdc3c7; margin-top: 1rem;">第4章 - 求解不定式极限的利器</p>
                    <div style="margin-top: 2.5rem; text-align: left; display: inline-block;">
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 不定式的概念与分类</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 洛必达法则的条件与应用</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 典型例题分步精讲</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 其他不定式的转化技巧</p>
                    </div>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <rect fill="rgba(231,76,60,0.2)" height="80" rx="10" stroke="#e74c3c" stroke-width="4" width="180" x="100" y="150"></rect>
                        <text fill="#ecf0f1" font-size="32" text-anchor="middle" x="190" y="200">lim f/g</text>
                        <text fill="#f39c12" font-size="40" text-anchor="middle" x="300" y="195">=</text>
                        <rect fill="rgba(46,204,113,0.2)" height="80" rx="10" stroke="#2ecc71" stroke-width="4" width="200" x="320" y="150"></rect>
                        <text fill="#ecf0f1" font-size="32" text-anchor="middle" x="420" y="200">lim f'/g'</text>
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="280">0/0 或 ∞/∞ 型</text>
                        <text fill="#2ecc71" font-size="20" text-anchor="middle" x="300" y="350">分子分母分别求导</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 2: 对应语音2 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>第一种困境：$\frac{0}{0}$ 型</h2>
                    <p>考虑这个极限：$\lim\limits_{x \to 0} \frac{\sin x}{x}$</p>
                    <p style="margin-top:20px;">如果直接代入 $x=0$ 会发生什么？ 我们得到了 $\frac{0}{0}$ 的形式！这在数学上叫做不定式，它的结果是不确定的。</p>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">经典例子</text>
                        <rect x="100" y="150" width="400" height="100" fill="rgba(255,255,255,0.1)" stroke="#ecf0f1" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="26" text-anchor="middle" x="300" y="210">lim (sin x) / x</text>
                        <text fill="#95a5a6" font-size="20" text-anchor="middle" x="300" y="240">x → 0</text>
                        <rect x="150" y="300" width="300" height="150" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3" rx="10">
                            <animate attributeName="opacity" dur="2s" values="0.5;1;0.5" repeatCount="indefinite"/>
                        </rect>
                        <text fill="#ecf0f1" font-size="70" text-anchor="middle" x="300" y="395">0/0</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 3: 对应语音3 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>第二种困境：$\frac{\infty}{\infty}$ 型</h2>
                     <p>考虑这个例子：$\lim\limits_{x \to +\infty} \frac{e^x}{x^2}$</p>
                    <p style="margin-top:20px;">当x趋于正无穷时，分子和分母都冲向了无穷大。我们得到的就是 $\frac{\infty}{\infty}$ 的形式。它的结果同样是不确定的。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">另一个例子</text>
                        <rect x="100" y="150" width="400" height="100" fill="rgba(255,255,255,0.1)" stroke="#ecf0f1" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="26" text-anchor="middle" x="300" y="210">lim e^x / x²</text>
                        <text fill="#95a5a6" font-size="20" text-anchor="middle" x="300" y="240">x → +∞</text>
                        <rect x="150" y="300" width="300" height="150" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3" rx="10">
                            <animate attributeName="opacity" dur="2s" values="0.5;1;0.5" repeatCount="indefinite" begin="0.5s"/>
                        </rect>
                        <text fill="#ecf0f1" font-size="60" text-anchor="middle" x="300" y="395">∞/∞</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 4: 对应语音4 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>如何解决不定式？ -> 洛必达法则</h2>
                    <p>面对 $\frac{0}{0}$ 和 $\frac{\infty}{\infty}$ 这两种不定式，我们引入一个强大的武器：<strong>洛必达法则</strong>。</p>
                    <p style="margin-top:30px; font-size:22px; color:#f39c12;">核心思想：当求 $\frac{f(x)}{g(x)}$ 的极限困难时，尝试求它们<strong>导数的比值</strong>的极限！</p>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">核心思想</text>
                        <rect x="100" y="150" width="400" height="80" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="200">lim f(x) / g(x)</text>
                        <text fill="#f39c12" font-size="40" text-anchor="middle" x="300" y="280">↓</text>
                        <rect x="100" y="320" width="400" height="80" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="370">lim f'(x) / g'(x)</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 5: 对应语音5 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>洛必达法则 ($\frac{0}{0}$ 型)</h2>
                    <p>当满足以下条件时，公式成立：$\lim\limits_{x \to a} \frac{f(x)}{g(x)} = \lim\limits_{x \to a} \frac{f'(x)}{g'(x)}$</p>
                    <p><strong>使用条件:</strong></p>
                    <p>1. 极限是 $\frac{0}{0}$ 型。</p>
                    <p>2. 在点 $a$ 的邻域内, $f(x)$ 和 $g(x)$ 可导, 且 $g'(x) \neq 0$。</p>
                    <p>3. $\lim\limits_{x \to a} \frac{f'(x)}{g'(x)}$ 存在（或为 $\infty$）。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">法则与条件 (0/0)</text>
                        <rect x="80" y="150" width="180" height="80" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="170" y="200">lim f/g</text>
                        <text fill="#f39c12" font-size="35" text-anchor="middle" x="300" y="195">=</text>
                        <rect x="340" y="150" width="180" height="80" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="10"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="430" y="200">lim f'/g'</text>
                        <text fill="#2ecc71" font-size="20" text-anchor="middle" x="300" y="350">前提：可导 & 导数极限存在</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 6: 对应语音6 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>洛必达法则 ($\frac{\infty}{\infty}$ 型)</h2>
                    <p>该法则同样适用于 $\frac{\infty}{\infty}$ 型！</p>
                    <p style="margin-top:20px;">只需将条件1改为：</p>
                    <p style="margin-left:20px; margin-top:15px;">$\lim\limits_{x \to a} f(x) = \infty$ 且 $\lim\limits_{x \to a} g(x) = \infty$</p>
                    <p style="margin-top:20px;">其他条件和结论完全相同。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">∞/∞ 型</text>
                        <rect x="100" y="180" width="400" height="150" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="230">极限类型</text>
                        <text fill="#3498db" font-size="50" text-anchor="middle" x="300" y="295">∞/∞</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 7: 对应语音7 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1：求解 $\lim\limits_{x \to 0} \frac{\sin x}{x}$</h2>
                    <p><strong>步骤1：检查类型</strong> → 是 $\frac{0}{0}$ 型。</p>
                    <p><strong>步骤2：应用法则</strong> (分子分母分别求导)</p>
                     <p>$\lim\limits_{x \to 0} \frac{(\sin x)'}{(x)'} = \lim\limits_{x \to 0} \frac{\cos x}{1}$</p>
                    <p><strong>步骤3：计算新极限</strong></p>
                    <p>$\frac{\cos 0}{1} = \frac{1}{1} = 1$</p>
                     <p style="margin-top:30px; color:#2ecc71; font-size:26px;"><strong>答案：1</strong></p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="80">例1 实战</text>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="180">lim (sin x) / x</text>
                        <text fill="#f39c12" font-size="30" text-anchor="middle" x="300" y="250">↓ 分别求导</text>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="320">lim (cos x) / 1 = 1</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 8: 对应语音8 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题2：求解 $\lim\limits_{x \to +\infty} \frac{e^x}{x^2}$</h2>
                    <p><strong>步骤1：检查类型</strong> → 是 $\frac{\infty}{\infty}$ 型。</p>
                    <p><strong>步骤2：第一次应用法则</strong></p>
                     <div class="math-formula">
                        $\lim\limits_{x \to +\infty} \frac{(e^x)'}{(x^2)'} = \lim\limits_{x \to +\infty} \frac{e^x}{2x}$
                    </div>
                     <p style="margin-top:20px; color:#e74c3c;">问题：新极限仍然是 $\frac{\infty}{\infty}$ 型！</p>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="80">第1次洛必达</text>
                        <rect x="100" y="150" width="400" height="70" fill="rgba(52,152,219,0.1)" stroke="#3498db" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="195">e^x / x²</text>
                        <line x1="300" y1="220" x2="300" y2="270" stroke="#f39c12" stroke-width="3"/>
                        <text fill="#f39c12" font-size="18" x="310" y="250">求导</text>
                        <rect x="100" y="270" width="400" height="70" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="315">e^x / 2x (仍是 ∞/∞)</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 9: 对应语音9 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例2 - 连续使用法则</h2>
                    <p style="color:#2ecc71; font-size:22px;">好消息：只要条件满足,可以<strong>连续使用</strong>洛必达法则！</p>
                    <p><strong>步骤3：第二次应用法则</strong></p>
                    <div class="math-formula">
                        $\lim\limits_{x \to +\infty} \frac{(e^x)'}{(2x)'} = \lim\limits_{x \to +\infty} \frac{e^x}{2}$
                    </div>
                    <p><strong>步骤4：计算最终结果</strong></p>
                     <div class="math-formula">
                        $\frac{+\infty}{2} = +\infty$
                    </div>
                    <p style="margin-top:30px; color:#f1c40f; font-size:26px;"><strong>答案：$+\infty$</strong></p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="80">第2次洛必达</text>
                        <rect x="100" y="150" width="400" height="70" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="195">e^x / 2x</text>
                        <line x1="300" y1="220" x2="300" y2="270" stroke="#f39c12" stroke-width="3"/>
                         <text fill="#f39c12" font-size="18" x="310" y="250">再次求导</text>
                        <rect x="100" y="270" width="400" height="70" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="315">e^x / 2 → +∞</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 10: 对应语音10 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>$0 \cdot \infty$ 型不定式</h2>
                    <p>形式：$\lim f(x)g(x)$, 其中 $\lim f(x) = 0, \lim g(x) = \infty$</p>
                    <p style="margin-top:30px; color:#e74c3c;">需要先<strong>转化</strong>为分式形式！</p>
                    <div class="math-formula">
                        $f \cdot g = \frac{f}{\frac{1}{g}}$ (化为 $\frac{0}{0}$) 或 $f \cdot g = \frac{g}{\frac{1}{f}}$ (化为 $\frac{\infty}{\infty}$)
                    </div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="60">转化策略</text>
                        <circle cx="300" cy="150" r="50" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="160">f·g</text>
                        <line x1="200" y1="210" x2="150" y2="280" stroke="#f39c12" stroke-width="2"/>
                        <line x1="400" y1="210" x2="450" y2="280" stroke="#f39c12" stroke-width="2"/>
                        <circle cx="150" cy="320" r="50" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="325">f/(1/g)</text>
                        <circle cx="450" cy="320" r="50" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="450" y="325">g/(1/f)</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 11: 对应语音11 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>$\infty - \infty$ 型不定式</h2>
                    <p>形式：$\lim [f(x)-g(x)]$, 其中 $\lim f(x) = \infty, \lim g(x) = \infty$</p>
                    <p style="margin-top:30px; color:#3498db;">转化策略：<strong>通分</strong>或<strong>有理化</strong>, 将其合并为一个分式。</p>
                    <p style="margin-top:20px;">例如：</p>
                    <div class="math-formula">
                        $\frac{1}{x-1} - \frac{1}{\ln x} = \frac{\ln x - (x-1)}{(x-1)\ln x}$
                    </div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="60">转化策略</text>
                        <circle cx="300" cy="180" r="60" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="190">f - g</text>
                        <line x1="300" y1="240" x2="300" y2="300" stroke="#f39c12" stroke-width="3"/>
                        <text fill="#f39c12" font-size="18" x="310" y="275">通分</text>
                        <circle cx="300" cy="360" r="60" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="370">A / B</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 12: 对应语音12 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>幂指函数型不定式 ($1^{\infty}, 0^0, \infty^0$)</h2>
                    <p>转化策略：<strong>取对数</strong></p>
                    <p style="margin-top:20px;"><strong>步骤1：</strong>设 $y = [f(x)]^{g(x)}$</p>
                    <p><strong>步骤2：</strong>两边取对数：$\ln y = g(x) \ln f(x)$</p>
                    <p><strong>步骤3：</strong>求 $\lim (\ln y) = L$。(此步通常化为 $0 \cdot \infty$ 型)</p>
                    <p><strong>步骤4：</strong>原极限 $= e^{L}$</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="60">转化步骤</text>
                        <rect x="80" y="120" width="440" height="60" fill="rgba(155,89,182,0.1)" stroke="#9b59b6" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="20" x="100" y="160">① 设 y = f(x)^g(x)</text>
                        <rect x="80" y="200" width="440" height="60" fill="rgba(155,89,182,0.1)" stroke="#9b59b6" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="20" x="100" y="240">② 取对数: ln y = g·ln f</text>
                        <rect x="80" y="280" width="440" height="60" fill="rgba(155,89,182,0.1)" stroke="#9b59b6" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="20" x="100" y="320">③ 求 lim(ln y) = L</text>
                        <rect x="80" y="360" width="440" height="60" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="2" rx="8"/>
                        <text fill="#ecf0f1" font-size="20" x="100" y="400">④ 原极限 = e^L</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 13: 对应语音13 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题3：求解 $\lim\limits_{x \to 0^+} x \ln x$</h2>
                    <p><strong>1. 类型：</strong> $0 \cdot \infty$ 型。</p>
                    <p><strong>2. 转化：</strong></p>
                    <div class="math-formula">
                        $\lim\limits_{x \to 0^+} \frac{\ln x}{\frac{1}{x}}$
                    </div>
                     <p>现在是 $\frac{\infty}{\infty}$ 型。</p>
                    <p><strong>3. 应用法则并求解：</strong></p>
                    <div class="math-formula">
                         $\lim\limits_{x \to 0^+} \frac{(\ln x)'}{\left(\frac{1}{x}\right)'} = \lim\limits_{x \to 0^+} \frac{\frac{1}{x}}{-\frac{1}{x^2}} = \lim\limits_{x \to 0^+} (-x) = 0$
                    </div>
                     <p style="margin-top:30px; color:#2ecc71; font-size:26px;"><strong>答案：0</strong></p>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="80">例3 实战</text>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="150">lim x ln x</text>
                        <text fill="#f39c12" font-size="20" text-anchor="middle" x="300" y="200">↓ 转化为 ∞/∞</text>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="250">lim (ln x) / (1/x)</text>
                        <text fill="#f39c12" font-size="20" text-anchor="middle" x="300" y="300">↓ 洛必达法则</text>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="350">lim (-x) = 0</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 14: 对应语音14 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>注意事项（一）</h2>
                    <p style="color:#e74c3c; font-size:24px;"><strong>必须先检查类型！</strong></p>
                    <p>只有当极限是不定式时,才能使用洛必达法则。滥用法则是最常见的错误！</p>
                    <p><strong>错误示例:</strong> $\lim\limits_{x \to 0} \frac{x+1}{x+2}$</p>
                    <p>这不是不定式！可以直接代入得 $\frac{1}{2}$。</p>
                    <p>如果误用洛必达法则会得到 $\lim\limits_{x \to 0} \frac{1}{1} = 1$，这是错误的。</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="26" text-anchor="middle" x="300" y="60">对比</text>
                        <rect x="80" y="120" width="440" height="100" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="3" rx="10"/>
                        <text fill="#e74c3c" font-size="28" text-anchor="middle" x="300" y="160">❌ 错误 (滥用洛必达)</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="195">lim (x+1)/(x+2) → lim 1/1 = 1</text>
                        <rect x="80" y="260" width="440" height="100" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#2ecc71" font-size="28" text-anchor="middle" x="300" y="300">✓ 正确 (直接代入)</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="335">lim (x+1)/(x+2) = 1/2</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 15: 对应语音15 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>注意事项（二）</h2>
                    <p style="color:#e74c3c; font-size:24px;"><strong>不是对商求导！</strong></p>
                    <p>洛必达法则是<strong>分子分母分别求导</strong>。</p>
                    <p><strong>✓ 洛必达法则：</strong></p>
                    <div class="math-formula" style="border-color:#2ecc71;">
                        $\lim \frac{f(x)}{g(x)} = \lim \frac{f'(x)}{g'(x)}$
                    </div>
                    <p>不要与<strong>商的求导法则</strong>混淆：</p>
                    <div class="math-formula" style="border-color:#e74c3c;">
                        $\left(\frac{f(x)}{g(x)}\right)' = \frac{f'(x)g(x) - f(x)g'(x)}{[g(x)]^2}$
                    </div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                         <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">对比</text>
                        <rect x="80" y="140" width="440" height="100" fill="rgba(46,204,113,0.1)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#2ecc71" font-size="24" text-anchor="middle" x="300" y="175">✓ 洛必达法则 (求极限)</text>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="300" y="210">lim f/g = lim f'/g'</text>
                        <rect x="80" y="280" width="440" height="100" fill="rgba(231,76,60,0.1)" stroke="#e74c3c" stroke-width="3" rx="10"/>
                        <text fill="#e74c3c" font-size="24" text-anchor="middle" x="300" y="315">✗ 商的求导 (求导数)</text>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="300" y="350">(f/g)' = (f'g-fg')/g²</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 16: 对应语音16 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>洛必达法则总结 (一)</h2>
                    <h3>核心公式</h3>
                    <div class="math-formula">
                        $\lim \frac{f(x)}{g(x)} = \lim \frac{f'(x)}{g'(x)}$
                    </div>
                    <h3>直接适用类型</h3>
                    <p style="font-size: 22px; color:#e74c3c;">• $\frac{0}{0}$ 型</p>
                    <p style="font-size: 22px; color:#3498db;">• $\frac{\infty}{\infty}$ 型</p>
                    <h3>使用前提</h3>
                     <p>1. 必须是不定式 <br> 2. 函数可导 & g'(x)≠0 <br> 3. 导数比值的极限存在</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="60">法则核心回顾</text>
                        <circle cx="300" cy="250" r="100" fill="rgba(241,196,15,0.3)" stroke="#f39c12" stroke-width="4">
                            <animate attributeName="r" dur="3s" values="100;110;100" repeatCount="indefinite"/>
                        </circle>
                        <text fill="#f1c40f" font-size="24" text-anchor="middle" x="300" y="245">洛必达法则</text>
                        <text fill="#f1c40f" font-size="18" text-anchor="middle" x="300" y="275">lim f/g = lim f'/g'</text>
                        <text fill="#e74c3c" font-size="20" text-anchor="middle" x="140" y="150">0/0 型</text>
                        <line x1="190" y1="180" x2="250" y2="220" stroke="#f39c12" stroke-width="2"/>
                        <text fill="#3498db" font-size="20" text-anchor="middle" x="460" y="150">∞/∞ 型</text>
                        <line x1="410" y1="180" x2="350" y2="220" stroke="#f39c12" stroke-width="2"/>
                        <text fill="#2ecc71" font-size="20" text-anchor="middle" x="300" y="400">前提：不定式 & 可导 & 极限存在</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 17: 对应语音17 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>洛必达法则总结 (二)</h2>
                    <h3>需要转化的类型</h3>
                    <p>遇到以下类型，需要先变形为 $\frac{0}{0}$ 或 $\frac{\infty}{\infty}$：</p>
                    <ul>
                        <li><strong>$0 \cdot \infty$ 型:</strong> 化为分式</li>
                        <li><strong>$\infty - \infty$ 型:</strong> 通分或有理化</li>
                        <li><strong>$1^{\infty}, 0^0, \infty^0$ 型:</strong> 取对数</li>
                    </ul>
                    <p style="margin-top: 25px; color: #f39c12; font-size:24px;"><strong>核心流程：</strong></p>
                    <p style="font-size:22px;"><strong>先判断 → 再转化 → 后求导</strong></p>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" style="width: 100%; height: 100%;">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="60">转化策略回顾</text>
                         <circle cx="150" cy="150" r="50" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="150" y="155">0·∞</text>
                        <circle cx="300" cy="150" r="50" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="300" y="155">∞-∞</text>
                        <circle cx="450" cy="150" r="50" fill="rgba(155,89,182,0.2)" stroke="#9b59b6" stroke-width="3"/>
                        <text fill="#ecf0f1" font-size="18" text-anchor="middle" x="450" y="155">1^∞</text>
                        <line x1="300" y1="200" x2="300" y2="280" stroke="#f39c12" stroke-width="3"/>
                        <text fill="#f39c12" font-size="20" text-anchor="middle" x="300" y="245">转化</text>
                        <rect x="150" y="300" width="300" height="80" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3" rx="10"/>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="345">0/0 或 ∞/∞</text>
                        <text fill="#2ecc71" font-size="20" text-anchor="middle" x="300" y="440">先判断，再转化，后求导！</text>
                    </svg>
                </div>
            </div>
        </div>

    </div>
    <div class="subtitle-area" id="subtitleArea">欢迎学习洛必达法则!</div>
    <div class="control-bar">
        <div style="color: #f1c40f; font-weight: bold; margin-bottom: 15px; text-align: center;">第 <span id="currentSlide">1</span> / <span id="totalSlides">17</span> 页</div>
        <button class="btn" id="prevBtn" onclick="previousSlide()">⬅️ 上一页</button>
        <button class="btn primary" id="startBtn" onclick="startTeaching()">🎀 开始讲课</button>
        <button class="btn" id="nextBtn" onclick="nextSlide()">下一页 ➡️</button>
        <button class="btn" onclick="restart()">🔄 重新开始</button>
        <button class="btn" id="autoPlayBtn" onclick="startAutoPlay()">🎬 自动播放</button>
    </div>
    <script type="module">
        // 虚拟人SDK加载代码
        window.playbackFinished = false; 
        try { 
            const { default: AvatarPlatform } = await import('./avatar-sdk-web_3.1.2.1002/index.js'); 
            window.AvatarPlatform = AvatarPlatform; 
            console.log('✅ 讯飞SDK模块已加载'); 
        } catch (error) { 
            console.error('❌ SDK加载失败:', error); 
        } 
        window.dispatchEvent(new CustomEvent('sdkReady'));
    </script>
    <script>
        const subtitleScript = {
            "1": "欢迎学习洛必达法则：求解不定式极限的利器。",
            "2": "当直接代入得到 0/0 时，我们称之为不定式，无法直接确定其值。",
            "3": "当变量趋于无穷，得到 ∞/∞ 时，这也是一种常见的不定式。",
            "4": "为解决不定式问题，我们引入一个强大的工具——洛必达法则。",
            "5": "洛必达法则(0/0型)：原极限等于其分子分母分别求导后的极限。",
            "6": "该法则同样适用于 ∞/∞ 型不定式，使用条件和结论完全相同。",
            "7": "例1(0/0型)：求 lim(sin x / x)，应用法则后得 lim(cos x / 1)，结果为1。",
            "8": "例2(∞/∞型)：求 lim(e^x / x²)，首次应用法则后得到 lim(e^x / 2x)。",
            "9": "新极限仍为 ∞/∞ 型，我们可以连续使用洛必达法则，最终得到 +∞。",
            "10": "其他不定式(0·∞型)：需先变形为 f/(1/g) 或 g/(1/f) 来创造分数形式。",
            "11": "其他不定式(∞-∞型)：通常通过通分或有理化，将其转化为 0/0 型。",
            "12": "其他不定式(幂指型)：通过取对数(ln)的方法，将其转化为 0·∞ 型。",
            "13": "例3(0·∞型)：求 lim(x ln x)，转化为 lim(ln x / (1/x)) 后应用法则，得0。",
            "14": "注意：必须先检查是否为不定式，否则滥用法则将导致错误结果。",
            "15": "注意：洛必达法则是分别求导，切勿与商的求导法则相混淆。",
            "16": "总结：洛必达法则的核心是转化不定式极限为导数的比值极限。",
            "17": "总结：对于复杂不定式，牢记先判断，再转化，后求导的原则。"
        };
        const speechScript = {
            "1": "同学们好！欢迎来到洛必达法则的学习。今天我们将学习一个非常重要且强大的工具，它专门用来求解不定式极限。这个法则在高等数学中应用非常广泛，掌握它能帮助我们轻松解决很多看似困难的极限问题。让我们开始吧！",
            "2": "我们来看一个经典的例子，求sinx除以x的极限，当x趋于0时。如果直接代入，分子sin0等于0，分母也是0。我们就得到了一个0比0的形式。这在数学上叫做不定式，它的结果是不确定的，不能想当然地认为是1或者0。",
            "3": "除了0比0，还有另一种常见的不定式。比如求e的x次方除以x平方的极限，当x趋于正无穷时。这时候，分子和分母都冲向了无穷大。我们得到的就是无穷比无穷的形式。它的结果同样是不确定的，需要特殊的工具来解决。",
            "4": "那么，如何解决这些棘手的不定式呢？今天，我们就来学习一个专门为此而生的强大武器，它的名字叫洛必达法则。这个法则的思路非常巧妙，它告诉我们，当一个分式的极限不好求时，我们可以试试看，求它的分子分母各自求导之后的那个新分式的极限。",
            "5": "我们先来看0比0型洛必达法则的严格定义。它有三个前提条件：第一，极限必须是0比0的形式。第二，分子分母函数在求极限点的附近要可导，并且分母的导数不能是0。第三，求导之后的新分式，它的极限必须存在。如果这三点都满足，那么原来的极限就等于求导后的新极限。",
            "6": "洛必达法则的强大之处在于，它不仅对0比0型有效，对我们刚才提到的无穷比无穷型，也完全适用。定理的内容几乎一模一样，只需要把第一个条件，从函数趋于0，改成函数趋于无穷大就可以了。其他条件和结论都保持不变。这一点非常方便我们记忆和使用。",
            "7": "理论说完了，我们来实战一下。回到最初的问题，求sinx除以x的极限。第一步，检查类型，是0比0型，满足条件。第二步，应用法则，对分子sinx求导得到cosx，对分母x求导得到1。第三步，计算新极限，cosx除以1的极限，就是cos0，等于1。问题轻松解决！",
            "8": "我们再来看无穷比无穷的例子，e的x次方除以x平方。第一步，检查类型，是无穷比无穷，满足条件。第二步，应用法则，分子求导还是e的x次方，分母求导是2x。我们得到的新极限是e的x次方除以2x。但是，我们发现一个问题，这个新极限仍然是无穷比无穷的形式！这该怎么办呢？",
            "9": "别担心，洛必达法则的另一个优点是，只要条件一直满足，我们就可以一直用下去！对于刚才得到的e的x次方除以2x，我们再次检查，它仍然是无穷比无穷型，所以，我们可以对它再次使用洛必达法则！分子求导还是e的x次方，分母求导变成了2。现在极限就非常清晰了，结果是正无穷。",
            "10": "到目前为止，我们只讨论了0比0和无穷比无穷这两种标准的不定式。但还有其他类型，比如0乘以无穷。对于这种，我们需要先做一个变形，把它写成分数形式。通常是把其中一个因子，写成1除以它的倒数的形式，放到分母上，这样就把它转化成了标准的0比0或者无穷比无穷型。",
            "11": "另一种类型是无穷减无穷。这种不定式通常出现在分式相减的情况。我们的策略是，通过通分，把两个分式合并成一个。这样一来，它通常就会变成我们熟悉的0比0型了，接下来就可以使用洛必达法则了。",
            "12": "最复杂的一类不定式是幂指函数型，比如1的无穷次方，0的0次方等等。对付它们的通用策略是取对数。我们先设原函数为y，然后两边取自然对数，利用对数的性质把指数拿下来。这样问题就转化成了求lny的极限，它通常是0乘以无穷型，我们就可以按照前面的方法处理。最后别忘了，求出来的是lny的极限L，原极限应该是e的L次方。",
            "13": "我们来看一个0乘以无穷的例子，求x乘以lnx的极限，当x从右侧趋于0时。这是典型的0乘以无穷型。我们把它变形为lnx除以x分之一。现在，它变成了无穷比无穷型，满足了洛必达法则的条件。分子求导是x分之一，分母求导是负x平方分之一，化简后等于负x，极限就是0。",
            "14": "学习了强大的工具，更要了解它的使用限制。最需要注意的一点是，使用前必须检查它是不是0比0或者无穷比无穷型！如果不是，比如一个极限可以直接代入算出结果，你却错误地用了洛必达，会得到一个完全错误的答案。所以，检查类型是铁律！",
            "15": "第二个常见的错误，是把洛必达法则和我们之前学的商的求导法则搞混了。请大家一定记住，洛必达法则是对分子和分母分别求导，它是一个求极限的技巧。而商的求导法则是求一个分式函数的导数，两者完全不是一回事。",
            "16": "好了，我们来总结一下洛必达法则的核心内容。它的公式是，原分式的极限等于导数分式的极限。它直接适用于0比0和无穷比无穷这两种不定式，并且使用时需要满足三个前提条件。这是法则的基础。",
            "17": "对于其他非标准类型的不定式，我们的核心思想是转化。0乘以无穷型化为分式；无穷减无穷型进行通分；而幂指型则取对数。请同学们牢记这个流程：先判断类型，再选择合适的转化方法，最后应用洛必达法则求导。谢谢大家！"
        };
        const actionMap = {
            "1": "A_RLH_welcome_O", "2": "A_RH_point_O", "3": "A_LH_introduced_O", "4": "A_RH_point_O",
            "5": "A_LH_introduced_O", "6": "A_LH_introduced_O", "7": "A_RH_point_O", "8": "A_LH_introduced_O",
            "9": "A_RH_point_O", "10": "A_LH_introduced_O", "11": "A_RH_point_O", "12": "A_LH_introduced_O",
            "13": "A_RH_point_O", "14": "A_LH_introduced_O", "15": "A_RH_point_O", "16": "A_LH_introduced_O", "17": "A_RLH_welcome_O"
        };

        let currentSlide = 0;
        const totalSlides = 17;
        let avatarPlatform = null;
        let isConnected = false;
        let isTeaching = false;
        let isAutoPlaying = false;
        let autoPageTimer = null; // 自动翻页定时器
        const slides = document.querySelectorAll('.slide');

        function showSlide(index) {
            slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            currentSlide = index;
            document.getElementById('currentSlide').textContent = index + 1;
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([slides[index]]).catch(err => console.error('MathJax 渲染失败:', err));
            }
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === totalSlides - 1;
            updateSubtitle(index + 1);
        }

        function nextSlide() { if (currentSlide < totalSlides - 1) { showSlide(currentSlide + 1); if (!isTeaching || isAutoPlaying) return; speakContent(currentSlide + 1); } }
        function previousSlide() { if (currentSlide > 0) { showSlide(currentSlide - 1); if (!isTeaching || isAutoPlaying) return; speakContent(currentSlide + 1); } }
        function restart() { isAutoPlaying = false; showSlide(0); if (avatarPlatform) { avatarPlatform.stop(); } document.getElementById('autoPlayBtn').disabled = false; document.getElementById('autoPlayBtn').textContent = '🎬 自动播放'; if(isTeaching) { speakContent(1); } }
        function updateSubtitle(slideNum) { const subtitleArea = document.getElementById('subtitleArea'); subtitleArea.textContent = subtitleScript[slideNum] || ''; }

        async function speakContent(slideNum) {
            if (!isTeaching || !isConnected || !avatarPlatform) { console.log('⚠️ 虚拟人未连接或未开始讲课'); return; }
            const content = speechScript[slideNum];
            if (!content) return;
            try {
                const action = actionMap[slideNum];
                if (action) { await avatarPlatform.writeCmd("action", action); }
                await avatarPlatform.writeText(content, { nlp: false });
                updateSubtitle(slideNum);
            } catch (error) { console.error('❌ 讲解失败:', error); }
        }

        function getSlideDuration(slideNum) {
            const speech = speechScript[slideNum];
            if (!speech) return 5000;
            // 估算时长：每分钟约200-250字，这里取每秒3.5个字，即每个字约285ms
            // 增加2秒的缓冲时间（用于停顿和翻页动画）
            return speech.length * 285 + 2000;
        }
        
        function updateStatus(message, type = 'normal') { const indicator = document.getElementById('statusIndicator'); if (indicator) { indicator.textContent = message; indicator.className = 'status-indicator'; if (type === 'connected') indicator.classList.add('connected'); else if (type === 'error') indicator.classList.add('error'); else if (type === 'connecting') indicator.classList.add('connecting'); } }

        function waitForSDK() {
            return new Promise((resolve, reject) => {
                if (window.AvatarPlatform) { resolve(); return; }
                const timeout = setTimeout(() => { reject(new Error('SDK加载超时')); }, 10000);
                window.addEventListener('sdkReady', function handler() { clearTimeout(timeout); window.removeEventListener('sdkReady', handler); resolve(); });
            });
        }

        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = '🔄 启动中...';
            startBtn.disabled = true;
            try {
                updateStatus('等待SDK...', 'connecting');
                await waitForSDK();
                if (typeof window.AvatarPlatform === 'undefined') {
                    console.warn("虚拟人SDK (AvatarPlatform) 未找到, 将无法播放语音和动作。");
                    updateStatus('SDK未加载', 'error');
                    startBtn.textContent = '❌ SDK未加载';
                    return;
                }
                if (avatarPlatform) { avatarPlatform.destroy(); }
                avatarPlatform = new window.AvatarPlatform({ useInlinePlayer: true });
                avatarPlatform.on('connected', (initResp) => {
                    isConnected = true;
                    isTeaching = true;
                    updateStatus('已连接', 'connected');
                    startBtn.textContent = '💖 虚拟人已就绪';
                    setTimeout(() => { speakContent(currentSlide + 1); }, 1000);
                }).on('disconnected', (err) => {
                    isConnected = false;
                    updateStatus('连接断开', 'error');
                }).on('error', (error) => {
                    console.error('❌ 错误:', error);
                    updateStatus('错误', 'error');
                    startBtn.textContent = '❌ 连接失败';
                    isTeaching = false;
                });
                avatarPlatform.setApiInfo({ appId: 'e8c180ed', apiKey: 'e0c44f0e2ef0f47582ffa7e864da0d9b', apiSecret: 'MDZkNDNiZWU4NDkzNWM5MDQzMTY4N2Nh', sceneId: '237415046114840576', serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact' });
                avatarPlatform.setGlobalParams({ stream: { protocol: 'xrtc', alpha: 1, bitrate: 1000000, fps: 25 }, avatar: { avatar_id: '110332017', width: 1920, height: 1080, scale: 1, move_h: 0, move_v: 0, audio_format: 1 }, tts: { vcn: 'x4_yiting', speed: 50, pitch: 50, volume: 100 }, avatar_dispatch: { interactive_mode: 1, content_analysis: 0 } });
                await avatarPlatform.start({ wrapper: document.getElementById('avatarWrapper') });
            } catch (error) {
                console.error('❌ 启动失败:', error);
                updateStatus('启动失败', 'error');
                startBtn.textContent = '🎀 开始讲课';
            }
        }

        async function startAutoPlay() {
            if (!isTeaching || !isConnected) {
                alert("请先等待虚拟人连接就绪。");
                return;
            }

            const autoPlayBtn = document.getElementById('autoPlayBtn');

            if (isAutoPlaying) {
                isAutoPlaying = false;
                autoPlayBtn.textContent = '🎬 继续播放';
                console.log('🛑 自动播放已暂停');
                return;
            }

            isAutoPlaying = true;
            autoPlayBtn.textContent = '⏸️ 暂停播放';
            console.log('▶️ 自动播放开始');

            for (let i = currentSlide; i < totalSlides; i++) {
                if (!isAutoPlaying) {
                    return;
                }
                
                showSlide(i);
                await speakContent(i + 1);

                const waitTime = getSlideDuration(i + 1);
                console.log(`第 ${i + 1} 页，语音时长估算 ${waitTime} ms.`);

                await new Promise(resolve => setTimeout(resolve, waitTime));
            }

            isAutoPlaying = false;
            autoPlayBtn.textContent = '🎬 自动播放';
            console.log('🎉 播放完成');
            window.playbackFinished = true;
            document.title = "PLAYBACK_FINISHED";
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
            else if (e.key === 'ArrowLeft') { e.preventDefault(); previousSlide(); }
        });

        // 自动翻页函数（立即翻页，无延迟）
        function startAutoPageTurn() {
            if (autoPageTimer) {
                clearInterval(autoPageTimer);
            }

            autoPageTimer = setInterval(() => {
                if (currentSlide < totalSlides - 1) {
                    nextSlide();
                    console.log(`📄 自动翻页到第 ${currentSlide + 1} 页`);
                } else {
                    clearInterval(autoPageTimer);
                    console.log('✅ 已到达最后一页，自动翻页结束');
                    window.playbackFinished = true;
                    document.title = "PLAYBACK_FINISHED";
                }
            }, 100); // 每100毫秒翻一页
        }

        document.getElementById('totalSlides').textContent = totalSlides;
        showSlide(0);

        // 自动启动虚拟人并开始播放
        setTimeout(() => {
            startTeaching().then(() => {
                // 等待虚拟人连接成功后，立即开始播放和翻页
                const checkConnection = setInterval(() => {
                    if (isConnected && isTeaching) {
                        clearInterval(checkConnection);
                        console.log('✅ 虚拟人已连接，立即开始播放和翻页...');
                        startAutoPlay();
                        startAutoPageTurn(); // 启动自动翻页
                    }
                }, 500);
            });
        }, 1500);

    </script>
</body>
</html>