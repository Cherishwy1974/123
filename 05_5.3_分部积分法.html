<!DOCTYPE html>
<html lang="zh-CN">
<!--
    LaTeX 公式渲染修复说明：
    1. MathJax 配置已优化，支持单反斜杠和双反斜杠格式
    2. 添加了 renderMath() 和 forceRerenderMath() 函数处理幻灯片切换后的公式渲染
    3. HTML 中的 LaTeX 公式统一使用单反斜杠格式（如 \int, \frac）
    4. JavaScript 字符串中的 LaTeX 公式使用双反斜杠格式（如 \\int, \\frac）
    5. 添加了"重新渲染公式"按钮供用户手动修复渲染问题

    修复日期：2025-10-19
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, initial-scale=1.0">
    <title>05_5.3_分部积分法 (扩展版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- MathJax 配置：兼容单反斜杠和双反斜杠格式 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,      // 处理转义字符
                processEnvironments: true, // 处理环境
                processRefs: true,         // 处理引用
                packages: {'[+]': ['base', 'ams', 'noerrors', 'color', 'newcommand']}  // 添加错误处理包
            },
            svg: { fontCache: 'global' },
            chtml: {
                scale: 1,
                minScale: 0.5,
                matchFontHeight: false,
                displayAlign: 'center',
                displayIndent: '0'
            },
            options: {
                enableMenu: false,
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('✅ MathJax已加载并就绪');
                    });
                }
            }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Noto Serif SC', serif; background: #1a1a2e; overflow: hidden; height: 100vh; width: 100vw; }
        .blackboard { width: 100vw; height: 100vh; background: #1a1a2e; position: relative; border: 10px solid #795548; margin: 0; }
.avatar-container { position: fixed; bottom: 24px; right: 24px; transform: none; width: 420px; height: 480px; overflow: hidden; z-index: 50; pointer-events: none; background: transparent; }
        .wrapper { width: 100%; height: 100%; background: transparent; pointer-events: auto; }
        .slide-container { width: 100%; height: 100%; position: relative; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.6s ease-in-out; display: flex; justify-content: center; align-items: center; padding: 2rem; background-color: transparent; }
        .slide.active { opacity: 1; visibility: visible; }
        .slide-content { display: flex; flex-direction: row; gap: 2rem; width: 100%; height: 95%; }
        .chalkboard { flex: 0 0 45%; padding: 20px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .chalkboard h2 { color: #f1c40f; border-bottom: 2px solid #f39c12; font-size: 28px; padding-bottom: 10px; margin-bottom: 20px; }
        .chalkboard h3 { color: #1abc9c; font-size: 22px; margin-top: 20px; margin-bottom: 10px; }
        .chalkboard p, .chalkboard li { color: #e0e0e0; font-size: 18px; line-height: 1.8; margin: 8px 0; }
        .chalkboard strong { color: #e74c3c; }
        .math-formula { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; border-left: 4px solid #f39c12; font-size: 20px; color: #1abc9c; text-align: center; margin: 15px 0; }
        .visualization { flex: 1; padding: 20px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .control-bar { position: fixed; left: -9999px; top: 50%; transform: translateY(-50%); width: 270px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); display: flex; flex-direction: column; gap: 12px; z-index: 200; border-radius: 0 20px 20px 0; padding: 25px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn { padding: 14px 22px; background: rgba(255, 255, 255, 0.25); color: #333; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; text-align: center; }
        .btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .subtitle-area { position: absolute; bottom: 20px; left: 50px; right: 50px; min-height: 50px; background: rgba(0,0,0,0.8); border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 60; color: white; font-size: 23px; text-align: center; padding: 15px 20px; line-height: 1.4; }
        .status-indicator { position: absolute; top: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.5); color: white; border-radius: 5px; font-size: 16px; z-index: 100; display: none; }
        .status-indicator.connected { background: rgba(76, 175, 80, 0.8); display: block; }
        .status-indicator.error { background: rgba(244, 67, 54, 0.8); display: block; }
        .status-indicator.connecting { background: rgba(255, 152, 0, 0.8); display: block; }
    </style>
</head>
<body class="blackboard">
    <div class="status-indicator" id="statusIndicator">等待连接</div>
    <div class="avatar-container"><div class="wrapper" id="avatarWrapper"></div></div>
    <div class="slide-container">
        
        <!-- Page 1: Title -->
        <div class="slide active">
            <div class="slide-content">
                <div class="chalkboard" style="text-align: center;">
                    <h1 style="font-size: 2.8rem; font-weight: bold; color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.6);">分部积分法</h1>
                    <p style="font-size: 1.2rem; color: #bdc3c7; margin-top: 1rem;">第5章 - 积分的"乘法法则"</p>
                    <div style="margin-top: 2.5rem; text-align: left; display: inline-block;">
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 公式推导与理解</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ u 和 dv 的选择策略</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 典型例题分步精讲</p>
                        <p style="font-size: 1rem; margin: 0.8rem 0; color: #e0e0e0;">✓ 多次分部积分技巧</p>
                    </div>
                </div>
                <div class="visualization">
                     <svg class="w-full h-full" viewBox="0 0 600 500">
                        <rect fill="rgba(52,152,219,0.2)" height="70" rx="10" stroke="#3498db" stroke-width="4" width="140" x="120" y="150"></rect>
                        <text fill="#ecf0f1" font-size="28" text-anchor="middle" x="190" y="195">∫u dv</text>
                        <text fill="#f39c12" font-size="40" text-anchor="middle" x="300" y="190">=</text>
                        <rect fill="rgba(46,204,113,0.2)" height="70" rx="10" stroke="#2ecc71" stroke-width="4" width="200" x="340" y="150"></rect>
                        <text fill="#ecf0f1" font-size="28" text-anchor="middle" x="440" y="185">uv</text>
                        <text fill="#e74c3c" font-size="28" text-anchor="middle" x="440" y="215">- ∫v du</text>
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="300">处理乘积的积分</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 2: The Problem -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>问题的提出</h2>
                    <p>换元法善于处理<strong>复合函数</strong>的积分。</p>
                    <p>但如果被积函数是两个<strong>独立函数相乘</strong>的形式,换元法往往会失效。</p>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="100">换元法的局限</text>
                        <rect x="100" y="180" width="400" height="80" rx="10" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"></rect>
                        <text x="300" y="230" fill="#ecf0f1" font-size="24" text-anchor="middle">复合函数 ✓</text>
                        <rect x="100" y="300" width="400" height="80" rx="10" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"></rect>
                        <text x="300" y="350" fill="#e74c3c" font-size="24" text-anchor="middle">函数乘积 ✗</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 3: Example of the Problem -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>一个具体的例子</h2>
                    <p>例如,下面这个积分:</p>
                     <div class="math-formula" style="border-color:#e74c3c;">$\int x \cos(x) \, dx = ?$</div>
                    <p>我们很难找到一个合适的 $u$ 使得它的微分 $du$ 也恰好存在。</p>
                    <p>我们需要一个专门处理<strong>乘积形式</strong>积分的方法。</p>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">新挑战:乘积的积分</text>
                        <rect x="100" y="150" width="400" height="100" rx="10" fill="rgba(231,76,60,0.2)" stroke="#e74c3c"></rect>
                        <text x="300" y="205" fill="#e74c3c" font-size="32" text-anchor="middle">∫ x · cos(x) dx</text>
                        <text x="300" y="350" fill="#ecf0f1" font-size="24">换元法似乎行不通...</text>
                        <text x="300" y="400" fill="#f1c40f" font-size="40">?</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 4: Source of Idea -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>思路来源:乘积求导法则</h2>
                    <p>和换元法一样,分部积分法的理论基础也是求导法则的逆运算。</p>
                    <p>这次是<strong>乘积求导法则</strong>。</p>
                    <h3>回顾乘积求导</h3>
                    <div class="math-formula">$[u(x)v(x)]' = u'(x)v(x) + u(x)v'(x)$</div>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">理论基础</text>
                        <rect x="100" y="150" width="400" height="80" rx="10" fill="rgba(255,255,255,0.1)"></rect>
                        <text x="300" y="200" fill="#ecf0f1" font-size="24" text-anchor="middle">(uv)' = u'v + uv'</text>
                        <text x="300" y="320" fill="#1abc9c" font-size="22" text-anchor="middle">乘积求导法则</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 5: Derivation Step 1 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>公式推导 - 第一步</h2>
                    <p>将乘积求导公式两边同时积分:</p>
                    <div class="math-formula">$[u(x)v(x)]' = u'(x)v(x) + u(x)v'(x)$</div>
                    <p>两边积分:</p>
                    <div class="math-formula">$u(x)v(x) = \int u'(x)v(x) \, dx + \int u(x)v'(x) \, dx$</div>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">推导过程</text>
                        <rect x="100" y="120" width="400" height="60" rx="10" fill="rgba(255,255,255,0.1)"></rect>
                        <text x="300" y="155" fill="#ecf0f1" font-size="20" text-anchor="middle">(uv)' = u'v + uv'</text>
                        <line x1="300" y1="180" x2="300" y2="240" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></line>
                        <text x="315" y="215" fill="#f39c12">两边积分</text>
                        <rect x="80" y="240" width="440" height="80" rx="10" fill="rgba(255,255,255,0.1)"></rect>
                        <text x="300" y="285" fill="#ecf0f1" font-size="18" text-anchor="middle">uv = ∫u'v dx + ∫uv' dx</text>
                        <defs><marker id="arrow-part" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#f39c12"/></marker></defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 6: Derivation Step 2 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>公式推导 - 第二步</h2>
                    <p>移项整理,我们就得到了<strong>分部积分公式</strong>:</p>
                    <div class="math-formula">
                        $$u(x)v(x) = \int u'(x)v(x) \, dx + \int u(x)v'(x) \, dx$$
                    </div>
                    <p>移项后:</p>
                    <div class="math-formula" style="border-color:#2ecc71;">$\int u(x)v'(x) \, dx = u(x)v(x) - \int u'(x)v(x) \, dx$</div>
                </div>
                <div class="visualization">
                     <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">公式的诞生</text>
                        <rect x="80" y="120" width="440" height="60" rx="10" fill="rgba(255,255,255,0.1)"></rect>
                        <text x="300" y="155" fill="#ecf0f1" font-size="18" text-anchor="middle">uv = ∫u'v dx + ∫uv' dx</text>
                         <line x1="300" y1="180" x2="300" y2="240" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></line>
                        <text x="315" y="215" fill="#f39c12">移项</text>
                         <rect x="60" y="260" width="480" height="100" rx="10" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"></rect>
                        <text x="300" y="315" fill="#2ecc71" font-size="20" text-anchor="middle">∫uv' dx = uv - ∫u'v dx</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 7: The Formula in Differential Form -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>分部积分公式</h2>
                    <p>为了书写方便,我们通常使用微分形式:</p>
                    <p>记 $du = u'(x)dx$, $dv = v'(x)dx$</p>
                    <p>公式就变成了简洁而优美的形态:</p>
                     <div class="math-formula" style="font-size:28px;">$\int u \, dv = uv - \int v \, du$</div>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">分部积分公式</text>
                        <rect x="50" y="180" width="500" height="120" rx="15" fill="rgba(0,0,0,0.3)" stroke="#f39c12" stroke-width="3"></rect>
                        <text fill="#1abc9c" font-size="40" text-anchor="middle" x="300" y="255">∫ u dv = uv - ∫ v du</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 8: Core Idea -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>核心思想</h2>
                    <p>将一个不易积分的 $\int u \, dv$,转化为另一个可能更容易积分的 $\int v \, du$。</p>
                    <p style="color: #e74c3c; margin-top: 2rem;">成败的关键,在于如何明智地选择谁是 $u$,谁是 $dv$。</p>
                </div>
                 <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">转化的艺术</text>
                        <rect x="80" y="150" width="180" height="80" rx="10" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"></rect>
                        <text x="170" y="195" fill="#e74c3c" font-size="24" text-anchor="middle">∫ u dv</text>
                        <text x="300" y="195" fill="#f39c12" font-size="32">→</text>
                        <rect x="340" y="150" width="180" height="80" rx="10" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"></rect>
                        <text x="430" y="195" fill="#2ecc71" font-size="24" text-anchor="middle">∫ v du</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="300">目标:让右边的积分比左边的更简单!</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 9: Selection Principle -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>如何选择 u 和 dv?</h2>
                    <p>选择的基本原则:</p>
                    <p><strong>1.</strong> 按照 $u$ 的选择优先级口诀。</p>
                    <p><strong>2.</strong> $dv$ 必须是容易积分的。</p>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="80">选择原则</text>
                        <rect x="100" y="150" width="400" height="80" rx="10" fill="rgba(52,152,219,0.2)" stroke="#3498db" stroke-width="3"></rect>
                        <text x="300" y="200" fill="#ecf0f1" font-size="22" text-anchor="middle">u 的优先级口诀</text>
                        <rect x="100" y="270" width="400" height="80" rx="10" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"></rect>
                        <text x="300" y="320" fill="#ecf0f1" font-size="22" text-anchor="middle">dv 容易积分</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 10: The Mnemonic -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>$u$ 的选择优先级口诀</h2>
                    <p><strong>"反对幂三指"</strong></p>
                    <p>这是一个按优先级从高到低的顺序,帮助我们决定谁更适合做 $u$:</p>
                    <ul style="margin-top: 1.5rem;">
                        <li><strong>反</strong>: 反三角函数 (如 $\arctan x$)</li>
                        <li><strong>对</strong>: 对数函数 (如 $\ln x$)</li>
                        <li><strong>幂</strong>: 幂函数 (如 $x^2, x^3$)</li>
                        <li><strong>三</strong>: 三角函数 (如 $\sin x, \cos x$)</li>
                        <li><strong>指</strong>: 指数函数 (如 $e^x$)</li>
                    </ul>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="28" text-anchor="middle" x="300" y="60">反对幂三指</text>
                        <text x="300" y="120" font-size="24" fill="#e74c3c" text-anchor="middle">反 (arctan)</text>
                        <text x="300" y="190" font-size="24" fill="#3498db" text-anchor="middle">对 (ln x)</text>
                        <text x="300" y="260" font-size="24" fill="#2ecc71" text-anchor="middle">幂 (xⁿ)</text>
                        <text x="300" y="330" font-size="24" fill="#9b59b6" text-anchor="middle">三 (sin x)</text>
                        <text x="300" y="400" font-size="24" fill="#f1c40f" text-anchor="middle">指 (eˣ)</text>
                        <path d="M 300 130 V 370" stroke-width="3" stroke="#fff" marker-start="url(#arrow-up)" marker-end="url(#arrow-down)"></path>
                        <text x="350" y="250" font-size="18" fill="#fff">优先级</text>
                        <defs>
                            <marker id="arrow-down" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#fff"/></marker>
                            <marker id="arrow-up" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto-start-reverse"><path d="M0,0 L0,6 L9,3 z" fill="#fff"/></marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 11: Example 1 - Introduction -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1:$\int x e^x \, dx$</h2>
                    <p>被积函数是 $x \cdot e^x$。</p>
                    <p>这是一个<strong>幂函数</strong>和<strong>指数函数</strong>的乘积。</p>
                </div>
                 <div class="visualization">
                     <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">例1: ∫x·e^x dx</text>
                        <rect x="100" y="180" width="400" height="100" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12" stroke-width="3"></rect>
                        <text x="300" y="240" fill="#ecf0f1" font-size="28" text-anchor="middle">x · eˣ</text>
                        <text fill="#2ecc71" font-size="22" text-anchor="middle" x="200" y="350">幂函数</text>
                        <text fill="#3498db" font-size="22" text-anchor="middle" x="400" y="350">指数函数</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 12: Example 1 - Setup -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1 - 选择 u 和 dv</h2>
                    <p>根据"反对幂三指"口诀,<strong>幂函数($x$)</strong>的优先级高于<strong>指数函数($e^x$)</strong>。</p>
                    <p>因此我们选择:</p>
                    <div class="math-formula" style="border-color:#2ecc71;">$u = x$</div>
                     <div class="math-formula" style="border-color:#3498db;">$dv = e^x \\, dx$</div>
                </div>
                 <div class="visualization">
                     <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">选择 u 和 dv</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="140">口诀: 反对<tspan fill="#2ecc71">幂</tspan>三<tspan fill="#3498db">指</tspan></text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="200">幂函数优先级更高</text>
                        
                        <rect fill="rgba(46,204,113,0.2)" height="80" rx="10" stroke="#2ecc71" stroke-width="3" width="180" x="80" y="280"></rect>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="170" y="325">u = x</text>
                        <rect fill="rgba(52,152,219,0.2)" height="80" rx="10" stroke="#3498db" stroke-width="3" width="180" x="340" y="280"></rect>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="430" y="325">dv = eˣ dx</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 13: Example 1 - Calculate du and v -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1 - 计算 du 和 v</h2>
                    <p>我们已经确定了 $u$ 和 $dv$:</p>
                    <p>$u = x \implies$ 两边微分 $\implies du = dx$</p>
                    <p>$dv = e^x dx \implies$ 两边积分 $\implies v = \int e^x dx = e^x$</p>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">计算 du 和 v</text>
                        <text fill="#2ecc71" font-size="22" x="150" y="160">u = x</text>
                        <text fill="#3498db" font-size="22" x="380" y="160">dv = eˣ dx</text>
                        <path d="M 200 170 L 200 220" stroke="#fff" marker-end="url(#arrow-part)"></path>
                        <path d="M 430 170 L 430 220" stroke="#fff" marker-end="url(#arrow-part)"></path>
                        <text fill="#2ecc71" font-size="22" x="150" y="260">du = dx</text>
                        <text fill="#3498db" font-size="22" x="380" y="260">v = eˣ</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 14: Example 1 - Apply Formula -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1 - 套用公式</h2>
                    <p>将 $u, v, du, dv$ 代入分部积分公式:</p>
                    <div class="math-formula">$\int u \, dv = uv - \int v \, du$</div>
                    <p>代入得:</p>
                    <div class="math-formula" style="border-color:#1abc9c;">$\int x e^x \, dx = x e^x - \int e^x \, dx$</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">套用公式</text>
                        <rect x="50" y="140" width="500" height="80" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12"></rect>
                        <text x="300" y="190" fill="#ecf0f1" font-size="20" text-anchor="middle">∫udv = uv - ∫vdu</text>
                        <line x1="300" y1="220" x2="300" y2="280" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></line>
                        <rect x="50" y="300" width="500" height="100" rx="10" fill="rgba(26,188,156,0.2)" stroke="#1abc9c" stroke-width="3"></rect>
                        <text x="300" y="360" fill="#1abc9c" font-size="22" text-anchor="middle">∫x eˣ dx = x·eˣ - ∫eˣ dx</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Page 15: Example 1 - Final Step -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题1 - 求解新积分</h2>
                    <p>现在,我们只需要解决转化后的新积分:</p>
                     <div class="math-formula">$\int e^x \, dx = e^x$</div>
                    <p>代回原式,并加上常数 $C$:</p>
                    <div class="math-formula" style="border-color:#2ecc71;">$x e^x - e^x + C$</div>
                </div>
                <div class="visualization">
                    <svg viewBox="0 0 600 500" class="w-full h-full">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">求解新积分</text>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="150">x·eˣ - ∫eˣ dx</text>
                        <line x1="300" y1="180" x2="300" y2="250" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></line>
                        <text x="315" y="220" fill="#f39c12">求解</text>
                        <text fill="#ecf0f1" font-size="22" text-anchor="middle" x="300" y="300">x·eˣ - eˣ</text>
                         <rect x="100" y="360" width="400" height="80" rx="10" fill="rgba(46,204,113,0.2)" stroke="#2ecc71"></rect>
                        <text x="300" y="405" fill="#2ecc71" font-size="24" text-anchor="middle">x·eˣ - eˣ + C</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 16: Example 2 Introduction -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题2:$\int \ln x \, dx$</h2>
                    <p>这个积分看起来只有一个函数,如何分部?</p>
                    <p><strong>技巧:</strong> 我们可以把它看作 $\int \ln x \cdot 1 \, dx$。</p>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">例2: ∫ln(x) dx</text>
                        <rect x="100" y="180" width="400" height="80" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12" stroke-width="3"></rect>
                        <text x="300" y="230" fill="#ecf0f1" font-size="28" text-anchor="middle">ln(x)</text>
                        <text fill="#e74c3c" font-size="22" text-anchor="middle" x="300" y="340">只有一个函数?</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 17: Example 2 Trick -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题2 - 巧妙的技巧</h2>
                    <p>将 $\int \ln x \, dx$ 改写为:</p>
                     <div class="math-formula">$\int \ln x \cdot 1 \, dx$</div>
                    <p>现在它变成了两个函数的乘积!</p>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">巧妙的改写</text>
                        <rect x="100" y="150" width="400" height="80" rx="10" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"></rect>
                        <text x="300" y="200" fill="#ecf0f1" font-size="24" text-anchor="middle">∫ln(x) dx</text>
                        <line x1="300" y1="230" x2="300" y2="290" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></line>
                        <rect x="100" y="310" width="400" height="80" rx="10" fill="rgba(46,204,113,0.2)" stroke="#2ecc71" stroke-width="3"></rect>
                        <text x="300" y="360" fill="#ecf0f1" font-size="24" text-anchor="middle">∫ln(x)·1 dx</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 18: Example 2 Selection -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题2 - 选择 u 和 dv</h2>
                    <p>根据"反对幂三指",<strong>对数($\ln x$)</strong>优先级高于<strong>幂($1=x^0$)</strong>。</p>
                    <ul style="margin-top: 1.5rem;">
                        <li>设 $u=\ln x$, $dv=1 \cdot dx$</li>
                        <li>则 $du=\frac{1}{x}dx$, $v=x$</li>
                    </ul>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">选择 u 和 dv</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="140">口诀: 反<tspan fill="#e74c3c">对</tspan><tspan fill="#2ecc71">幂</tspan>三指</text>
                        <rect fill="rgba(231,76,60,0.2)" height="60" rx="10" stroke="#e74c3c" stroke-width="3" width="300" x="150" y="200"></rect>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="235">u=ln(x), dv=1·dx</text>
                        <line marker-end="url(#arrow-part)" stroke="#f39c12" stroke-width="3" x1="300" x2="300" y1="260" y2="310"></line>
                        <rect fill="rgba(52,152,219,0.2)" height="60" rx="10" stroke="#3498db" stroke-width="3" width="300" x="150" y="330"></rect>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="365">du=dx/x, v=x</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 19: Example 2 Solution -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题2 - 套用公式求解</h2>
                    <p>套用公式:</p>
                     <div class="math-formula">$uv - \int v \, du = x \ln x - \int x \cdot \frac{1}{x} dx$</div>
                    <p>化简:</p>
                    <div class="math-formula" style="border-color:#2ecc71;">$= x \ln x - \int 1 \, dx = x \ln x - x + C$</div>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">套用公式</text>
                        <rect x="50" y="140" width="500" height="80" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12" stroke-width="3"></rect>
                        <text x="300" y="190" fill="#ecf0f1" font-size="18" text-anchor="middle">x·ln(x) - ∫x·(1/x)dx</text>
                        <line marker-end="url(#arrow-part)" stroke="#f39c12" stroke-width="3" x1="300" x2="300" y1="220" y2="280"></line>
                        <rect fill="rgba(46,204,113,0.2)" height="80" rx="10" stroke="#2ecc71" stroke-width="3" width="400" x="100" y="300"></rect>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="350">xln(x) - x + C</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 20: Repeated Application Intro -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>进阶技巧:多次分部积分</h2>
                    <p>有时,使用一次分部积分后,得到的 $\int v \, du$ 仍然是一个需要分部积分的乘积形式。</p>
                    <p>例如:</p>
                    <div class="math-formula">$\int x^2 \sin(x) \, dx$</div>
                </div>
                 <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">例3: ∫x²sin(x) dx</text>
                        <rect x="100" y="180" width="400" height="100" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12" stroke-width="3"></rect>
                        <text x="300" y="240" fill="#ecf0f1" font-size="28" text-anchor="middle">x² · sin(x)</text>
                        <text fill="#e74c3c" font-size="20" text-anchor="middle" x="300" y="350">更复杂的情况</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 21: Repeated Application Step 1 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题3 - 第一次分部积分</h2>
                    <p>根据口诀,我们选 $u=x^2, dv=\sin(x)dx$。</p>
                    <p>$du = 2x dx, v = -\cos(x)$。</p>
                    <p>套用公式:</p>
                    <div class="math-formula" style="border-color:#e74c3c;">$= -x^2\cos(x) + 2 \int x \cos(x) \, dx$</div>
                </div>
                 <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">第一次分部积分</text>
                        <rect x="50" y="150" width="500" height="120" rx="10" fill="rgba(0,0,0,0.2)" stroke="#f39c12"></rect>
                        <text x="300" y="220" fill="#1abc9c" font-size="22" text-anchor="middle">-x²cos(x) + 2<tspan fill="#e74c3c">∫x cos(x) dx</tspan></text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 22: Repeated Application Step 2 -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>例题3 - 第二次分部积分</h2>
                    <p>新的积分 $\int x \cos(x) \, dx$ 仍然是乘积形式,需要再次使用分部积分法!</p>
                    <p>这次选择 $u=x, dv=\cos(x)dx$。</p>
                    <p>继续求解即可得到最终答案。</p>
                </div>
                 <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="24" text-anchor="middle" x="300" y="70">第二次分部积分</text>
                        <rect x="100" y="150" width="400" height="80" rx="10" fill="rgba(231,76,60,0.2)" stroke="#e74c3c" stroke-width="3"></rect>
                        <text x="300" y="200" fill="#e74c3c" font-size="24" text-anchor="middle">∫x cos(x) dx</text>
                        <text fill="#f39c12" font-size="40" text-anchor="middle" x="300" y="320">🔄</text>
                        <text fill="#ecf0f1" font-size="20" text-anchor="middle" x="300" y="380">再次使用分部积分</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 23: Summary - Formula -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>分部积分法总结</h2>
                    <h3>核心公式</h3>
                    <div class="math-formula">$\int u \, dv = uv - \int v \, du$</div>
                    <p style="margin-top: 1.5rem;">这个公式实现了积分的转化,让复杂的积分变得简单。</p>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">核心公式</text>
                        <rect x="50" y="180" width="500" height="120" rx="15" fill="rgba(0,0,0,0.3)" stroke="#f39c12" stroke-width="3"></rect>
                        <text fill="#1abc9c" font-size="40" text-anchor="middle" x="300" y="255">∫ u dv = uv - ∫ v du</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 24: Summary - Strategy -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard">
                    <h2>核心策略</h2>
                    <ol class="list-decimal list-inside mt-4 space-y-3">
                        <li><strong>识别:</strong> 被积函数是否为两个函数相乘。</li>
                        <li><strong>选择:</strong> 使用"反对幂三指"口诀选择 $u$。</li>
                        <li><strong>计算:</strong> 求出 $du$ 和 $v$。</li>
                        <li><strong>转化:</strong> 套用公式,得到 $uv - \int v du$。</li>
                        <li><strong>求解:</strong> 计算新积分 $\int v du$ (可能需要再次分部)。</li>
                    </ol>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="32" text-anchor="middle" x="300" y="80">解题流程</text>
                        <path d="M 300 120 V 400" stroke="#f39c12" stroke-width="3" marker-end="url(#arrow-part)"></path>
                        <text x="300" y="140" fill="#ecf0f1" text-anchor="middle">识别乘积</text>
                        <text x="300" y="210" fill="#ecf0f1" text-anchor="middle">按口诀选 u</text>
                        <text x="300" y="280" fill="#ecf0f1" text-anchor="middle">计算 du 和 v</text>
                        <text x="300" y="350" fill="#ecf0f1" text-anchor="middle">套用公式</text>
                        <text x="300" y="420" fill="#ecf0f1" text-anchor="middle">求解新积分</text>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Page 25: Final Words -->
        <div class="slide">
            <div class="slide-content">
                <div class="chalkboard" style="text-align: center;">
                    <h2 style="color: #f1c40f;">课程总结</h2>
                    <p style="margin-top: 2rem; font-size: 1.1rem;">分部积分法是与换元法并列的两大积分基石。</p>
                    <p style="margin-top: 1.5rem; font-size: 1.1rem;">掌握"反对幂三指"口诀,是成功的关键。</p>
                    <p style="margin-top: 1.5rem; font-size: 1.1rem;">多加练习,熟能生巧!</p>
                    <p style="margin-top: 3rem; color: #1abc9c; font-size: 1.3rem;">感谢学习!</p>
                </div>
                <div class="visualization">
                    <svg class="w-full h-full" viewBox="0 0 600 500">
                        <text fill="#f39c12" font-size="48" text-anchor="middle" x="300" y="200">🎓</text>
                        <text fill="#1abc9c" font-size="32" text-anchor="middle" x="300" y="280">课程完成</text>
                        <text fill="#ecf0f1" font-size="24" text-anchor="middle" x="300" y="350">继续加油!</text>
                    </svg>
                </div>
            </div>
        </div>

    </div>
    <div class="subtitle-area" id="subtitleArea">欢迎学习分部积分法!</div>
    <div class="control-bar">
        <div style="color:#f1c40f;font-weight:bold;margin-bottom:15px;text-align:center;">第 <span id="currentSlide">1</span> / <span id="totalSlides">25</span> 页</div>
        <button class="btn" id="prevBtn" onclick="previousSlide()">⬅️ 上一页</button>
        <button class="btn primary" id="startBtn" onclick="startTeaching()">🎀 开始讲课</button>
        <button class="btn" id="nextBtn" onclick="nextSlide()">下一页 ➡️</button>
        <button class="btn" onclick="restart()">🔄 重新开始</button>
        <button class="btn" id="autoPlayBtn" onclick="startAutoPlay()">🎬 自动播放</button>
        <!-- 公式渲染修复按钮 -->
        <button class="btn" onclick="forceRerenderMath()" style="background: rgba(231,76,60,0.3); border-color: #e74c3c;">🔧 重新渲染公式</button>
    </div>
    <script type="module">
        // 加载讯飞虚拟人SDK并广播就绪事件
        window.playbackFinished = false;
        try {
            const { default: AvatarPlatform } = await import('./avatar-sdk-web_3.1.2.1002/index.js');
            window.AvatarPlatform = AvatarPlatform;
            console.log('✅ 讯飞SDK模块已加载');
        } catch (error) {
            console.error('❌ SDK加载失败:', error);
        }
        window.dispatchEvent(new CustomEvent('sdkReady'));
    </script>
    <script>
        const subtitleScript = {
            "1": "欢迎学习不定积分的另一大支柱:分部积分法。",
            "2": "换元法善于处理复合函数,但对于函数乘积形式,它往往无能为力。",
            "3": "当遇到两个独立函数相乘的积分时,比如x乘以cosx,我们需要新的方法。",
            "4": "分部积分法的公式,来源于我们熟悉的乘积求导法则。",
            "5": "将乘积求导公式两边同时积分,是推导的第一步。",
            "6": "移项整理后,我们就得到了分部积分公式的标准形式。",
            "7": "这就是分部积分公式:∫udv = uv - ∫vdu,简洁而优美。",
            "8": "核心思想是将难积分转化为易积分,关键在于选择u和dv。",
            "9": "选择u和dv有两个基本原则:优先级口诀和易积分性。",
            "10": "选择u的优先级口诀是反对幂三指,从高到低排列。",
            "11": "例1:我们来积分x乘以e的x次方,这是幂函数和指数函数的乘积。",
            "12": "根据口诀,幂函数x优先于指数函数e的x次方,所以选x为u。",
            "13": "通过微分和积分,我们由u得到du,由dv得到v。",
            "14": "将u、v、du、dv代入分部积分公式中。",
            "15": "求解转化后的简单积分,并加上常数C,得到最终答案。",
            "16": "例2:对于∫lnx dx,这个积分看起来只有一个函数。",
            "17": "巧妙的技巧是把它看作∫lnx·1dx,变成两个函数的乘积。",
            "18": "根据口诀,对数函数优先级高于幂函数,所以选lnx为u。",
            "19": "套用公式并化简,得到最终答案xlnx - x + C。",
            "20": "有时,一次分部积分后,新积分仍需再次使用分部积分法。",
            "21": "例3的第一次分部积分后,得到的新积分仍是乘积形式。",
            "22": "对新积分再次使用分部积分法,问题就可以解决了。",
            "23": "分部积分法的核心公式实现了积分的转化。",
            "24": "掌握五步解题流程:识别、选择、计算、转化、求解。",
            "25": "分部积分法是积分的基石,务必熟练掌握。感谢学习!"
        };
        const speechScript = {
            "1": "同学们好!继换元法之后,今天我们来学习不定积分的另一大支柱性技巧——分部积分法。",
            "2": "我们知道,换元法善于处理复合函数的积分。",
            "3": "但如果被积函数是两个独立的函数相乘,比如x乘以cosx,换元法就很难奏效了。这时,我们就需要一个专门为\"乘积\"形式量身打造的积分方法。",
            "4": "这个方法的思路从何而来呢?和换元法一样,它也源自求导法则的逆运算。这一次,它的理论基础是\"乘积求导法则\"。",
            "5": "我们把乘积求导公式两边同时积分,这是推导的第一步。",
            "6": "再做一个简单的移项,就能得到分部积分公式的标准形式。",
            "7": "这就是我们今天的主角——分部积分公式。它的标准形式是:∫udv等于uv减去∫vdu。",
            "8": "这个公式的精髓在于,它实现了一种\"转化\",把一个可能很难的积分,转化成了求另一个积分。如果我们的转化是明智的,那么这个新积分就会比原来的简单。",
            "9": "那么,成功的关键就在于,如何明智地选择谁是u,谁是dv呢?这里有两个基本原则。",
            "10": "第一个原则是一个非常著名的口诀,叫做反对幂三指。它按照函数类型,给出了选择u的优先级顺序:反三角函数最高,然后依次是对数、幂函数、三角函数和指数函数。排在前面的,就优先选为u。",
            "11": "我们来看第一个例子,求x乘以e的x次方的积分。被积函数由幂函数x和指数函数e的x次方相乘。",
            "12": "根据反对幂三指的口诀,幂在指的前面,所以幂函数x的优先级更高,我们选择它作为u,剩下的e的x次方dx就自然是dv。",
            "13": "选好了u和dv,我们就进入第二步:计算。对u等于x两边微分,得到du等于dx。对dv等于e的x次方dx两边积分,得到v等于e的x次方。",
            "14": "现在,我们把u、v、du、dv这四个零件,全部代入分部积分公式中。",
            "15": "代入公式后,我们得到了x乘以e的x次方,再减去e的x次方的积分。这个新积分非常简单,它的结果就是e的x次方。所以,最终答案就是x乘以e的x次方,再减去e的x次方,最后别忘了加上一个常数C。",
            "16": "再来看一个非常经典,但又有点迷惑性的例子:求lnx的积分。它看起来只有一个函数,怎么分部呢?",
            "17": "这里的技巧是,把它看作lnx乘以1。现在它变成了两个函数的乘积!",
            "18": "根据口诀,\"对数\"的优先级远高于\"幂函数\"1,所以我们令u等于lnx,dv等于dx。",
            "19": "然后按照标准流程计算,套用公式并化简,最终得到xlnx减去x加C。",
            "20": "有时候,问题会更复杂一些。比如求x平方乘以sinx的积分。",
            "21": "当我们使用一次分部积分后,会发现得到的新积分,仍然是一个需要分部积分的乘积形式。",
            "22": "这时候,不要慌张,我们只需要对这个新积分,再次使用一次分部积分法,问题就可以解决了。",
            "23": "好了,我们来总结一下分部积分法。首先,牢记它的核心公式,这个公式实现了积分的转化。",
            "24": "其次,也是最重要的,是掌握五步解题流程和\"反对幂三指\"的口诀来正确选择u和dv。我们的目标始终是,通过分部积分,让被积函数变得越来越简单。",
            "25": "分部积分法是与换元法并列的两大积分基石,务必熟练掌握。多加练习,熟能生巧!谢谢大家!"
        };
        const actionMap = {
            "1": "A_RLH_welcome_O", "2": "A_RH_point_O", "3": "A_LH_introduced_O", "4": "A_RH_point_O",
            "5": "A_LH_introduced_O", "6": "A_RH_point_O", "7": "A_LH_introduced_O", "8": "A_RH_point_O",
            "9": "A_LH_introduced_O", "10": "A_RH_point_O", "11": "A_LH_introduced_O", "12": "A_RH_point_O",
            "13": "A_LH_introduced_O", "14": "A_RH_point_O", "15": "A_LH_introduced_O", "16": "A_RH_point_O",
            "17": "A_LH_introduced_O", "18": "A_RH_point_O", "19": "A_LH_introduced_O", "20": "A_RH_point_O",
            "21": "A_LH_introduced_O", "22": "A_RH_point_O", "23": "A_LH_introduced_O", "24": "A_RH_point_O",
            "25": "A_RLH_welcome_O"
        };

        let currentSlide = 0;
        const totalSlides = 25;
        let avatarPlatform = null;
        let isConnected = false;
        let isTeaching = false;
        let isAutoPlaying = false;
        let isSpeaking = false;
        let speechFinishedResolve = null;
        const slides = document.querySelectorAll('.slide');

        /**
         * 渲染 MathJax 公式
         * @param {Array|null} elements - 要渲染的元素数组，null 表示渲染整个页面
         * @returns {Promise<boolean>} - 渲染是否成功
         *
         * 修复说明：
         * 1. 确保幻灯片切换后公式正确渲染
         * 2. 兼容 HTML 中的单反斜杠和 JavaScript 字符串中的双反斜杠
         * 3. 添加错误检测和处理机制
         */
        function renderMath(elements = null) {
            return new Promise((resolve) => {
                if (!window.MathJax || !window.MathJax.typesetPromise) {
                    console.warn('⚠️ MathJax 未加载');
                    resolve(false);
                    return;
                }

                const target = elements || [document.body];

                window.MathJax.typesetPromise(target)
                    .then(() => {
                        // 检测渲染错误
                        const errors = document.querySelectorAll('.MathJax_Error, [data-mjx-error], .mjx-merror');
                        if (errors.length > 0) {
                            console.error('❌ MathJax 渲染错误:', errors.length, '个公式');
                            errors.forEach((err, idx) => {
                                console.error(`  错误 ${idx + 1}:`, err.textContent || err.getAttribute('data-mjx-error'));
                            });
                            resolve(false);
                        } else {
                            console.log('✅ MathJax 渲染成功');
                            resolve(true);
                        }
                    })
                    .catch(err => {
                        console.error('❌ MathJax 渲染失败:', err);
                        resolve(false);
                    });
            });
        }

        /**
         * 强制重新渲染所有公式（用户手动触发）
         * 修复说明：提供手动修复选项，当自动渲染失败时可使用
         */
        function forceRerenderMath() {
            console.log('🔄 强制重新渲染所有公式...');
            if (window.MathJax && window.MathJax.typesetClear) {
                window.MathJax.typesetClear();
            }
            renderMath().then(success => {
                if (success) {
                    alert('✅ 公式重新渲染成功！');
                } else {
                    alert('❌ 公式渲染失败，请检查控制台错误信息。');
                }
            });
        }

        // 将函数暴露到全局作用域，便于调试和手动调用
        window.forceRerenderMath = forceRerenderMath;

        /**
         * 显示指定幻灯片
         * 修复说明：
         * 1. 先切换幻灯片可见性
         * 2. 仅渲染当前活动幻灯片的公式（性能优化）
         * 3. 使用 Promise 确保公式渲染完成后再执行其他操作
         */
        function showSlide(index) {
            slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            currentSlide = index;
            const cs = document.getElementById('currentSlide'); if (cs) cs.textContent = index + 1;

            // 获取当前活动幻灯片
            const activeSlide = slides[index];

            // 渲染当前幻灯片的公式
            renderMath([activeSlide]).then((success) => {
                if (!success) {
                    console.warn('⚠️ 第', index + 1, '页公式渲染可能存在问题');
                }
            });

            const prevBtnEl = document.getElementById('prevBtn'); if (prevBtnEl) prevBtnEl.disabled = index === 0;
            const nextBtnEl = document.getElementById('nextBtn'); if (nextBtnEl) nextBtnEl.disabled = index === totalSlides - 1;
            updateSubtitle(index + 1);
        }

        function nextSlide() { 
            if (currentSlide < totalSlides - 1) { 
                showSlide(currentSlide + 1); 
                if (!isAutoPlaying) speakContent(currentSlide + 1); 
            } 
        }
        function previousSlide() { if (currentSlide > 0) { showSlide(currentSlide - 1); if (!isAutoPlaying) speakContent(currentSlide + 1); } }
        function restart() { showSlide(0); if (avatarPlatform) { avatarPlatform.stop(); } isConnected = false; isTeaching = false; isAutoPlaying = false; document.getElementById('autoPlayBtn').disabled = false; }
function updateSubtitle(slideNum) { const subtitleArea = document.getElementById('subtitleArea'); subtitleArea.textContent = subtitleScript[slideNum] || ''; }

// 数学公式音译为中文，便于虚拟人口播与字数统计
function translateMathToSpeech(text){
    if(!text) return '';
    let r=text;
    const rep=(pat,to)=>{ r=r.replace(new RegExp(pat,'g'),to); };
    rep("f''\\(x\\)",'f两撇x');
    rep("f'\\(x\\)",'f撇x');
    rep("x_0",'x零'); rep("x_1",'x一'); rep("x_2",'x二'); rep("x_3",'x三'); rep("x_n",'x n');
    rep("\\\\lim",'极限'); rep("\\\\to",'趋向于'); rep("->",'趋向于'); rep("\\\\infty",'无穷大');
    rep("\\\\int",'积分'); rep("\\\\sum",'求和');
    r=r.replace(new RegExp("\\\\frac\\s*{([^}]*)}\\s*{([^}]*)}",'g'),function(_,a,b){return a+'分之'+b;});
    rep("\\\\alpha",'阿尔法'); rep("\\\\beta",'贝塔'); rep("\\\\theta",'西塔'); rep("\\\\Delta",'德尔塔');
    rep("≥",'大于等于'); rep("≤",'小于等于'); rep(">",'大于'); rep("<",'小于'); rep("=",'等于');
    rep("\\\\cdot|\\\\times",'乘以');
    r=r.replace(new RegExp("\\$",'g'),'').replace(new RegExp("\\\\",'g'),'').replace(new RegExp("[{}]",'g'),'');
    return r;
}

        async function speakContent(slideNum) {
            if (!isTeaching || !isConnected || !avatarPlatform) { console.log('⚠️ 虚拟人未连接或未开始讲课'); return; }
            const raw = speechScript[slideNum] || subtitleScript[slideNum];
            if (!raw) return;
            const content = translateMathToSpeech(raw);
            try {
                const action = actionMap[slideNum];
                if (action) { await avatarPlatform.writeCmd("action", action); }
                await avatarPlatform.writeText(content, { nlp: false });
                updateSubtitle(slideNum);
            } catch (error) { console.error('❌ 讲解失败:', error); }
        }

        function getSlideDuration(slideNum) { const speech = speechScript[slideNum] || subtitleScript[slideNum]; if (!speech) return 5000; const t = translateMathToSpeech(speech); const n = t.length; const d = n * 200; console.log(`第${slideNum}页: ${n}字 → ${d}ms`); return d; }
        function updateStatus(message, type = 'normal') { const indicator = document.getElementById('statusIndicator'); if (indicator) { indicator.textContent = message; indicator.className = 'status-indicator'; if (type === 'connected') indicator.classList.add('connected'); else if (type === 'error') indicator.classList.add('error'); else if (type === 'connecting') indicator.classList.add('connecting'); } }

        function waitForSDK() {
            return new Promise((resolve, reject) => {
                if (window.AvatarPlatform) { resolve(); return; }
                const timeout = setTimeout(() => { reject(new Error('SDK加载超时')); }, 10000);
                window.addEventListener('sdkReady', function handler() { clearTimeout(timeout); window.removeEventListener('sdkReady', handler); resolve(); });
            });
        }

        async function startTeaching() {
            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = '🔄 启动中...';
            startBtn.disabled = true;
            try {
                updateStatus('等待SDK...', 'connecting');
                await waitForSDK();
                if(typeof window.AvatarPlatform === 'undefined') {
                    console.warn("虚拟人SDK (AvatarPlatform) 未找到, 将无法播放语音和动作。");
                    updateStatus('SDK未加载', 'error');
                    startBtn.textContent = '❌ SDK未加载';
                    return;
                }

                if(avatarPlatform) { avatarPlatform.destroy(); }
                avatarPlatform = new window.AvatarPlatform({ useInlinePlayer: true });

                avatarPlatform.on('connected', () => {
                    isConnected = true; isTeaching = true; updateStatus('已连接', 'connected');
                    startBtn.textContent = '💖 虚拟人已就绪';
                    setTimeout(() => speakContent(currentSlide + 1), 1000);
                }).on('disconnected', () => {
                    isConnected = false; updateStatus('连接断开', 'error');
                }).on('error', (error) => {
                    console.error('❌ 错误:', error); updateStatus('错误', 'error');
                    startBtn.textContent = '❌ 连接失败'; startBtn.disabled = false; isTeaching = false;
                }).on('frame_stop', () => {
                    if (isAutoPlaying && speechFinishedResolve) { speechFinishedResolve(); speechFinishedResolve = null; }
                });
                
                avatarPlatform.setApiInfo({
                    appId: 'e8c180ed',
                    apiKey: 'e0c44f0e2ef0f47582ffa7e864da0d9b',
                    apiSecret: 'MDZkNDNiZWU4NDkzNWM5MDQzMTY4N2Nh',
                    sceneId: '237415046114840576',
                    serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact'
                });
                avatarPlatform.setGlobalParams({
                    stream: {
                        protocol: 'xrtc',
                        alpha: 1,
                        bitrate: 1000000,
                        fps: 25
                    },
                    avatar: {
                        avatar_id: '110332017',
                        width: 1920,
                        height: 1080,
                        scale: 1,
                        move_h: 0,
                        move_v: 0,
                        audio_format: 1
                    },
                    tts: {
                        vcn: 'x4_yiting',
                        speed: 50,
                        pitch: 50,
                        volume: 100
                    },
                    avatar_dispatch: {
                        interactive_mode: 1,
                        content_analysis: 0
                    }
                });
                await avatarPlatform.start({ wrapper: document.getElementById('avatarWrapper') });
            } catch (error) {
                console.error('❌ 启动失败:', error); updateStatus('启动失败', 'error');
                startBtn.textContent = '🎀 开始讲课'; startBtn.disabled = false;
            }
        }

        async function startAutoPlay() {
            if (!isTeaching || !isConnected) {
                await startTeaching();
                await new Promise(r => setTimeout(r, 2000));
                if (!isConnected) { alert("虚拟人未连接，无法自动播放。"); return; }
            }
            isAutoPlaying = true;
            document.getElementById('autoPlayBtn').disabled = true;
            try {
                for (let i = currentSlide; i < totalSlides; i++) {
                    if (!isAutoPlaying) break;
                    showSlide(i);
                    const speechPromise = new Promise(resolve => { speechFinishedResolve = resolve; });
                    await speakContent(i + 1);
                    const timeoutPromise = new Promise(resolve => setTimeout(resolve, getSlideDuration(i + 1) + 2000));
                    await Promise.race([speechPromise, timeoutPromise]);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            } catch (error) { console.error('❌ 自动播放失败:', error); }
            finally {
                isAutoPlaying = false; document.getElementById('autoPlayBtn').disabled = false;
                window.playbackFinished = true; document.title = "PLAYBACK_FINISHED"; console.log('🎉 播放完成');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
            else if (e.key === 'ArrowLeft') { e.preventDefault(); previousSlide(); }
        });

        (function(){ const ts = document.getElementById('totalSlides'); if (ts) ts.textContent = totalSlides; })();
        showSlide(0);
    </script>
</body>
</html>
